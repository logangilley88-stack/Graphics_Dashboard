<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="author" content="Logan Gilley - Central Sports Network, LLC.">
<title>Graphics Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
  }

  /* Fullscreen Menu System */
  .fullscreen-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    display: none;
    justify-content: center;
    align-items: flex-start;
    z-index: 3000;
    overflow-y: auto;
    padding: 40px 20px;
    box-sizing: border-box;
  }
  
  .fullscreen-menu.open {
    display: flex;
  }
  
  .fullscreen-menu-content {
    background: #222;
    border-radius: 12px;
    padding: 40px;
    max-width: 800px;
    width: 100%;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
    position: relative;
  }
  
  .fullscreen-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #555;
  }
  
  .fullscreen-menu-close {
    background: #d32f2f;
    border: none;
    color: white;
    font-size: 24px;
    width: 40px;
    height: 40px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }
  
  .fullscreen-menu-close:hover {
    background: #b71c1c;
  }
  .fullscreen-menu h1 {
    margin-top: 0;
    font-size: 32px;
    margin-bottom: 0;
    color: #fff;
    font-weight: bold;
  }
  .section {
    margin-bottom: 25px;
  }
  .section h2 {
    margin-top: 0;
    font-size: 20px;
    margin-bottom: 12px;
    border-bottom: 1px solid #444;
    padding-bottom: 5px;
  }
  label {
    display: block;
    margin-bottom: 10px;
    font-weight: normal;
  }
  input[type="text"],
  textarea {
    width: 100%;
    padding: 6px 8px;
    font-size: 16px;
    border-radius: 4px;
    border: none;
    box-sizing: border-box;
    background: #333;
    color: #eee;
    font-family: inherit;
    resize: vertical;
  }
  input[type="color"] {
    width: 60px;
    height: 30px;
    border: none;
    cursor: pointer;
    vertical-align: middle;
    margin-left: 10px;
    background: none;
  }
  input[type="file"] {
    color: #eee;
    background: #333;
    border-radius: 4px;
    padding: 4px 6px;
    cursor: pointer;
  }

  /* Hotkey specific styles */
  .hotkey-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 8px;
  }

  .hotkey-item label {
    min-width: 120px;
    margin-bottom: 0;
    font-size: 14px;
  }

  .hotkey-input {
    flex: 1;
    padding: 4px 8px;
    font-size: 12px;
    background: #444;
    border: 1px solid #555;
    color: #eee;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    width: 25px !important;
  }

  .hotkey-input:focus {
    background: #555;
    border-color: #c41e3a;
    outline: none;
  }

  .hotkey-input.recording {
    background: #c41e3a;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }

  .clear-hotkey {
    background: #666;
    border: none;
    color: white;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    min-width: 50px;
  }

  .clear-hotkey:hover {
    background: #777;
  }
  img.logo-preview {
    max-width: 100%;
    margin-top: 8px;
    display: none;
    border-radius: 6px;
    max-height: 80px;
    object-fit: contain;
  }

  /* Fullscreen Menu Grid Layout */
  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-top: 20px;
  }
  
  .menu-column {
    background: #333;
    border-radius: 8px;
    padding: 25px;
    border: 1px solid #555;
  }
  
  .menu-column h2 {
    color: #fff;
    font-size: 20px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #555;
  }

  .status-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: #1a1a1a;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 20px;
    box-sizing: border-box;
    z-index: 95;
    gap: 20px;
  }

  .status-bar-dropdown {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
  }

  .status-dropdown-toggle {
    color: #eee;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    display: flex;
    align-items: center;
  }

  .status-dropdown-toggle:hover {
    background: #444;
    border-color: #666;
    color: #fff;
  }

  .status-dropdown-toggle:after {
    content: ' ▼';
    font-size: 10px;
    transition: transform 0.2s ease;
  }

  .status-dropdown-toggle.open:after {
    transform: rotate(180deg);
  }

  .status-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: #333;
    min-width: 140px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    border-radius: 4px;
    z-index: 1000;
    display: none;
    margin-top: 4px;
    border: 1px solid #555;
  }

  .status-dropdown-menu.show {
    display: block;
  }

  .status-dropdown-item {
    display: block;
    width: 100%;
    padding: 10px 14px;
    background: none;
    border: none;
    color: #eee;
    text-align: left;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s ease;
    border-radius: 0;
    font-weight: 500;
  }

  .status-dropdown-item:hover {
    background: #444;
  }

  .status-dropdown-item:first-child {
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
  }

  .status-dropdown-item:last-child {
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
  }

  .status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .status-circle {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #666;
    transition: background-color 0.3s ease;
    cursor: pointer;
    flex-shrink: 0;
  }

  .status-circle.active {
    background: #00ff00;
    box-shadow: 0 0 8px rgba(0, 255, 0, 0.6);
  }

  .status-circle.inactive {
    background: #ff0000;
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
  }

  .status-label {
    font-size: 11px;
    color: #ccc;
    font-weight: 500;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .status-edit-btn {
    background: #333;
    border: 1px solid #555;
    color: #ccc;
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    text-transform: uppercase;
    min-width: 28px;
  }

  .status-edit-btn:hover:not(:disabled) {
    background: #444;
    border-color: #666;
    color: #fff;
  }

  .status-edit-btn:disabled {
    background: #222;
    border-color: #333;
    color: #666;
    cursor: not-allowed;
    opacity: 0.5;
  }

  /* Dropdown menu styles */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-toggle {
    background: #444;
    border: none;
    color: white;
    font-size: 18px;
    padding: 2px 8px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    font-weight: bold;
  }

  .dropdown-toggle:hover {
    background: #666;
  }

  .dropdown-toggle:after {
    font-size: 12px;
    margin-left: 10px;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: #333;
    min-width: 160px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.8);
    border-radius: 4px;
    z-index: 1000;
    display: none;
    margin-top: 4px;
  }

  .dropdown-menu.show {
    display: block;
  }

  .dropdown-item {
    display: block;
    width: 100%;
    padding: 12px 16px;
    background: none;
    border: none;
    color: white;
    text-align: left;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.2s ease;
    border-radius: 0;
  }

  .dropdown-item:hover {
    background: #555;
  }

  .dropdown-item:first-child {
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
  }

  .dropdown-item:last-child {
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
  }

  #newGameBtn {
    background: #d32f2f;
    font-weight: bold;
  }

  #newGameBtn:hover {
    background: #b71c1c;
  }

  /* Sport Selection Overlay */
  .sport-selection-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
  }

  .sport-selection-overlay.hidden {
    display: none;
  }

  .sport-selection-modal {
    background: #333;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
    max-width: 500px;
    width: 90%;
  }

  .sport-selection-modal h2 {
    margin: 0 0 30px 0;
    color: #fff;
    font-size: 32px;
    font-weight: bold;
  }

  .sport-selection-modal p {
    margin: 0 0 30px 0;
    color: #ccc;
    font-size: 18px;
    line-height: 1.4;
  }

  .sport-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
  }

  .sport-option-btn {
    padding: 20px;
    border: 2px solid #555;
    border-radius: 8px;
    background: #444;
    color: white;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .sport-option-btn:hover {
    background: #555;
    border-color: #777;
    transform: translateY(-2px);
  }

  .sport-option-btn.selected {
    background: #c41e3a;
    border-color: #c41e3a;
  }

  .current-sport-display {
    position: absolute;
    top: 5px;
    right: 2px;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: bold;
    z-index: 100;
    font-family:'Times New Roman', Times, serif;
  }

  /* Custom Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal {
    background: #333;
    border-radius: 8px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
    text-align: center;
  }

  .modal h3 {
    margin: 0 0 20px 0;
    color: #fff;
    font-size: 24px;
    font-weight: bold;
  }

  .modal p {
    margin: 0 0 25px 0;
    color: #ccc;
    font-size: 16px;
    line-height: 1.4;
  }

  .modal-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
  }

  .modal-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s ease;
    min-width: 100px;
  }

  .modal-btn.confirm {
    background: #d32f2f;
    color: white;
  }

  .modal-btn.confirm:hover {
    background: #b71c1c;
  }

  .modal-btn.cancel {
    background: #666;
    color: white;
  }

  .modal-btn.cancel:hover {
    background: #777;
  }

  /* Edit Modal Styles */
  .edit-modal {
    background: #333;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .edit-modal-header {
    background: #444;
    padding: 20px 30px;
    border-bottom: 2px solid #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .edit-modal-header h3 {
    margin: 0;
    color: #fff;
    font-size: 20px;
    font-weight: bold;
  }

  .modal-close-btn {
    background: #d32f2f;
    border: none;
    color: white;
    font-size: 20px;
    width: 30px;
    height: 30px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }

  .modal-close-btn:hover {
    background: #b71c1c;
  }

  .edit-modal-content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
    background: #333;
  }

  .edit-input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
    gap: 8px;
  }

  .edit-input-group:last-child {
    margin-bottom: 0;
  }

  .edit-input-group label {
    color: #eee;
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 0;
  }

  .edit-input-group input[type="text"],
  .edit-input-group textarea {
    width: 100%;
    padding: 10px 12px;
    font-size: 14px;
    border-radius: 4px;
    border: none;
    background: #444;
    color: #eee;
    font-family: inherit;
    box-sizing: border-box;
  }

  .edit-input-group input[type="text"]:focus,
  .edit-input-group textarea:focus {
    outline: 2px solid #c41e3a;
    background: #555;
  }

  .edit-input-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .edit-team-toggle-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .edit-team-toggle-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 12px;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    flex: 1;
    min-width: 70px;
  }

  .edit-team-toggle-btn:hover:not(.active) {
    background: #555;
  }

  .edit-team-toggle-btn.active {
    background: #c41e3a;
  }

  .edit-section-item {
    border: 1px solid #555;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
    background: #2a2a2a;
    position: relative;
  }

  .edit-section-remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #d32f2f;
    color: white;
    border: none;
    border-radius: 3px;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .edit-section-remove-btn:hover {
    background: #b71c1c;
  }

  .edit-add-section-btn {
    background: #c41e3a;
    border: none;
    color: white;
    font-size: 14px;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s ease;
    margin-top: 10px;
  }

  .edit-add-section-btn:hover {
    background: #b71c1c;
  }

  button {
    background: none;
    border: none;
    color: white;
    font-size: 22px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
  }
  button:hover {
    background: #666;
  }
  input[type="text"] {
    font-size: 20px;
    padding: 4px 8px;
    border-radius: 4px;
    background: none;
    color: white;
    border: 1px solid #777;
    text-align: left;
    width: 330px;
  }

  /* Timeout buttons styling */
  .control-group button#homeTimeoutBtn,
  .control-group button#awayTimeoutBtn {
    font-size: 18px;
    padding: 8px 16px;
    background: #444;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 80px;
  }
  .control-group button#homeTimeoutBtn:hover:not(:disabled),
  .control-group button#awayTimeoutBtn:hover:not(:disabled) {
    background: #666;
  }
  .control-group button:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }

  /* Main content for scoreboard bar */
  .main-content {
    flex: 1;
    margin-top: 20px;
    position: relative;
    background: #111;
    padding-left: 0;
    transition: padding-left 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  /* Scorebar controls */
  .scorebar-controls {
    position: absolute;
    top: 10px;
    left: 35px;
    width: 250px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    padding: 8px 20px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(5px);
    display: none;
  }

  .scorebar-label {
    font-size: 15px;
    font-weight: bold;
    color: #eee;
  }
  .scorebar-buttons {
    display: flex;
    gap: 8px;
  }
  .scorebar-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 12px;
    padding: 1px 11px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 35px;
  }
  .scorebar-btn:hover:not(:disabled) {
    background: #eee;
  }
  .scorebar-btn.active {
    background: #c41e3a;
  }
  .scorebar-btn:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }

  /* Mini Bug controls */
  .mini-bug-controls {
    position: absolute;
    top: 50px;
    left: 35px;
    width: 250px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    padding: 8px 20px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(5px);
    display: none;
  }

  /* Lower Third controls */
  .lower-third-controls {
    position: absolute;
    top: 130px;
    left: 35px;
    width: 250px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    padding: 8px 20px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(5px);
    display: none;
  }

  .lower-third-label {
    font-size: 15px;
    font-weight: bold;
    color: #eee;
  }
  .lower-third-buttons {
    display: flex;
    gap: 8px;
  }
  .lower-third-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 12px;
    padding: 1px 11px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 35px;
  }
  .lower-third-btn:hover:not(:disabled) {
    background: #666;
  }
  .lower-third-btn.active {
    background: #c41e3a;
  }
  .lower-third-btn:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }

  /* Lower Third Expanded Section */
  .lower-third-expanded {
    position: absolute;
    top: 200px;
    left: 490px;
    width: 300px;
    background: rgba(34, 34, 34, 0.95);
    padding: 20px;
    box-sizing: border-box;
    z-index: 49;
    backdrop-filter: blur(5px);
    max-width: 0;
    overflow: hidden;
    transition: max-width 0.3s ease, padding 0.3s ease;
  }

  .lower-third-expanded.open {
    max-width: 300px;
    padding: 20px;
  }

  .lower-third-expanded:not(.open) {
    padding: 20px 0;
  }

  .lower-third-input-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    gap: 10px;
  }

  .lower-third-input-group:last-child {
    margin-bottom: 0;
  }

  .lower-third-input-group label {
    color: #eee;
    font-weight: bold;
    min-width: 60px;
    font-size: 16px;
  }

  .lower-third-input-group input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 4px;
    border: none;
    background: #333;
    color: #eee;
    font-family: inherit;
  }

  .lower-third-input-group input[type="text"]:focus {
    outline: 2px solid #666;
    background: #444;
  }

  .team-toggle-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 14px;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    flex: 1;
  }

  .team-toggle-btn:hover:not(.active) {
    background: #555;
  }

  .team-toggle-btn.active {
    background: #c41e3a;
  }

  /* Ticker controls - will be reused for Tombstone */
  .ticker-controls {
    position: absolute;
    top: 170px !important;
    left: 35px;
    width: 250px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    padding: 8px 20px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(5px);
    display: none;
  }

  .ticker-label {
    font-size: 15px;
    font-weight: bold;
    color: #eee;
  }
  .ticker-buttons {
    display: flex;
    gap: 8px;
  }
  .ticker-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 11px;
    padding: 1px 11px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 35px;
  }
  .ticker-btn:hover:not(:disabled) {
    background: #666;
  }
  .ticker-btn.active {
    background: #c41e3a;
  }
  .ticker-btn:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }

  /* Talent controls */
  .talent-controls {
    position: absolute;
    top: 210px;
    left: 35px;
    width: 250px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    padding: 8px 20px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(5px);
    display: none;
  }

  /* Left Slab controls */
  .left-slab-controls {
    position: absolute;
    top: 250px;
    left: 35px;
    width: 250px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    padding: 8px 20px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(5px);
    display: none;
  }

  .talent-label {
    font-size: 15px;
    font-weight: bold;
    color: #eee;
  }
  .talent-buttons {
    display: flex;
    gap: 8px;
  }
  .talent-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 12px;
    padding: 1px 11px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 35px;
  }
  .talent-btn:hover:not(:disabled) {
    background: #666;
  }
  .talent-btn.active {
    background: #c41e3a;
  }
  .talent-btn:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }

  .left-slab-label {
    font-size: 15px;
    font-weight: bold;
    color: #eee;
  }
  .left-slab-buttons {
    display: flex;
    gap: 10px;
  }
  .left-slab-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 12px;
    padding: 1px 11px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 35px;
  }
  .left-slab-btn:hover:not(:disabled) {
    background: #666;
  }
  .left-slab-btn.active {
    background: #c41e3a;
  }
  .left-slab-btn:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }

  /* Talent Expanded Section */
  .talent-expanded {
    position: absolute;
    top: 320px;
    left: 490px;
    width: 300px;
    background: rgba(34, 34, 34, 0.95);
    padding: 20px;
    box-sizing: border-box;
    z-index: 49;
    backdrop-filter: blur(5px);
    max-width: 0;
    overflow: hidden;
    transition: max-width 0.3s ease, padding 0.3s ease;
  }

  .talent-expanded.open {
    max-width: 300px;
    padding: 20px;
  }

  .talent-expanded:not(.open) {
    padding: 20px 0;
  }

  .talent-input-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    gap: 10px;
  }

  .talent-input-group:last-child {
    margin-bottom: 0;
  }

  .talent-input-group label {
    color: #eee;
    font-weight: bold;
    min-width: 60px;
    font-size: 16px;
  }

  .talent-input-group input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 4px;
    border: none;
    background: #333;
    color: #eee;
    font-family: inherit;
  }

  .talent-input-group input[type="text"]:focus {
    outline: 2px solid #666;
    background: #444;
  }

  /* Left Slab Expanded Section */
  .left-slab-expanded {
    position: absolute;
    top: 380px;
    left: 490px;
    width: 300px;
    background: rgba(34, 34, 34, 0.95);
    padding: 20px;
    box-sizing: border-box;
    z-index: 49;
    backdrop-filter: blur(5px);
    max-width: 0;
    max-height: calc(100vh - 400px);
    overflow: hidden;
    transition: max-width 0.3s ease, padding 0.3s ease;
  }

  .left-slab-expanded.open {
    max-width: 300px;
    padding: 20px;
    overflow-y: auto;
  }

  .left-slab-expanded:not(.open) {
    padding: 20px 0;
    overflow-y: hidden;
  }

  .left-slab-input-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    gap: 10px;
  }

  .left-slab-input-group:last-child {
    margin-bottom: 0;
  }

  .left-slab-input-group label {
    color: #eee;
    font-weight: bold;
    min-width: 60px;
    font-size: 16px;
  }

  .left-slab-input-group input[type="text"] {
    flex: 1;
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 4px;
    border: none;
    background: #333;
    color: #eee;
    font-family: inherit;
  }

  .left-slab-input-group input[type="text"]:focus {
    outline: 2px solid #666;
    background: #444;
  }

  /* Locator controls */
  .stats-panel-controls {
    position: absolute;
    top: 90px;
    left: 35px;
    width: 250px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    padding: 8px 20px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(5px);
    display: none;
  }

  .stats-panel-label {
    font-size: 15px;
    font-weight: bold;
    color: #eee;
  }
  .stats-panel-buttons {
    display: flex;
    gap: 8px;
  }
  .stats-panel-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 12px;
    padding: 1px 11px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 35px;
  }
  .stats-panel-btn:hover:not(:disabled) {
    background: #666;
  }
  .stats-panel-btn.active {
    background: #c41e3a;
  }
  .stats-panel-btn:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }

  .mini-bug-label {
    font-size: 15px;
    font-weight: bold;
    color: #eee;
  }
  .mini-bug-buttons {
    display: flex;
    gap: 8px;
  }
  .mini-bug-btn {
    background: #444;
    border: none;
    color: white;
    font-size: 12px;
    padding: 1px 11px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 35px;
  }
  .mini-bug-btn:hover:not(:disabled) {
    background: #666;
  }
  .mini-bug-btn.active {
    background: #c41e3a;
  }
  .mini-bug-btn:disabled {
    background: #222;
    cursor: default;
    opacity: 0.5;
  }
  /* Remove sidebar-open class as we no longer use sidebars */

  /* Scorebug controls */
  .scorebug-controls {
    position: relative;
    top: 50px;
    width: 800px;
    background: rgba(34, 34, 34, 0.95);
    padding: 30px;
    box-sizing: border-box;
    z-index: 50;
    backdrop-filter: blur(5px);
    border-radius: 8px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(2, 1fr);
    gap: 30px;
    margin: 0 auto;
  }

  /* Football controls */
  .football-controls {
    position: relative;
    top: 75px;
    width: 450px;
    background: none;
    padding: 25px;
    box-sizing: border-box;
    z-index: 50;
    backdrop-filter: blur(5px);
    border-radius: 8px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
    border: 2px solid rgba(196, 30, 58, 0.95);
    margin: 0 auto;
  }

  .scorebug-control-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 160px;
  }

  .scorebug-control-group label {
    margin-bottom: 12px;
    font-weight: bold;
    color: #eee;
    font-size: 18px;
  }

  .main-content .scorebug-controls input[type="text"] {
      background: none;
      border: 1px solid white;
      border-radius: 4px;
  }

  .scorebug-btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    justify-content: center;
    min-width: 140px;
    margin: 0 auto;
  }

  .scorebug-control-group button {
    background: #444;
    border: none;
    color: white;
    font-size: 18px;
    padding: 10px 8px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    min-width: 65px;
    height: 46px;
  }

  .scorebug-control-group button:hover {
    background: #666;
  }

  .scorebug-control-group input[type="text"] {
    font-size: 20px;
    padding: 8px 12px;
    border-radius: 4px;
    border: none;
    background: #333;
    color: white;
    text-align: center;
    width: 80px;
    margin-bottom: 12px;
    height: 46px;
    box-sizing: border-box;
  }

  .timeout-count-input {
    width: 40px !important;
    text-align: center;
    background: #333;
    border: none;
    color: white;
    border-radius: 4px;
    margin: 0 4px;
    height: 46px !important;
    box-sizing: border-box;
    font-size: 16px;
    padding: 8px 4px;
  }

  /* Timeout controls specific styling */
  #homeTimeoutControls,
  #awayTimeoutControls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
  }

  #homeTimeoutControls button,
  #awayTimeoutControls button {
    min-width: 50px;
    height: 46px;
  }

  .timeouts-container {
    display: flex;
    gap: 6px;
    cursor: pointer;
    justify-content: center;
    user-select: none;
  }

  .timeout-indicator {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    background: gray; /* flat gray by default */
    box-shadow: none;
    transition: background 0.3s, box-shadow 0.3s;
  }

  .timeout-indicator.available {
    background: gold;
    box-shadow: 0 0 8px 2px gold;
  }

  .timeout-indicator.used {
    background: #666; /* darker gray for used */
    box-shadow: none;
  }

  :disabled:hover {
    border: 2px solid #555;
    border-radius: 8px;
    background: #444;
    color: white;
    transform: translateY(0px);
  }

  /* Custom Notification Styles */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    z-index: 10000;
    min-width: 250px;
    animation: slideInRight 0.3s ease-out;
  }

  .notification.success {
    border-left: 4px solid #4CAF50;
  }

  .notification.warning {
    border-left: 4px solid #ff9800;
  }

  .notification.error {
    border-left: 4px solid #f44336;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
</style>
</head>
<body>

<!-- Sport Selection Overlay -->
<div class="sport-selection-overlay hidden" id="sportSelectionOverlay">
  <div class="sport-selection-modal">
    <h2>Select Sport</h2>
    <p>Please choose the sport you want to create a scoreboard for:</p>
    <div class="sport-options">
      <button class="sport-option-btn" data-sport="football">FOOTBALL</button>
      <button class="sport-option-btn" data-sport="basketball">BASKETBALL</button>
      <button class="sport-option-btn" data-sport="volleyball">VOLLEYBALL</button>
      <!-- <button class="sport-option-btn" style="cursor:not-allowed;" data-sport="baseball">BASEBALL</button> -->
      <button class="sport-option-btn disabled" style="cursor:not-allowed; opacity:0.3;" data-sport="baseball" disabled>BASEBALL</button>
    </div>
  </div>
</div>

<!-- Current Sport Display -->
<div class="current-sport-display" id="currentSportDisplay">NO SPORT SELECTED</div>

<!-- Game Setup Fullscreen Menu -->
<div class="fullscreen-menu" id="gameSetupMenu" role="region" aria-label="Game Setup Controls">
  <div class="fullscreen-menu-content">
    <div class="fullscreen-menu-header">
      <h1>Game Setup</h1>
      <button class="fullscreen-menu-close" id="gameSetupMenuClose" aria-label="Close Game Setup Menu">×</button>
    </div>

    <div class="menu-grid">
      <div class="menu-column">
        <h2>Home Team</h2>
        <div class="section" id="homeSection">
          <label>
            Full School Name:
            <input type="text" id="homeFullSchoolName" value="Home School" />
          </label>
          <label>
            School Name:
            <input type="text" id="homeSchoolName" value="Home School" />
          </label>
          <label>
            Mascot:
            <input type="text" id="homeSchoolMascot" value="Home Mascot" />
          </label>
          <label>
            School Name Background Color:
            <input type="color" id="homeSchoolBgColor" value="#c41e3a" />
          </label>
          <label>
            Team Logo:
            <input type="file" id="homeLogoInput" accept="image/*" />
          </label>
          <img id="homeLogoPreview" class="logo-preview" alt="Home Logo Preview" />
        </div>
      </div>

      <div class="menu-column">
        <h2>Away Team</h2>
        <div class="section" id="awaySection">
          <label>
            Full School Name:
            <input type="text" id="awayFullSchoolName" value="Away School" />
          </label>
          <label>
            School Name:
            <input type="text" id="awaySchoolName" value="Away School" />
          </label>
          <label>
            Mascot:
            <input type="text" id="awaySchoolMascot" value="Away Mascot" />
          </label>
          <label>
            School Name Background Color:
            <input type="color" id="awaySchoolBgColor" value="#006633" />
          </label>
          <label>
            Team Logo:
            <input type="file" id="awayLogoInput" accept="image/*" />
          </label>
          <img id="awayLogoPreview" class="logo-preview" alt="Away Logo Preview" />
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Fullscreen Menu -->
<div class="fullscreen-menu" id="settingsMenu">
  <div class="fullscreen-menu-content">
    <div class="fullscreen-menu-header">
      <h1>Settings</h1>
      <button class="fullscreen-menu-close" id="settingsMenuClose" aria-label="Close Settings Menu">×</button>
    </div>

    <div class="menu-grid">
      <div class="menu-column">
        <h2>Ticker Settings</h2>
        <div class="section">
          <label>
            Ticker Logo:
            <input type="file" id="tickerLogoInput" accept="image/*" />
          </label>
          <img id="tickerLogoPreview" class="logo-preview" alt="Ticker Logo Preview" />
        </div>
        
        <div class="section" style="margin-top: 30px;">
          <h3 style="font-size: 18px; margin-bottom: 15px;">Ticker Messages</h3>
          <div id="tickerLinesList" style="margin-bottom: 15px;">
            <!-- Ticker lines will be added here dynamically -->
          </div>
          <button id="addTickerLineBtn" style="background: #c41e3a; border: none; color: white; font-size: 14px; padding: 10px 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease;">+ Add Ticker Line</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hotkeys Fullscreen Menu -->
<div class="fullscreen-menu" id="hotkeysMenu">
  <div class="fullscreen-menu-content">
    <div class="fullscreen-menu-header">
      <h1>Hotkey Assignment</h1>
      <button class="fullscreen-menu-close" id="hotkeysMenuClose" aria-label="Close Hotkeys Menu">×</button>
    </div>

    <div class="menu-grid">
      <div class="menu-column">
        <h2>Score Controls</h2>
        <div class="hotkey-item">
          <label>Home +1:</label>
          <input type="text" class="hotkey-input" data-action="homeInc1" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Home +2/+6:</label>
          <input type="text" class="hotkey-input" data-action="homeInc2" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Home +3:</label>
          <input type="text" class="hotkey-input" data-action="homeInc3" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Home -1:</label>
          <input type="text" class="hotkey-input" data-action="homeDec1" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Away +1:</label>
          <input type="text" class="hotkey-input" data-action="awayInc1" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Away +2/+6:</label>
          <input type="text" class="hotkey-input" data-action="awayInc2" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Away +3:</label>
          <input type="text" class="hotkey-input" data-action="awayInc3" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Away -1:</label>
          <input type="text" class="hotkey-input" data-action="awayDec1" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
      </div>

      <div class="menu-column">
        <h2>Clock & Period Controls</h2>
        <div class="hotkey-item">
          <label>Start/Pause:</label>
          <input type="text" class="hotkey-input" data-action="clockStartPause" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Reset Clock:</label>
          <input type="text" class="hotkey-input" data-action="clockReset" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Clock +1 Min:</label>
          <input type="text" class="hotkey-input" data-action="clockMinInc" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Clock -1 Min:</label>
          <input type="text" class="hotkey-input" data-action="clockMinDec" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Clock +1 Sec:</label>
          <input type="text" class="hotkey-input" data-action="clockSecInc" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Clock -1 Sec:</label>
          <input type="text" class="hotkey-input" data-action="clockSecDec" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Previous Period:</label>
          <input type="text" class="hotkey-input" data-action="periodPrev" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Next Period:</label>
          <input type="text" class="hotkey-input" data-action="periodNext" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        
        <h2 style="margin-top: 25px;">Timeout Controls</h2>
        <div class="hotkey-item">
          <label>Home Timeout -:</label>
          <input type="text" class="hotkey-input" data-action="homeTimeoutDec" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Away Timeout -:</label>
          <input type="text" class="hotkey-input" data-action="awayTimeoutDec" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
      </div>

      <div class="menu-column">
        <h2>Graphics Controls</h2>
        <div class="hotkey-item">
          <label>Scorebar In:</label>
          <input type="text" class="hotkey-input" data-action="scorebarIn" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Scorebar Out:</label>
          <input type="text" class="hotkey-input" data-action="scorebarOut" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Mini Bug In:</label>
          <input type="text" class="hotkey-input" data-action="miniBugIn" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Mini Bug Out:</label>
          <input type="text" class="hotkey-input" data-action="miniBugOut" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Locator In:</label>
          <input type="text" class="hotkey-input" data-action="statsPanelIn" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Locator Out:</label>
          <input type="text" class="hotkey-input" data-action="statsPanelOut" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Lower Third In:</label>
          <input type="text" class="hotkey-input" data-action="lowerThirdIn" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Lower Third Out:</label>
          <input type="text" class="hotkey-input" data-action="lowerThirdOut" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Tombstone In:</label>
          <input type="text" class="hotkey-input" data-action="tombstoneIn" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Tombstone Out:</label>
          <input type="text" class="hotkey-input" data-action="tombstoneOut" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Talent In:</label>
          <input type="text" class="hotkey-input" data-action="talentIn" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Talent Out:</label>
          <input type="text" class="hotkey-input" data-action="talentOut" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Left Slab In:</label>
          <input type="text" class="hotkey-input" data-action="leftSlabIn" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>
        <div class="hotkey-item">
          <label>Left Slab Out:</label>
          <input type="text" class="hotkey-input" data-action="leftSlabOut" placeholder="Click to assign" readonly>
          <button class="clear-hotkey">Clear</button>
        </div>

        <div class="section" id="footballHotkeysSection" style="display: none;">
          <h2 style="margin-top: 25px;">Football Controls</h2>
          <div class="hotkey-item">
            <label>Down Previous:</label>
            <input type="text" class="hotkey-input" data-action="downPrev" placeholder="Click to assign" readonly>
            <button class="clear-hotkey">Clear</button>
          </div>
          <div class="hotkey-item">
            <label>Down Next:</label>
            <input type="text" class="hotkey-input" data-action="downNext" placeholder="Click to assign" readonly>
            <button class="clear-hotkey">Clear</button>
          </div>
          <div class="hotkey-item">
            <label>Yards +1:</label>
            <input type="text" class="hotkey-input" data-action="yardsInc" placeholder="Click to assign" readonly>
            <button class="clear-hotkey">Clear</button>
          </div>
          <div class="hotkey-item">
            <label>Yards -1:</label>
            <input type="text" class="hotkey-input" data-action="yardsDec" placeholder="Click to assign" readonly>
            <button class="clear-hotkey">Clear</button>
          </div>
          <div class="hotkey-item">
            <label>Toggle Football Text:</label>
            <input type="text" class="hotkey-input" data-action="footballTextToggle" placeholder="Click to assign" readonly>
            <button class="clear-hotkey">Clear</button>
          </div>
          <div class="hotkey-item">
            <label>Flag:</label>
            <input type="text" class="hotkey-input" data-action="flagBtn" placeholder="Click to assign" readonly>
            <button class="clear-hotkey">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status bar -->
 <div class="status-bar" role="region" aria-label="Graphics Status">
    <!-- Dropdown Menu -->
    <div class="status-bar-dropdown">
      <button class="status-dropdown-toggle" id="statusDropdownToggle" aria-label="Menu">
        Menu
      </button>
      <div class="status-dropdown-menu" id="statusDropdownMenu">
        <button class="status-dropdown-item" id="statusGameSetupBtn">Game Setup</button>
        <button class="status-dropdown-item" id="statusHotkeyBtn">Hotkeys</button>
        <button class="status-dropdown-item" id="statusSettingsBtn">Settings</button>
        <button class="status-dropdown-item" id="statusNewGameBtn">New Game</button>
        <button class="status-dropdown-item" id="statusChangeSportBtn">Change Sport</button>
      </div>
    </div>

    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="scorebarStatus"></div>
            <span class="status-label">Scorebar</span>
        </div>
        <button class="status-edit-btn" id="scorebarEditBtn">Stats</button>
    </div>
    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="miniBugStatus"></div>
            <span class="status-label">Mini Bug</span>
        </div>
        <button class="status-edit-btn" id="miniBugEditBtn">Edit</button>
    </div>
    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="locatorStatus"></div>
            <span class="status-label">Locator</span>
        </div>
        <button class="status-edit-btn" id="locatorEditBtn">Edit</button>
    </div>
    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="lowerThirdStatus"></div>
            <span class="status-label">Lower Third</span>
        </div>
        <button class="status-edit-btn" id="lowerThirdEditBtn">Edit</button>
    </div>
    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="tombstoneStatus"></div>
            <span class="status-label">Tombstone</span>
        </div>
        <button class="status-edit-btn" id="tombstoneEditBtn">Edit</button>
    </div>
    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="talentStatus"></div>
            <span class="status-label">Talent</span>
        </div>
        <button class="status-edit-btn" id="talentEditBtn">Edit</button>
    </div>
    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="leftSlabStatus"></div>
            <span class="status-label">Left Slab</span>
        </div>
        <button class="status-edit-btn" id="leftSlabEditBtn">Edit</button>
    </div>
    <div class="status-item">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div class="status-circle" id="fullscreenStatus"></div>
            <span class="status-label">Fullscreen</span>
        </div>
        <button class="status-edit-btn" id="fullscreenEditBtn">Edit</button>
    </div>
 </div>



<!-- Main content -->
<div class="main-content" id="mainContent">
  <!-- Scorebug Controls -->
  <div class="scorebug-controls">
    <div class="scorebug-control-group" aria-label="Home Score Controls">
      <label for="homeScoreInput" id="homeScoreLabel">Home Score</label>
      <div class="scorebug-btn-group">
        <button id="homeInc1" aria-label="Increase Home Score by 1">+1</button>
        <button id="homeInc2" aria-label="Increase Home Score by 2/6">+2</button>
        <button id="homeInc3" aria-label="Increase Home Score by 3">+3</button>
        <button id="homeDec1" aria-label="Decrease Home Score by 1">-1</button>
        <button id="homeDec6" aria-label="Decrease Home Score by 6" style="display: none;">-6</button>
      </div>
    </div>

    <div class="scorebug-control-group" aria-label="Away Score Controls">
      <label for="awayScoreInput" id="awayScoreLabel">Away Score</label>
      <div class="scorebug-btn-group">
        <button id="awayInc1" aria-label="Increase Away Score by 1">+1</button>
        <button id="awayInc2" aria-label="Increase Away Score by 2/6">+2</button>
        <button id="awayInc3" aria-label="Increase Away Score by 3">+3</button>
        <button id="awayDec1" aria-label="Decrease Away Score by 1">-1</button>
        <button id="awayDec6" aria-label="Decrease Away Score by 6" style="display: none;">-6</button>
      </div>
    </div>

    <div class="scorebug-control-group" id="periodControlGroup" aria-label="Period Controls">
      <label for="periodInput">Period (Quarter)</label>
      <input type="text" id="periodInput" value="Q1" maxlength="3" aria-live="polite" aria-atomic="true" />
      <div class="scorebug-btn-group">
        <button id="periodPrev">Prev</button>
        <button id="periodNext">Next</button>
      </div>
    </div>

    <div class="scorebug-control-group" id="setControlGroup" aria-label="Set Controls" style="display: none;">
      <label for="setInput">Set</label>
      <input type="text" id="setInput" value="1" maxlength="1" aria-live="polite" aria-atomic="true" readonly />
      <div class="scorebug-btn-group">
        <button id="setPrev">Prev</button>
        <button id="setNext">Next</button>
      </div>
    </div>

    <div class="scorebug-control-group" aria-label="Home Timeout Controls">
      <label>Home Timeouts</label>
      <div class="scorebug-btn-group" id="homeTimeoutControls" role="group" aria-label="Home Timeouts Controls">
        <button id="homeTimeoutDec" aria-label="Use a Home Timeout">-</button>
        <input type="text" id="homeTimeoutCount" value="5" aria-live="polite" aria-atomic="true" readonly class="timeout-count-input"/>
        <button id="homeTimeoutInc" aria-label="Add a Home Timeout">+</button>
      </div>
    </div>

    <div class="scorebug-control-group" aria-label="Away Timeout Controls">
      <label>Away Timeouts</label>
      <div class="scorebug-btn-group" id="awayTimeoutControls" role="group" aria-label="Away Timeouts Controls">
        <button id="awayTimeoutDec" aria-label="Use an Away Timeout">-</button>
        <input type="text" id="awayTimeoutCount" value="5" aria-live="polite" aria-atomic="true" readonly class="timeout-count-input"/>
        <button id="awayTimeoutInc" aria-label="Add an Away Timeout">+</button>
      </div>
    </div>

    <div class="scorebug-control-group" id="clockControlGroup" aria-label="Game Clock Controls">
      <label for="clockInput">Game Clock</label>
      <input type="text" id="clockInput" value="08:00" maxlength="5" aria-live="polite" aria-atomic="true" />
      <div class="scorebug-btn-group">
        <button id="clockStartPause">Start</button>
        <button id="clockReset">Reset</button>
      </div>
      <div class="scorebug-btn-group" style="margin-top: 8px; display: none;">
        <button id="clockMinInc" aria-label="Add 1 minute">+1m</button>
        <button id="clockMinDec" aria-label="Subtract 1 minute">-1m</button>
        <button id="clockSecInc" aria-label="Add 1 second">+1s</button>
        <button id="clockSecDec" aria-label="Subtract 1 second">-1s</button>
      </div>
    </div>
  </div>

  <!-- Football Controls (only visible when football is selected) -->
  <div class="football-controls" id="footballControls" style="display: none;">
    <div class="scorebug-control-group" aria-label="Down Controls">
      <label for="downInput">Down</label>
      <input type="text" id="downInput" value="1st" maxlength="3" aria-live="polite" aria-atomic="true" />
      <div class="scorebug-btn-group">
        <button id="downPrev">Prev</button>
        <button id="downNext">Next</button>
      </div>
    </div>

    <div class="scorebug-control-group" aria-label="Yards To Go Controls">
      <label for="yardsToGoInput">Yards To Go</label>
      <input type="text" id="yardsToGoInput" value="10" maxlength="2" aria-live="polite" aria-atomic="true" />
      <div class="scorebug-btn-group">
        <button id="yardsInc">+1</button>
        <button id="yardsDec">-1</button>
      </div>
    </div>

    <div class="scorebug-control-group" aria-label="Down & Yards Display Controls">
      <label>Display</label>
      <button id="footballTextToggle" style="background: #444; color: #fff; width: 125px !important;">HIDE TEXT</button>
    </div>

    <div class="scorebug-control-group" aria-label="Flag Controls">
      <label>Flag</label>
      <button id="flagBtn" style="background: #ffd700; color: #000; font-weight: bold; width: 125px !important;">FLAG</button>
    </div>
  </div>

  

  <!-- Scorebar Controls -->
  <div class="scorebar-controls">
    <span class="scorebar-label">Scorebar</span>
    <div class="scorebar-buttons">
      <button id="scorebarInBtn" class="scorebar-btn">IN</button>
      <button id="scorebarOutBtn" class="scorebar-btn">OUT</button>
      <button id="scorebarExpandBtn" class="scorebar-btn" disabled>&gt;</button>
    </div>
  </div>

  <!-- Mini Bug Controls -->
  <div class="mini-bug-controls">
    <span class="mini-bug-label">Mini Bug</span>
    <div class="mini-bug-buttons">
      <button id="miniBugInBtn" class="mini-bug-btn">IN</button>
      <button id="miniBugOutBtn" class="mini-bug-btn">OUT</button>
      <button id="miniBugExpandBtn" class="mini-bug-btn" disabled>&gt;</button>
    </div>
  </div>

  <!-- Locator Controls -->
  <div class="stats-panel-controls">
    <span class="stats-panel-label">Locator</span>
    <div class="stats-panel-buttons">
      <button id="statsPanelInBtn" class="stats-panel-btn">IN</button>
      <button id="statsPanelOutBtn" class="stats-panel-btn">OUT</button>
      <button id="statsPanelExpandBtn" class="stats-panel-btn" disabled>&gt;</button>
    </div>
  </div>

  <!-- Lower Third Controls -->
  <div class="lower-third-controls">
    <span class="lower-third-label">Lower Third</span>
    <div class="lower-third-buttons">
      <button id="lowerThirdInBtn" class="lower-third-btn">IN</button>
      <button id="lowerThirdOutBtn" class="lower-third-btn">OUT</button>
      <button id="lowerThirdExpandBtn" class="lower-third-btn">&gt;</button>
    </div>
  </div>

  <!-- Lower Third Expanded Section -->
  <div class="lower-third-expanded" id="lowerThirdExpanded">
    <div class="lower-third-input-group">
      <label>TEAM:</label>
      <div style="display: flex; gap: 10px;">
        <button id="homeTeamToggle" class="team-toggle-btn active">HOME</button>
        <button id="awayTeamToggle" class="team-toggle-btn">AWAY</button>
        <button id="csnTeamToggle" class="team-toggle-btn">GENERIC</button>
      </div>
    </div>
    <div class="lower-third-input-group">
      <label for="lowerThirdName">NAME:</label>
      <input type="text" id="lowerThirdName" placeholder="Enter name">
    </div>
    <div class="lower-third-input-group">
      <label for="lowerThirdTitle">TITLE:</label>
      <input type="text" id="lowerThirdTitle" placeholder="Enter title">
    </div>
  </div>

  <!-- Tombstone Controls -->
  <div class="ticker-controls" style="top: 260px;"> <!-- Adjusted top position -->
    <span class="ticker-label">Tombstone</span> <!-- Changed label -->
    <div class="ticker-buttons">
      <button id="tombstoneInBtn" class="ticker-btn">IN</button> <!-- Renamed IDs -->
      <button id="tombstoneOutBtn" class="ticker-btn">OUT</button> <!-- Renamed IDs -->
      <button id="tombstoneExpandBtn" class="ticker-btn">&gt;</button> <!-- Renamed IDs -->
    </div>
  </div>

  <!-- Tombstone Expanded Section -->
  <div class="lower-third-expanded" id="tombstoneExpanded" style="top: 260px; left: 490px;">
    <div class="lower-third-input-group">
      <label>TEAM:</label>
      <div style="display: flex; gap: 10px;">
        <button id="tombstoneHomeTeamToggle" class="team-toggle-btn active">HOME</button>
        <button id="tombstoneAwayTeamToggle" class="team-toggle-btn">AWAY</button>
        <button id="tombstoneWeatherTeamToggle" class="team-toggle-btn">Weather</button>
      </div>
    </div>

    <!-- Weather inputs - shown when weather team is selected -->
    <div id="tombstoneWeatherInputs" style="display: none;">
      <div class="lower-third-input-group">
        <label for="weatherTemp">Temperature:</label>
        <div style="display: flex; align-items: center; gap: 4px;">
          <input type="number" id="weatherTemp" placeholder="72" style="width: 50px;">
          <span style="color: #eee; font-size: 16px;">°F</span>
        </div>
      </div>
      <div class="lower-third-input-group">
        <label for="weatherFeelsLike">Feels like:</label>
        <div style="display: flex; align-items: center; gap: 4px;">
          <input type="number" id="weatherFeelsLike" placeholder="75" style="width: 50px;">
          <span style="color: #eee; font-size: 16px;">°F</span>
        </div>
      </div>
      <div class="lower-third-input-group">
        <label for="weatherHumidity">Humidity:</label>
        <input type="text" id="weatherHumidity" placeholder="65%">
      </div>
      <div class="lower-third-input-group">
        <label for="weatherWind">Wind:</label>
        <input type="text" id="weatherWind" placeholder="8 mph NW">
      </div>
      <div class="lower-third-input-group">
        <label for="weatherUVIndex">UV Index:</label>
        <div style="display: flex; align-items: center; gap: 4px;">
          <input type="number" id="weatherUVIndex" placeholder="3" min="0" max="11" style="width: 50px;">
          <span style="color: #eee; font-size: 16px;">/11</span>
        </div>
      </div>
    </div>

    <!-- Custom sections - shown when home/away team is selected -->
    <div id="tombstoneCustomSections">
      <div class="lower-third-input-group">
        <label style="font-weight: bold; color: #fff; margin-bottom: 10px; display: block;">SECTIONS:</label>
        <button id="addTombstoneSection" style="background: #c41e3a; padding: 8px 16px; margin-bottom: 15px;">+ Add Section</button>
      </div>
      <div id="tombstoneSectionsList">
        <!-- Sections will be added here dynamically -->
      </div>
    </div>
  </div>

  <!-- Talent Controls -->
  <div class="talent-controls">
    <span class="talent-label">Talent</span>
    <div class="talent-buttons">
      <button id="talentInBtn" class="talent-btn">IN</button>
      <button id="talentOutBtn" class="talent-btn">OUT</button>
      <button id="talentExpandBtn" class="talent-btn">&gt;</button>
    </div>
  </div>

  <!-- Left Slab Controls -->
  <div class="left-slab-controls">
    <span class="left-slab-label">Left Slab</span>
    <div class="left-slab-buttons">
      <button id="leftSlabInBtn" class="left-slab-btn">IN</button>
      <button id="leftSlabOutBtn" class="left-slab-btn">OUT</button>
      <button id="leftSlabExpandBtn" class="left-slab-btn">&gt;</button>
    </div>
  </div>

  <!-- Left Slab Expanded Section -->
  <div class="left-slab-expanded" id="leftSlabExpanded">
    <div class="left-slab-input-group">
      <label style="font-weight: bold; color: #fff; margin-bottom: 5px; display: block;">TITLE 1:</label>
      <input type="text" id="leftSlabTitleInput" placeholder="Enter first title line" style="
        width: 100%;
        padding: 6px 10px;
        font-size: 14px;
        border-radius: 4px;
        border: none;
        background: #333;
        color: #eee;
        font-family: inherit;
        margin-bottom: 10px;
      ">
    </div>
    <div class="left-slab-input-group">
      <label style="font-weight: bold; color: #fff; margin-bottom: 5px; display: block;">TITLE 2:</label>
      <input type="text" id="leftSlabTitle2Input" placeholder="Enter second title line" style="
        width: 100%;
        padding: 6px 10px;
        font-size: 14px;
        border-radius: 4px;
        border: none;
        background: #333;
        color: #eee;
        font-family: inherit;
        margin-bottom: 15px;
      ">
    </div>
    <div class="left-slab-input-group">
      <label style="font-weight: bold; color: #fff; margin-bottom: 10px; display: block;">SECTIONS:</label>
      <button id="addLeftSlabSection" style="background: #c41e3a; padding: 8px 16px; margin-bottom: 15px;">+ Add Section</button>
    </div>
    <div id="leftSlabSectionsList">
      <!-- Sections will be added here dynamically -->
    </div>
  </div>

  <!-- Fullscreen Controls -->
  <div class="left-slab-controls" style="top: 290px;">
    <span class="left-slab-label">Fullscreen</span>
    <div class="left-slab-buttons">
      <button id="fullscreenInBtn" class="left-slab-btn">IN</button>
      <button id="fullscreenOutBtn" class="left-slab-btn">OUT</button>
      <button id="fullscreenExpandBtn" class="left-slab-btn" disabled>&gt;</button>
    </div>
  </div>

  <!-- Talent Expanded Section -->
  <div class="talent-expanded" id="talentExpanded">
    <div class="talent-input-group">
      <label style="font-weight: bold; color: #eee; margin-bottom: 10px; display: block;">LEFT TALENT:</label>
    </div>
    <div class="talent-input-group">
      <label>NAME:</label>
      <input type="text" id="talentLeftName" placeholder="Enter left talent name">
    </div>
    <div class="talent-input-group">
      <label>TITLE:</label>
      <input type="text" id="talentLeftTitle" placeholder="Enter left talent title">
    </div>
    <div class="talent-input-group">
      <label style="font-weight: bold; color: #eee; margin-bottom: 10px; margin-top: 15px; display: block;">RIGHT TALENT:</label>
    </div>
    <div class="talent-input-group">
      <label>NAME:</label>
      <input type="text" id="talentRightName" placeholder="Enter right talent name">
    </div>
    <div class="talent-input-group">
      <label>TITLE:</label>
      <input type="text" id="talentRightTitle" placeholder="Enter right talent title">
    </div>
  </div>

</div>

<!-- Custom Modal for NEW GAME confirmation -->
<div class="modal-overlay" id="newGameModal">
  <div class="modal">
    <h3>Start New Game</h3>
    <p>Are you sure you want you want to start a new game?<br>This will reset all scores and game settings.</p>
    <div class="modal-buttons">
      <button class="modal-btn confirm" id="confirmNewGame">Confirm</button>
      <button class="modal-btn cancel" id="cancelNewGame">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Modal for graphics configuration -->
<div class="modal-overlay" id="editModal">
  <div class="edit-modal">
    <div class="edit-modal-header">
      <h3 id="editModalTitle">Edit Graphic</h3>
      <button class="modal-close-btn" id="editModalClose">×</button>
    </div>
    <div class="edit-modal-content" id="editModalContent">
      <!-- Dynamic content will be inserted here -->
    </div>
  </div>
</div>

<!-- Football Stats Modal -->
<div class="modal-overlay" id="footballStatsModal">
  <div class="edit-modal">
    <div class="edit-modal-header">
      <h3>Team Statistics</h3>
      <button class="modal-close-btn" id="footballStatsModalClose">×</button>
    </div>
    <div class="edit-modal-content">
      <!-- XML Connection Section -->
      <div id="xmlConnectionSection" style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; border: 1px solid #444;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h4 style="margin: 0; color: #fff; font-size: 14px;">XML Data Connection</h4>
          <div id="xmlConnectionStatus" style="display: flex; align-items: center; gap: 6px;">
            <div id="xmlStatusDot" style="width: 10px; height: 10px; border-radius: 50%; background: #666;"></div>
            <span id="xmlStatusText" style="color: #999; font-size: 12px;">Not Connected</span>
          </div>
        </div>
        
        <div id="xmlConnectionCollapsed" style="display: block;">
          <button id="connectXmlBtn" style="background: #3498db; border: none; color: white; font-size: 14px; padding: 10px 20px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease; width: 100%;">
            Connect XML
          </button>
        </div>
        
        <div id="xmlConnectionExpanded" style="display: none;">
          <div style="margin-bottom: 12px;">
            <label style="display: block; color: #ccc; font-size: 12px; margin-bottom: 6px;">XML URL:</label>
            <input type="text" id="xmlUrlInput" placeholder="Enter XML URL..." style="width: 100%; padding: 10px 12px; font-size: 13px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
          </div>
          <div style="display: flex; gap: 10px;">
            <button id="xmlConnectStartBtn" style="flex: 1; background: #27ae60; border: none; color: white; font-size: 14px; padding: 10px 16px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease;">
              Start Connection
            </button>
            <button id="xmlConnectStopBtn" style="flex: 1; background: #e74c3c; border: none; color: white; font-size: 14px; padding: 10px 16px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease; display: none;">
              Stop Connection
            </button>
            <button id="xmlConnectCancelBtn" style="background: #666; border: none; color: white; font-size: 14px; padding: 10px 16px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease;">
              Cancel
            </button>
          </div>
          <div id="xmlDataPreview" style="margin-top: 12px; display: none;">
            <label style="display: block; color: #ccc; font-size: 12px; margin-bottom: 6px;">Last Update:</label>
            <div id="xmlLastUpdate" style="font-size: 11px; color: #888;"></div>
            <div id="xmlDataFields" style="margin-top: 8px; max-height: 150px; overflow-y: auto; background: #333; padding: 10px; border-radius: 4px; font-size: 11px; color: #aaa;"></div>
          </div>
        </div>
      </div>
      
      <div class="edit-input-group">
        <label for="statSelect">Select Statistic:</label>
        <select id="statSelect" style="width: 100%; padding: 10px 12px; font-size: 14px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
          <option value="">Choose a statistic...</option>
          <option value="turnovers">Turnovers</option>
          <option value="fumbles">Fumbles</option>
          <option value="interceptions">Interceptions</option>
          <option value="rushing_yards">Rushing Yards</option>
          <option value="passing_yards">Passing Yards</option>
          <option value="total_yards">Total Yards</option>
          <option value="touchdowns">Touchdowns</option>
          <option value="field_goals">Field Goals</option>
          <option value="first_downs">First Downs</option>
          <option value="penalties">Penalties</option>
          <option value="penalty_yards">Penalty Yards</option>
          <option value="sacks">Sacks</option>
          <option value="time_of_possession">Time of Possession</option>
        </select>
      </div>
      
      <div id="statsInputSection" style="display: none; margin-top: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="edit-input-group">
            <label id="homeStatLabel">Home Team:</label>
            <input type="text" id="homeStatValue" placeholder="Enter value" style="width: 100%; padding: 10px 12px; font-size: 14px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
          </div>
          
          <div class="edit-input-group">
            <label id="awayStatLabel">Away Team:</label>
            <input type="text" id="awayStatValue" placeholder="Enter value" style="width: 100%; padding: 10px 12px; font-size: 14px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
          <button id="saveStatsBtn" style="background: #c41e3a; border: none; color: white; font-size: 16px; padding: 12px 24px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease; margin-right: 10px;">Save Statistics</button>
          <button id="clearStatsBtn" style="background: #666; border: none; color: white; font-size: 16px; padding: 12px 24px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease;">Clear All Stats</button>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #555; text-align: center;">
          <h4 style="margin: 0 0 15px 0; color: #fff;">Display Stat Graphic</h4>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="statDisplayInBtn" style="background: #4CAF50; border: none; color: white; font-size: 16px; padding: 12px 32px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease;">IN</button>
            <button id="statDisplayOutBtn" style="background: #f44336; border: none; color: white; font-size: 16px; padding: 12px 32px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease;">OUT</button>
          </div>
        </div>
      </div>
      
      <div id="currentStatsDisplay" style="margin-top: 30px; padding: 20px; background: #2a2a2a; border-radius: 4px;">
        <h4 style="margin: 0 0 15px 0; color: #fff; text-align: center;">Current Statistics</h4>
        <div id="statsListDisplay">
          <p style="color: #ccc; text-align: center; font-style: italic;">No statistics entered yet</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Sport selection functionality
  const sportSelectionOverlay = document.getElementById('sportSelectionOverlay');
  const currentSportDisplay = document.getElementById('currentSportDisplay');
  const sportOptionBtns = document.querySelectorAll('.sport-option-btn');
  let currentSport = null;

  // Show sport selection on load if no sport is selected
  function checkSportSelection() {
    // Only check currentSport variable, ignore localStorage to force selection
    if (!currentSport) {
      sportSelectionOverlay.classList.remove('hidden');
    } else {
      sportSelectionOverlay.classList.add('hidden');
      currentSportDisplay.textContent = `${currentSport.toUpperCase()}`;
    }
  }

  // Handle sport selection
  sportOptionBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const sport = btn.dataset.sport;
      selectSport(sport);
    });
  });

  function selectSport(sport) {
    currentSport = sport;
    sportSelectionOverlay.classList.add('hidden');
    currentSportDisplay.textContent = `${sport.toUpperCase()}`;

    // Update score controls based on sport
    updateScoreControls();

    // Reset timeouts to sport-specific maximum
    let maxTimeouts;
    if (sport === 'football') {
      maxTimeouts = MAX_TIMEOUTS_FOOTBALL;
    } else if (sport === 'volleyball') {
      maxTimeouts = MAX_TIMEOUTS_VOLLEYBALL;
    } else {
      maxTimeouts = MAX_TIMEOUTS;
    }
    homeTimeoutsLeft = maxTimeouts;
    awayTimeoutsLeft = maxTimeouts;
    updateTimeoutDisplay(homeTimeoutCountInput, homeTimeoutsLeft);
    updateTimeoutDisplay(awayTimeoutCountInput, awayTimeoutsLeft);

    // Save sport selection
    localStorage.setItem('selectedSport', sport);
    saveScoreboardState();

    // Update football hotkeys visibility
    updateFootballHotkeysVisibility();
    
    // Update edit button states based on new sport
    updateEditButtonStates();
  }

  // Function to update score controls based on selected sport
  function updateScoreControls() {
    const homeInc2Btn = document.getElementById('homeInc2');
    const homeInc3Btn = document.getElementById('homeInc3');
    const homeDec6Btn = document.getElementById('homeDec6');
    const awayInc2Btn = document.getElementById('awayInc2');
    const awayInc3Btn = document.getElementById('awayInc3');
    const awayDec6Btn = document.getElementById('awayDec6');
    const footballControls = document.getElementById('footballControls');
    const periodControlGroup = document.getElementById('periodControlGroup');
    const clockControlGroup = document.getElementById('clockControlGroup');
    const setControlGroup = document.getElementById('setControlGroup');

    if (currentSport === 'football') {
      // Football scoring: +1, +6, -1, -6
      homeInc2Btn.textContent = '+6';
      homeInc2Btn.setAttribute('aria-label', 'Increase Home Score by 6');
      homeInc3Btn.style.display = 'none';
      homeDec6Btn.style.display = 'inline-block';

      awayInc2Btn.textContent = '+6';
      awayInc2Btn.setAttribute('aria-label', 'Increase Away Score by 6');
      awayInc3Btn.style.display = 'none';
      awayDec6Btn.style.display = 'inline-block';

      // Show football controls and standard controls
      if (footballControls) footballControls.style.display = 'grid';
      if (periodControlGroup) periodControlGroup.style.display = 'flex';
      if (clockControlGroup) clockControlGroup.style.display = 'flex';
      if (setControlGroup) setControlGroup.style.display = 'none';
    } else if (currentSport === 'volleyball') {
      // Volleyball scoring: +1, -1 only
      homeInc2Btn.style.display = 'none';
      homeInc3Btn.style.display = 'none';
      homeDec6Btn.style.display = 'none';

      awayInc2Btn.style.display = 'none';
      awayInc3Btn.style.display = 'none';
      awayDec6Btn.style.display = 'none';

      // Hide period and clock controls, show set controls
      if (footballControls) footballControls.style.display = 'none';
      if (periodControlGroup) periodControlGroup.style.display = 'none';
      if (clockControlGroup) clockControlGroup.style.display = 'none';
      if (setControlGroup) setControlGroup.style.display = 'flex';
    } else {
      // Default scoring: +1, +2, +3, -1
      homeInc2Btn.textContent = '+2';
      homeInc2Btn.setAttribute('aria-label', 'Increase Home Score by 2');
      homeInc3Btn.style.display = 'inline-block';
      homeDec6Btn.style.display = 'none';

      awayInc2Btn.textContent = '+2';
      awayInc2Btn.setAttribute('aria-label', 'Increase Away Score by 2');
      awayInc3Btn.style.display = 'inline-block';
      awayDec6Btn.style.display = 'none';

      // Show standard controls, hide sport-specific controls
      if (footballControls) footballControls.style.display = 'none';
      if (periodControlGroup) periodControlGroup.style.display = 'flex';
      if (clockControlGroup) clockControlGroup.style.display = 'flex';
      if (setControlGroup) setControlGroup.style.display = 'none';
    }
    
    // Apply sport mode class to Graphics_output.html
    saveScoreboardState();
  }

  // Status bar dropdown functionality
  const statusDropdownToggle = document.getElementById('statusDropdownToggle');
  const statusDropdownMenu = document.getElementById('statusDropdownMenu');
  const statusGameSetupBtn = document.getElementById('statusGameSetupBtn');
  const statusHotkeyBtn = document.getElementById('statusHotkeyBtn');

  statusDropdownToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    statusDropdownMenu.classList.toggle('show');
    statusDropdownToggle.classList.toggle('open');
  });

  // Status dropdown menu item handlers
  statusGameSetupBtn.addEventListener('click', () => {
    statusDropdownMenu.classList.remove('show');
    statusDropdownToggle.classList.remove('open');
    
    // Close any open menus and open game setup menu
    hideAllMenus();
    showGameSetupMenu();
  });

  statusHotkeyBtn.addEventListener('click', () => {
    statusDropdownMenu.classList.remove('show');
    statusDropdownToggle.classList.remove('open');
    
    // Close any open menus and open hotkeys menu
    hideAllMenus();
    showHotkeysMenu();
  });

  const statusNewGameBtn = document.getElementById('statusNewGameBtn');
  const statusChangeSportBtn = document.getElementById('statusChangeSportBtn');
  const statusSettingsBtn = document.getElementById('statusSettingsBtn');

  statusNewGameBtn.addEventListener('click', () => {
    statusDropdownMenu.classList.remove('show');
    statusDropdownToggle.classList.remove('open');
    
    // Show new game modal
    showNewGameModal();
  });

  statusChangeSportBtn.addEventListener('click', () => {
    statusDropdownMenu.classList.remove('show');
    statusDropdownToggle.classList.remove('open');
    
    // Show sport selection overlay
    sportSelectionOverlay.classList.remove('hidden');
  });

  statusSettingsBtn.addEventListener('click', () => {
    statusDropdownMenu.classList.remove('show');
    statusDropdownToggle.classList.remove('open');
    
    // Close any open menus and open settings menu
    hideAllMenus();
    showSettingsMenu();
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!statusDropdownToggle.contains(e.target)) {
      statusDropdownMenu.classList.remove('show');
      statusDropdownToggle.classList.remove('open');
    }
  });

  statusDropdownMenu.addEventListener('click', () => {
    statusDropdownMenu.classList.remove('show');
    statusDropdownToggle.classList.remove('open');
  });

  // Fullscreen Menu System
  const gameSetupMenu = document.getElementById('gameSetupMenu');
  const hotkeysMenu = document.getElementById('hotkeysMenu');
  const settingsMenu = document.getElementById('settingsMenu');
  const gameSetupMenuClose = document.getElementById('gameSetupMenuClose');
  const hotkeysMenuClose = document.getElementById('hotkeysMenuClose');
  const settingsMenuClose = document.getElementById('settingsMenuClose');
  const mainContent = document.getElementById('mainContent');

  function showGameSetupMenu() {
    gameSetupMenu.classList.add('open');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }

  function hideGameSetupMenu() {
    gameSetupMenu.classList.remove('open');
    document.body.style.overflow = ''; // Restore scrolling
  }

  function showHotkeysMenu() {
    hotkeysMenu.classList.add('open');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }

  function hideHotkeysMenu() {
    hotkeysMenu.classList.remove('open');
    document.body.style.overflow = ''; // Restore scrolling
  }

  function showSettingsMenu() {
    settingsMenu.classList.add('open');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }

  function hideSettingsMenu() {
    settingsMenu.classList.remove('open');
    document.body.style.overflow = ''; // Restore scrolling
  }

  function hideAllMenus() {
    hideGameSetupMenu();
    hideHotkeysMenu();
    hideSettingsMenu();
  }

  // Close button event listeners
  gameSetupMenuClose.addEventListener('click', hideGameSetupMenu);
  hotkeysMenuClose.addEventListener('click', hideHotkeysMenu);
  settingsMenuClose.addEventListener('click', hideSettingsMenu);

  // Close menu when clicking outside content area
  gameSetupMenu.addEventListener('click', (e) => {
    if (e.target === gameSetupMenu) {
      hideGameSetupMenu();
    }
  });

  hotkeysMenu.addEventListener('click', (e) => {
    if (e.target === hotkeysMenu) {
      hideHotkeysMenu();
    }
  });

  settingsMenu.addEventListener('click', (e) => {
    if (e.target === settingsMenu) {
      hideSettingsMenu();
    }
  });

  // Close menus with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideAllMenus();
    }
  });

  // Team elements
  const homeFullNameInput = document.getElementById('homeFullSchoolName');
  const homeNameInput = document.getElementById('homeSchoolName');
  const homeMascotInput = document.getElementById('homeSchoolMascot');
  const homeBgColorInput = document.getElementById('homeSchoolBgColor');

  const awayFullNameInput = document.getElementById('awayFullSchoolName');
  const awayNameInput = document.getElementById('awaySchoolName');
  const awayMascotInput = document.getElementById('awaySchoolMascot');
  const awayBgColorInput = document.getElementById('awaySchoolBgColor');

  // Logo inputs & previews
  const homeLogoInput = document.getElementById('homeLogoInput');
  const homeLogoPreview = document.getElementById('homeLogoPreview');

  const awayLogoInput = document.getElementById('awayLogoInput');
  const awayLogoPreview = document.getElementById('awayLogoPreview');

  // Score elements
  const homeInc1Btn = document.getElementById('homeInc1');
  const homeInc2Btn = document.getElementById('homeInc2');
  const homeInc3Btn = document.getElementById('homeInc3');
  const homeDec1Btn = document.getElementById('homeDec1');
  const awayInc1Btn = document.getElementById('awayInc1');
  const awayInc2Btn = document.getElementById('awayInc2');
  const awayInc3Btn = document.getElementById('awayInc3');
  const awayDec1Btn = document.getElementById('awayDec1');

  // Game period and clock
  const periodInput = document.getElementById('periodInput');
  const periodPrevBtn = document.getElementById('periodPrev');
  const periodNextBtn = document.getElementById('periodNext');
  
  // Clock elements
  const clockInput = document.getElementById('clockInput');
  const clockStartPauseBtn = document.getElementById('clockStartPause');
  const clockResetBtn = document.getElementById('clockReset');
  
  // Clock state variables
  let clockRunning = false;
  let clockTime = '12:00'; // Default clock time
  let clockInterval = null;

  // Timeout buttons and counts
  const MAX_TIMEOUTS = 5;
  const MAX_TIMEOUTS_FOOTBALL = 3;
  const MAX_TIMEOUTS_VOLLEYBALL = 2;
  let homeTimeoutsLeft = MAX_TIMEOUTS;
  let awayTimeoutsLeft = MAX_TIMEOUTS;

  // Scorebar visibility
  let scorebarVisible = true;
  const scorebarInBtn = document.getElementById('scorebarInBtn');
  const scorebarOutBtn = document.getElementById('scorebarOutBtn');

  // Mini Bug visibility
  let miniBugVisible = true;
  const miniBugInBtn = document.getElementById('miniBugInBtn');
  const miniBugOutBtn = document.getElementById('miniBugOutBtn');

  // Locator visibility
  let locatorVisible = false;
  const locatorInBtn = document.getElementById('statsPanelInBtn');
  const locatorOutBtn = document.getElementById('statsPanelOutBtn');

  // Lower Third visibility
  let lowerThirdVisible = false;
  const lowerThirdInBtn = document.getElementById('lowerThirdInBtn');
  const lowerThirdOutBtn = document.getElementById('lowerThirdOutBtn');
  const lowerThirdExpandBtn = document.getElementById('lowerThirdExpandBtn');
  const lowerThirdExpanded = document.getElementById('lowerThirdExpanded');
  let lowerThirdExpanded_isOpen = false;

  // Talent visibility
  let talentVisible = false;
  const talentInBtn = document.getElementById('talentInBtn');
  const talentOutBtn = document.getElementById('talentOutBtn');
  const talentExpandBtn = document.getElementById('talentExpandBtn');
  const talentExpanded = document.getElementById('talentExpanded');
  let talentExpanded_isOpen = false;

  // Left Slab visibility
  let leftSlabVisible = false;
  const leftSlabInBtn = document.getElementById('leftSlabInBtn');
  const leftSlabOutBtn = document.getElementById('leftSlabOutBtn');
  const leftSlabExpandBtn = document.getElementById('leftSlabExpandBtn');
  const leftSlabExpanded = document.getElementById('leftSlabExpanded');
  let leftSlabExpanded_isOpen = false;

  // Fullscreen visibility
  let fullscreenVisible = false;
  const fullscreenInBtn = document.getElementById('fullscreenInBtn');
  const fullscreenOutBtn = document.getElementById('fullscreenOutBtn');
  const fullscreenExpandBtn = document.getElementById('fullscreenExpandBtn');

  // Tombstone visibility
  let tombstoneVisible = false;
  const tombstoneInBtn = document.getElementById('tombstoneInBtn');
  const tombstoneOutBtn = document.getElementById('tombstoneOutBtn');
  const tombstoneExpandBtn = document.getElementById('tombstoneExpandBtn');
  const tombstoneExpanded = document.getElementById('tombstoneExpanded');
  let tombstoneExpanded_isOpen = false;
  let selectedTombstoneTeam = 'home'; // default to home

  // Ticker visibility (display only - no functionality)
  const tickerInBtn = document.getElementById('tickerInBtn');
  const tickerOutBtn = document.getElementById('tickerOutBtn');

  const homeTimeoutDecBtn = document.getElementById('homeTimeoutDec');
  const homeTimeoutIncBtn = document.getElementById('homeTimeoutInc');
  const homeTimeoutCountInput = document.getElementById('homeTimeoutCount');

  const awayTimeoutDecBtn = document.getElementById('awayTimeoutDec');
  const awayTimeoutIncBtn = document.getElementById('awayTimeoutInc');
  const awayTimeoutCountInput = document.getElementById('awayTimeoutCount');

  function updateTimeoutDisplay(countInput, count) {
    let maxTimeouts;
    if (currentSport === 'football') {
      maxTimeouts = MAX_TIMEOUTS_FOOTBALL;
    } else if (currentSport === 'volleyball') {
      maxTimeouts = MAX_TIMEOUTS_VOLLEYBALL;
    } else {
      maxTimeouts = MAX_TIMEOUTS;
    }
    
    countInput.value = count;
    // Disable decrement if count == 0
    if (count === 0) {
      if (countInput.id === 'homeTimeoutCount') homeTimeoutDecBtn.disabled = true;
      else awayTimeoutDecBtn.disabled = true;
    } else {
      if (countInput.id === 'homeTimeoutCount') homeTimeoutDecBtn.disabled = false;
      else awayTimeoutDecBtn.disabled = false;
    }
    // Disable increment if count == maxTimeouts
    if (count === maxTimeouts) {
      if (countInput.id === 'homeTimeoutCount') homeTimeoutIncBtn.disabled = true;
      else awayTimeoutIncBtn.disabled = true;
    } else {
      if (countInput.id === 'homeTimeoutCount') homeTimeoutIncBtn.disabled = false;
      else awayTimeoutIncBtn.disabled = false;
    }
  }

  homeTimeoutDecBtn.addEventListener('click', async () => {
    if (homeTimeoutsLeft > 0) {
      homeTimeoutsLeft--;
      updateTimeoutDisplay(homeTimeoutCountInput, homeTimeoutsLeft);
      await saveScoreboardState();
    }
  });
  homeTimeoutIncBtn.addEventListener('click', async () => {
    let maxTimeouts;
    if (currentSport === 'football') {
      maxTimeouts = MAX_TIMEOUTS_FOOTBALL;
    } else if (currentSport === 'volleyball') {
      maxTimeouts = MAX_TIMEOUTS_VOLLEYBALL;
    } else {
      maxTimeouts = MAX_TIMEOUTS;
    }
    if (homeTimeoutsLeft < maxTimeouts) {
      homeTimeoutsLeft++;
      updateTimeoutDisplay(homeTimeoutCountInput, homeTimeoutsLeft);
      await saveScoreboardState();
    }
  });

  awayTimeoutDecBtn.addEventListener('click', async () => {
    if (awayTimeoutsLeft > 0) {
      awayTimeoutsLeft--;
      updateTimeoutDisplay(awayTimeoutCountInput, awayTimeoutsLeft);
      await saveScoreboardState();
    }
  });
  awayTimeoutIncBtn.addEventListener('click', async () => {
    let maxTimeouts;
    if (currentSport === 'football') {
      maxTimeouts = MAX_TIMEOUTS_FOOTBALL;
    } else if (currentSport === 'volleyball') {
      maxTimeouts = MAX_TIMEOUTS_VOLLEYBALL;
    } else {
      maxTimeouts = MAX_TIMEOUTS;
    }
    if (awayTimeoutsLeft < maxTimeouts) {
      awayTimeoutsLeft++;
      updateTimeoutDisplay(awayTimeoutCountInput, awayTimeoutsLeft);
      await saveScoreboardState();
    }
  });

  // Initialize display on load and from saved state
  function initTimeoutDisplays() {
    updateTimeoutDisplay(homeTimeoutCountInput, homeTimeoutsLeft);
    updateTimeoutDisplay(awayTimeoutCountInput, awayTimeoutsLeft);
  }

  // Initial scores
  let homeScore = 0;
  let awayScore = 0;


  // Period logic: use internal raw periods, display formatted
  const periods = ['1st','2nd','HALF','3rd','4th','FINAL','OT1','OT2','OT3','OT4'];

  function formatPeriod(period) {
    // Periods are now already formatted, just return as-is
    return period || '';
  }


  periodPrevBtn.addEventListener('click', async () => {
    let currentPeriod = periodInput.value.trim();
    let idx = periods.indexOf(currentPeriod);
    if (idx === -1) {
      // If not found, try to find a case-insensitive match
      idx = periods.findIndex(p => p.toLowerCase() === currentPeriod.toLowerCase());
      if (idx === -1) idx = 0;
    }
    if (idx > 0) {
      idx--;
      periodInput.value = periods[idx];

      await saveScoreboardState();
    }
  });
  periodNextBtn.addEventListener('click', async () => {
    let currentPeriod = periodInput.value.trim();
    let idx = periods.indexOf(currentPeriod);
    if (idx === -1) {
      // If not found, try to find a case-insensitive match
      idx = periods.findIndex(p => p.toLowerCase() === currentPeriod.toLowerCase());
      if (idx === -1) idx = 0;
    }
    if (idx < periods.length - 1) {
      idx++;
      periodInput.value = periods[idx];

      await saveScoreboardState();
    }
  });

  periodInput.addEventListener('change', async () => {

    await saveScoreboardState();
  });

  // Clock functionality
  function parseClockTime(timeStr) {
    const parts = timeStr.split(':');
    if (parts.length !== 2) return { minutes: 12, seconds: 0 };
    
    const minutes = parseInt(parts[0], 10) || 0;
    const seconds = parseInt(parts[1], 10) || 0;
    
    return { minutes: Math.max(0, minutes), seconds: Math.max(0, Math.min(60, seconds)) };
  }
  
  function formatClockTime(minutes, seconds) {
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }
  
  function startClock() {
    if (clockRunning || clockInterval) return;
    
    clockRunning = true;
    clockStartPauseBtn.textContent = 'Pause';
    
    clockInterval = setInterval(() => {
      const { minutes, seconds } = parseClockTime(clockInput.value);
      
      if (minutes === 0 && seconds === 0) {
        // Clock reached 0:00, stop the clock
        stopClock();
        return;
      }
      
      let newSeconds = seconds - 1;
      let newMinutes = minutes;
      
      if (newSeconds < 0) {
        newSeconds = 59;
        newMinutes = Math.max(0, minutes - 1);
      }
      
      clockTime = formatClockTime(newMinutes, newSeconds);
      clockInput.value = clockTime;
      saveScoreboardState();
    }, 1000);
  }
  
  function stopClock() {
    clockRunning = false;
    clockStartPauseBtn.textContent = 'Start';
    
    if (clockInterval) {
      clearInterval(clockInterval);
      clockInterval = null;
    }
  }
  
  function resetClock() {
    stopClock();
    
    // Reset to default time based on sport
    let defaultTime = '08:00';
    if (currentSport === 'football') {
      defaultTime = '12:00';
    }
    
    clockTime = defaultTime;
    clockInput.value = clockTime;
    saveScoreboardState();
  }
  
  // Clock button event handlers
  clockStartPauseBtn.addEventListener('click', async () => {
    if (clockRunning) {
      stopClock();
    } else {
      startClock();
    }
    await saveScoreboardState();
  });
  
  clockResetBtn.addEventListener('click', async () => {
    resetClock();
    await saveScoreboardState();
  });
  
  // Clock input change handler
  clockInput.addEventListener('change', async () => {
    const { minutes, seconds } = parseClockTime(clockInput.value);
    clockTime = formatClockTime(minutes, seconds);
    clockInput.value = clockTime;
    await saveScoreboardState();
  });
  
  // Prevent invalid input in clock field
  clockInput.addEventListener('input', (e) => {
    let value = e.target.value;
    // Allow only numbers and colons
    value = value.replace(/[^\d:]/g, '');
    
    // Ensure proper format (M:SS or MM:SS)
    if (value.length === 4 && !value.includes(':')) {
      value = value.substring(0, 2) + ':' + value.substring(2);
    }
    
    e.target.value = value;
  });

  // Clock adjustment button handlers
  const clockMinIncBtn = document.getElementById('clockMinInc');
  const clockMinDecBtn = document.getElementById('clockMinDec');
  const clockSecIncBtn = document.getElementById('clockSecInc');
  const clockSecDecBtn = document.getElementById('clockSecDec');

  if (clockMinIncBtn) {
    clockMinIncBtn.addEventListener('click', async () => {
      const { minutes, seconds } = parseClockTime(clockInput.value);
      const newMinutes = Math.min(99, minutes + 1);
      clockTime = formatClockTime(newMinutes, seconds);
      clockInput.value = clockTime;
      await saveScoreboardState();
    });
  }

  if (clockMinDecBtn) {
    clockMinDecBtn.addEventListener('click', async () => {
      const { minutes, seconds } = parseClockTime(clockInput.value);
      const newMinutes = Math.max(0, minutes - 1);
      clockTime = formatClockTime(newMinutes, seconds);
      clockInput.value = clockTime;
      await saveScoreboardState();
    });
  }

  if (clockSecIncBtn) {
    clockSecIncBtn.addEventListener('click', async () => {
      const { minutes, seconds } = parseClockTime(clockInput.value);
      let newSeconds = seconds + 1;
      let newMinutes = minutes;
      
      if (newSeconds >= 60) {
        newSeconds = 0;
        newMinutes = Math.min(99, minutes + 1);
      }
      
      clockTime = formatClockTime(newMinutes, newSeconds);
      clockInput.value = clockTime;
      await saveScoreboardState();
    });
  }

  if (clockSecDecBtn) {
    clockSecDecBtn.addEventListener('click', async () => {
      const { minutes, seconds } = parseClockTime(clockInput.value);
      let newSeconds = seconds - 1;
      let newMinutes = minutes;
      
      if (newSeconds < 0 && newMinutes > 0) {
        newSeconds = 59;
        newMinutes = minutes - 1;
      } else if (newSeconds < 0 && newMinutes === 0) {
        newSeconds = 0;
      }
      
      clockTime = formatClockTime(newMinutes, newSeconds);
      clockInput.value = clockTime;
      await saveScoreboardState();
    });
  }

  // NEW GAME button handler with custom modal
  const newGameModal = document.getElementById('newGameModal');
  const confirmNewGameBtn = document.getElementById('confirmNewGame');
  const cancelNewGameBtn = document.getElementById('cancelNewGame');

  function showNewGameModal() {
    newGameModal.classList.add('show');
  }

  function hideNewGameModal() {
    newGameModal.classList.remove('show');
  }

  confirmNewGameBtn.addEventListener('click', async () => {
    hideNewGameModal();

    // Reset scores to 0
    homeScore = 0;
    awayScore = 0;

    // Reset period to 1st
    periodInput.value = '1st';
    
    // Reset clock
    resetClock();

    // Reset timeouts to sport-specific maximum for both teams
    let maxTimeouts;
    if (currentSport === 'football') {
      maxTimeouts = MAX_TIMEOUTS_FOOTBALL;
    } else if (currentSport === 'volleyball') {
      maxTimeouts = MAX_TIMEOUTS_VOLLEYBALL;
    } else {
      maxTimeouts = MAX_TIMEOUTS;
    }
    homeTimeoutsLeft = maxTimeouts;
    awayTimeoutsLeft = maxTimeouts;
    updateTimeoutDisplay(homeTimeoutCountInput, homeTimeoutsLeft);
    updateTimeoutDisplay(awayTimeoutCountInput, awayTimeoutsLeft);

    // Save the new state
    await saveScoreboardState();
  });

  cancelNewGameBtn.addEventListener('click', () => {
    hideNewGameModal();
  });

  // Close modal when clicking outside of it
  newGameModal.addEventListener('click', (e) => {
    if (e.target === newGameModal) {
      hideNewGameModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && newGameModal.classList.contains('show')) {
      hideNewGameModal();
    }
    if (e.key === 'Escape' && editModal.classList.contains('show')) {
      hideEditModal();
    }
  });

  // Edit Modal functionality
  const editModal = document.getElementById('editModal');
  const editModalTitle = document.getElementById('editModalTitle');
  const editModalContent = document.getElementById('editModalContent');
  const editModalClose = document.getElementById('editModalClose');

  function showEditModal(graphicType) {
    editModalTitle.textContent = `Edit ${graphicType.charAt(0).toUpperCase() + graphicType.slice(1)}`;
    
    // Generate content based on graphic type
    let content = '';
    switch(graphicType) {
      case 'lowerthird':
        content = `
          <div class="edit-input-group">
            <label>TEAM:</label>
            <div class="edit-team-toggle-group">
              <button class="edit-team-toggle-btn ${selectedTeam === 'home' ? 'active' : ''}" data-team="home">HOME</button>
              <button class="edit-team-toggle-btn ${selectedTeam === 'away' ? 'active' : ''}" data-team="away">AWAY</button>
              <button class="edit-team-toggle-btn ${selectedTeam === 'Default' ? 'active' : ''}" data-team="csn">GENERIC</button>
            </div>
          </div>
          <div class="edit-input-group">
            <label for="editLowerThirdName">NAME:</label>
            <input type="text" id="editLowerThirdName" value="${lowerThirdNameInput ? lowerThirdNameInput.value : ''}" placeholder="Enter name">
          </div>
          <div class="edit-input-group">
            <label for="editLowerThirdTitle">TITLE:</label>
            <input type="text" id="editLowerThirdTitle" value="${lowerThirdTitleInput ? lowerThirdTitleInput.value : ''}" placeholder="Enter title">
          </div>
        `;
        break;
      case 'talent':
        content = `
          <div class="edit-input-group">
            <label style="font-weight: bold; margin-bottom: 15px; display: block;">LEFT TALENT:</label>
            <div style="margin-left: 20px;">
              <div class="edit-input-group">
                <label for="editTalentLeftName">NAME:</label>
                <input type="text" id="editTalentLeftName" value="${talentLeftNameInput ? talentLeftNameInput.value : ''}" placeholder="Enter left talent name">
              </div>
              <div class="edit-input-group">
                <label for="editTalentLeftTitle">TITLE:</label>
                <input type="text" id="editTalentLeftTitle" value="${talentLeftTitleInput ? talentLeftTitleInput.value : ''}" placeholder="Enter left talent title">
              </div>
            </div>
          </div>
          <div class="edit-input-group">
            <label style="font-weight: bold; margin-bottom: 15px; display: block;">RIGHT TALENT:</label>
            <div style="margin-left: 20px;">
              <div class="edit-input-group">
                <label for="editTalentRightName">NAME:</label>
                <input type="text" id="editTalentRightName" value="${talentRightNameInput ? talentRightNameInput.value : ''}" placeholder="Enter right talent name">
              </div>
              <div class="edit-input-group">
                <label for="editTalentRightTitle">TITLE:</label>
                <input type="text" id="editTalentRightTitle" value="${talentRightTitleInput ? talentRightTitleInput.value : ''}" placeholder="Enter right talent title">
              </div>
            </div>
          </div>
        `;
        break;
      case 'leftslab':
        content = `
          <div class="edit-input-group">
            <label for="editLeftSlabTitle">TITLE 1:</label>
            <input type="text" id="editLeftSlabTitle" value="${leftSlabTitleInput ? leftSlabTitleInput.value : ''}" placeholder="Enter first title line">
          </div>
          <div class="edit-input-group">
            <label for="editLeftSlabTitle2">TITLE 2:</label>
            <input type="text" id="editLeftSlabTitle2" value="${leftSlabTitle2Input ? leftSlabTitle2Input.value : ''}" placeholder="Enter second title line">
          </div>
          <div class="edit-input-group">
            <label style="font-weight: bold; margin-bottom: 10px; display: block;">SECTIONS:</label>
            <button class="edit-add-section-btn" id="editAddLeftSlabSection">+ Add Section</button>
            <div id="editLeftSlabSectionsList">
              ${generateLeftSlabSectionsHTML()}
            </div>
          </div>
        `;
        break;
      case 'tombstone':
        content = `
          <div class="edit-input-group">
            <label>TEAM:</label>
            <div class="edit-team-toggle-group">
              <button class="edit-team-toggle-btn ${selectedTombstoneTeam === 'home' ? 'active' : ''}" data-tombstone-team="home">HOME</button>
              <button class="edit-team-toggle-btn ${selectedTombstoneTeam === 'away' ? 'active' : ''}" data-tombstone-team="away">AWAY</button>
              <button class="edit-team-toggle-btn ${selectedTombstoneTeam === 'weather' ? 'active' : ''}" data-tombstone-team="weather">Weather</button>
            </div>
          </div>
          
          <!-- Weather inputs - shown when weather team is selected -->
          <div id="editTombstoneWeatherInputs" style="display: ${selectedTombstoneTeam === 'weather' ? 'block' : 'none'};">
            <div class="edit-input-group">
              <label for="editWeatherTemp">Temperature:</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" id="editWeatherTemp" value="${document.getElementById('weatherTemp') ? document.getElementById('weatherTemp').value : ''}" placeholder="72" style="width: 50px; padding: 10px 12px; font-size: 14px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
                <span style="color: #eee; font-size: 14px;">°F</span>
              </div>
            </div>
            <div class="edit-input-group">
              <label for="editWeatherFeelsLike">Feels like:</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" id="editWeatherFeelsLike" value="${document.getElementById('weatherFeelsLike') ? document.getElementById('weatherFeelsLike').value : ''}" placeholder="75" style="width: 50px; padding: 10px 12px; font-size: 14px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
                <span style="color: #eee; font-size: 14px;">°F</span>
              </div>
            </div>
            <div class="edit-input-group">
              <label for="editWeatherHumidity">Humidity:</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" id="editWeatherHumidity" value="${document.getElementById('weatherHumidity') ? document.getElementById('weatherHumidity').value : ''}" placeholder="65" min="0" max="100" style="width: 50px; padding: 10px 12px; font-size: 14px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
                <span style="color: #eee; font-size: 14px;">%</span>
              </div>
            </div>
            <div class="edit-input-group">
              <label for="editWeatherWind">Wind:</label>
              <input type="text" id="editWeatherWind" value="${document.getElementById('weatherWind') ? document.getElementById('weatherWind').value : ''}" placeholder="8 mph NW">
            </div>
            <div class="edit-input-group">
              <label for="editWeatherUVIndex">UV Index:</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" id="editWeatherUVIndex" value="${document.getElementById('weatherUVIndex') ? document.getElementById('weatherUVIndex').value : ''}" placeholder="3" min="0" max="11" style="width: 50px; padding: 10px 12px; font-size: 14px; border-radius: 4px; border: none; background: #444; color: #eee; font-family: inherit; box-sizing: border-box;">
                <span style="color: #eee; font-size: 14px;">/11</span>
              </div>
            </div>
          </div>

          <!-- Custom sections - shown when home/away team is selected -->
          <div id="editTombstoneCustomSections" style="display: ${selectedTombstoneTeam === 'weather' ? 'none' : 'block'};">
            <div class="edit-input-group">
              <label style="font-weight: bold; margin-bottom: 10px; display: block;">SECTIONS:</label>
              <button class="edit-add-section-btn" id="editAddTombstoneSection">+ Add Section</button>
              <div id="editTombstoneSectionsList">
                ${generateTombstoneSectionsHTML()}
              </div>
            </div>
          </div>
        `;
        break;
      case 'fullscreen':
        content = `
          <div class="edit-input-group">
            <label style="font-weight: bold; color: #fff; margin-bottom: 15px; display: block;">ROUND 1 GAMES (8 Games - 16 Teams)</label>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 14px;">Enter the teams for each Round 1 game.</p>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            ${Array.from({length: 16}, (_, i) => `
              <div class="edit-input-group">
                <label for="bracketTeam${i + 1}">Game ${Math.floor(i / 2) + 1} - Team ${(i % 2) + 1}:</label>
                <input type="text" id="bracketTeam${i + 1}" value="${bracketTeams[i] || ''}" placeholder="Enter team name">
              </div>
            `).join('')}
          </div>
          <div class="edit-input-group" style="margin-top: 30px;">
            <label style="font-weight: bold; color: #fff; margin-bottom: 15px; display: block;">ROUND 2 GAMES (3 Games - 6 Teams)</label>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 14px;">Enter the teams for each Round 2 game.</p>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            ${Array.from({length: 6}, (_, i) => `
              <div class="edit-input-group">
                <label for="bracketRound2Team${i + 1}">Game ${Math.floor(i / 2) + 1} - Team ${(i % 2) + 1}:</label>
                <input type="text" id="bracketRound2Team${i + 1}" value="${bracketTeams[16 + i] || ''}" placeholder="Enter team name">
              </div>
            `).join('')}
          </div>
        `;
        break;
      default:
        content = '<p>No editable properties available for this graphic.</p>';
    }
    
    editModalContent.innerHTML = content;
    setupEditModalHandlers(graphicType);
    editModal.classList.add('show');
  }

  function generateLeftSlabSectionsHTML() {
    return leftSlabSections.map(section => `
      <div class="edit-section-item" data-section-id="${section.id}">
        <button class="edit-section-remove-btn">×</button>
        <div class="edit-input-group">
          <label>TITLE:</label>
          <input type="text" class="edit-section-title" value="${section.title}" placeholder="Enter section title">
        </div>
      </div>
    `).join('');
  }

  function generateTombstoneSectionsHTML() {
    return tombstoneSections.map(section => `
      <div class="edit-section-item" data-section-id="${section.id}">
        <button class="edit-section-remove-btn">×</button>
        <div class="edit-input-group">
          <label>TITLE:</label>
          <input type="text" class="edit-section-title" value="${section.title}" placeholder="Enter section title">
        </div>
      </div>
    `).join('');
  }

  function setupEditModalHandlers(graphicType) {
    // Setup handlers based on graphic type
    switch(graphicType) {
      case 'lowerthird':
        setupLowerThirdEditHandlers();
        break;
      case 'talent':
        setupTalentEditHandlers();
        break;
      case 'leftslab':
        setupLeftSlabEditHandlers();
        break;
      case 'tombstone':
        setupTombstoneEditHandlers();
        break;
      case 'fullscreen':
        setupFullscreenEditHandlers();
        break;
    }
  }

  function setupLowerThirdEditHandlers() {
    // Team toggle buttons
    const teamToggles = editModalContent.querySelectorAll('[data-team]');
    teamToggles.forEach(btn => {
      btn.addEventListener('click', () => {
        const team = btn.dataset.team;
        selectedTeam = team;
        teamToggles.forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        
        // Update original toggles
        if (team === 'home') {
          homeTeamToggle.classList.add('active');
          awayTeamToggle.classList.remove('active');
          csnTeamToggle.classList.remove('active');
        } else if (team === 'away') {
          awayTeamToggle.classList.add('active');
          homeTeamToggle.classList.remove('active');
          csnTeamToggle.classList.remove('active');
        } else if (team === 'Default') {
          csnTeamToggle.classList.add('active');
          homeTeamToggle.classList.remove('active');
          awayTeamToggle.classList.remove('active');
        }
        
        saveScoreboardState();
      });
    });

    // Input handlers
    const nameInput = document.getElementById('editLowerThirdName');
    const titleInput = document.getElementById('editLowerThirdTitle');
    
    nameInput.addEventListener('input', () => {
      lowerThirdNameInput.value = nameInput.value;
      saveScoreboardState();
    });
    
    titleInput.addEventListener('input', () => {
      lowerThirdTitleInput.value = titleInput.value;
      saveScoreboardState();
    });
  }

  function setupTalentEditHandlers() {
    const leftNameInput = document.getElementById('editTalentLeftName');
    const leftTitleInput = document.getElementById('editTalentLeftTitle');
    const rightNameInput = document.getElementById('editTalentRightName');
    const rightTitleInput = document.getElementById('editTalentRightTitle');
    
    leftNameInput.addEventListener('input', () => {
      talentLeftNameInput.value = leftNameInput.value;
      saveScoreboardState();
    });
    
    leftTitleInput.addEventListener('input', () => {
      talentLeftTitleInput.value = leftTitleInput.value;
      saveScoreboardState();
    });
    
    rightNameInput.addEventListener('input', () => {
      talentRightNameInput.value = rightNameInput.value;
      saveScoreboardState();
    });
    
    rightTitleInput.addEventListener('input', () => {
      talentRightTitleInput.value = rightTitleInput.value;
      saveScoreboardState();
    });
  }

  function setupLeftSlabEditHandlers() {
    const titleInput = document.getElementById('editLeftSlabTitle');
    const title2Input = document.getElementById('editLeftSlabTitle2');
    const addSectionBtn = document.getElementById('editAddLeftSlabSection');
    const sectionsList = document.getElementById('editLeftSlabSectionsList');
    
    titleInput.addEventListener('input', () => {
      leftSlabTitleInput.value = titleInput.value;
      saveScoreboardState();
    });
    
    title2Input.addEventListener('input', () => {
      leftSlabTitle2Input.value = title2Input.value;
      saveScoreboardState();
    });
    
    addSectionBtn.addEventListener('click', () => {
      const newSection = { id: `section_${leftSlabSectionIdCounter++}`, title: '', subtext: '' };
      leftSlabSections.push(newSection);
      
      const sectionHTML = `
        <div class="edit-section-item" data-section-id="${newSection.id}">
          <button class="edit-section-remove-btn">×</button>
          <div class="edit-input-group">
            <label>TITLE:</label>
            <input type="text" class="edit-section-title" value="" placeholder="Enter section title">
          </div>
        </div>
      `;
      sectionsList.insertAdjacentHTML('beforeend', sectionHTML);
      
      // Add event listeners to new section
      const newSectionElement = sectionsList.lastElementChild;
      setupSectionHandlers(newSectionElement, 'leftslab');
      
      // Also add to main UI
      const mainSectionElement = createLeftSlabSection('', '', newSection.id);
      document.getElementById('leftSlabSectionsList').appendChild(mainSectionElement);
      
      saveScoreboardState();
    });
    
    // Setup existing sections
    sectionsList.querySelectorAll('.edit-section-item').forEach(item => {
      setupSectionHandlers(item, 'leftslab');
    });
  }

  function setupTombstoneEditHandlers() {
    // Team toggle buttons
    const teamToggles = editModalContent.querySelectorAll('[data-tombstone-team]');
    teamToggles.forEach(btn => {
      btn.addEventListener('click', () => {
        const team = btn.dataset.tombstoneTeam;
        selectedTombstoneTeam = team;
        teamToggles.forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        
        // Update visibility in edit modal
        const editWeatherInputs = document.getElementById('editTombstoneWeatherInputs');
        const editCustomSections = document.getElementById('editTombstoneCustomSections');
        if (team === 'weather') {
          editWeatherInputs.style.display = 'block';
          editCustomSections.style.display = 'none';
        } else {
          editWeatherInputs.style.display = 'none';
          editCustomSections.style.display = 'block';
        }
        
        // Update original toggles
        if (team === 'home') {
          tombstoneHomeTeamToggle.classList.add('active');
          tombstoneAwayTeamToggle.classList.remove('active');
          tombstoneWeatherTeamToggle.classList.remove('active');
        } else if (team === 'away') {
          tombstoneAwayTeamToggle.classList.add('active');
          tombstoneHomeTeamToggle.classList.remove('active');
          tombstoneWeatherTeamToggle.classList.remove('active');
        } else if (team === 'weather') {
          tombstoneWeatherTeamToggle.classList.add('active');
          tombstoneHomeTeamToggle.classList.remove('active');
          tombstoneAwayTeamToggle.classList.remove('active');
        }
        
        updateTombstoneInputVisibility();
        saveScoreboardState();
      });
    });

    // Weather input handlers
    const weatherInputIds = ['editWeatherTemp', 'editWeatherFeelsLike', 'editWeatherHumidity', 'editWeatherWind', 'editWeatherUVIndex'];
    const originalWeatherInputIds = ['weatherTemp', 'weatherFeelsLike', 'weatherHumidity', 'weatherWind', 'weatherUVIndex'];
    
    weatherInputIds.forEach((editId, index) => {
      const editInput = document.getElementById(editId);
      const originalInput = document.getElementById(originalWeatherInputIds[index]);
      
      if (editInput && originalInput) {
        editInput.addEventListener('input', () => {
          originalInput.value = editInput.value;
          saveScoreboardState();
        });
      }
    });

    const addSectionBtn = document.getElementById('editAddTombstoneSection');
    const sectionsList = document.getElementById('editTombstoneSectionsList');
    
    addSectionBtn.addEventListener('click', () => {
      const newSection = { id: `tombstone_section_${tombstoneSectionIdCounter++}`, title: '', subtext: '' };
      tombstoneSections.push(newSection);
      
      const sectionHTML = `
        <div class="edit-section-item" data-section-id="${newSection.id}">
          <button class="edit-section-remove-btn">×</button>
          <div class="edit-input-group">
            <label>TITLE:</label>
            <input type="text" class="edit-section-title" value="" placeholder="Enter section title">
          </div>
        </div>
      `;
      sectionsList.insertAdjacentHTML('beforeend', sectionHTML);
      
      // Add event listeners to new section
      const newSectionElement = sectionsList.lastElementChild;
      setupSectionHandlers(newSectionElement, 'tombstone');
      
      // Also add to main UI
      const mainSectionElement = createTombstoneSection('', '', newSection.id);
      document.getElementById('tombstoneSectionsList').appendChild(mainSectionElement);
      
      saveScoreboardState();
    });
    
    // Setup existing sections
    sectionsList.querySelectorAll('.edit-section-item').forEach(item => {
      setupSectionHandlers(item, 'tombstone');
    });
  }

  function setupSectionHandlers(sectionElement, type) {
    const sectionId = sectionElement.dataset.sectionId;
    const titleInput = sectionElement.querySelector('.edit-section-title');
    const removeBtn = sectionElement.querySelector('.edit-section-remove-btn');
    
    titleInput.addEventListener('input', () => {
      const sections = type === 'leftslab' ? leftSlabSections : tombstoneSections;
      const sectionIndex = sections.findIndex(s => s.id === sectionId);
      if (sectionIndex !== -1) {
        sections[sectionIndex].title = titleInput.value;
        
        // Update main UI
        const mainSectionInput = document.querySelector(`[data-section-id="${sectionId}"] .section-title`);
        if (mainSectionInput) {
          mainSectionInput.value = titleInput.value;
        }
        
        saveScoreboardState();
      }
    });
    
    removeBtn.addEventListener('click', () => {
      if (type === 'leftslab') {
        leftSlabSections = leftSlabSections.filter(s => s.id !== sectionId);
      } else {
        tombstoneSections = tombstoneSections.filter(s => s.id !== sectionId);
      }
      
      // Remove from main UI
      const mainSectionElement = document.querySelector(`#${type}SectionsList [data-section-id="${sectionId}"]`);
      if (mainSectionElement) {
        mainSectionElement.remove();
      }
      
      // Remove from modal
      sectionElement.remove();
      
      saveScoreboardState();
    });
  }

  function hideEditModal() {
    editModal.classList.remove('show');
  }

  // Edit button click handlers
  document.getElementById('scorebarEditBtn').addEventListener('click', () => {
    // Show appropriate stats modal based on current sport
    if (currentSport === 'football') {
      showFootballStatsModal();
    } else if (currentSport === 'volleyball') {
      showVolleyballStatsModal();
    }
  });

  document.getElementById('miniBugEditBtn').addEventListener('click', () => {
    // Mini Bug has no editable elements, so this is disabled  
  });

  document.getElementById('locatorEditBtn').addEventListener('click', () => {
    // Locator has no editable elements, so this is disabled
  });

  document.getElementById('lowerThirdEditBtn').addEventListener('click', () => {
    showEditModal('lowerthird');
  });

  document.getElementById('talentEditBtn').addEventListener('click', () => {
    showEditModal('talent');
  });

  document.getElementById('leftSlabEditBtn').addEventListener('click', () => {
    showEditModal('leftslab');
  });

  document.getElementById('tombstoneEditBtn').addEventListener('click', () => {
    showEditModal('tombstone');
  });

  document.getElementById('fullscreenEditBtn').addEventListener('click', () => {
    showEditModal('fullscreen');
  });

  // Close edit modal handlers
  editModalClose.addEventListener('click', hideEditModal);

  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) {
      hideEditModal();
    }
  });

  // Disable edit buttons for graphics with no editable elements
  function updateEditButtonStates() {
    // Enable scorebar edit for football and volleyball, disable for other sports
    document.getElementById('scorebarEditBtn').disabled = currentSport !== 'football' && currentSport !== 'volleyball';
    document.getElementById('miniBugEditBtn').disabled = true;
    document.getElementById('locatorEditBtn').disabled = true;
    document.getElementById('lowerThirdEditBtn').disabled = false;
    document.getElementById('talentEditBtn').disabled = false;
    document.getElementById('leftSlabEditBtn').disabled = false;
    document.getElementById('tombstoneEditBtn').disabled = false;
    document.getElementById('fullscreenEditBtn').disabled = false;
  }

  // Football stats management
  let footballStats = {};
  let currentDisplayedStat = null;
  let statDisplayVisible = false;
  
  // Volleyball stats management
  let volleyballStats = {};
  
  // Football stats modal elements
  const footballStatsModal = document.getElementById('footballStatsModal');
  const footballStatsModalClose = document.getElementById('footballStatsModalClose');
  const statSelect = document.getElementById('statSelect');
  const statsInputSection = document.getElementById('statsInputSection');
  const homeStatLabel = document.getElementById('homeStatLabel');
  const awayStatLabel = document.getElementById('awayStatLabel');
  const homeStatValue = document.getElementById('homeStatValue');
  const awayStatValue = document.getElementById('awayStatValue');
  const saveStatsBtn = document.getElementById('saveStatsBtn');
  const clearStatsBtn = document.getElementById('clearStatsBtn');
  const currentStatsDisplay = document.getElementById('currentStatsDisplay');
  const statsListDisplay = document.getElementById('statsListDisplay');

  function showFootballStatsModal() {
    updateStatsTeamLabels();
    updateStatsDisplay();
    updateStatDisplayButtons();
    // Update dropdown options for football
    statSelect.innerHTML = `
      <option value="">Choose a statistic...</option>
      <option value="turnovers">Turnovers</option>
      <option value="fumbles">Fumbles</option>
      <option value="interceptions">Interceptions</option>
      <option value="rushing_yards">Rushing Yards</option>
      <option value="passing_yards">Passing Yards</option>
      <option value="total_yards">Total Yards</option>
      <option value="touchdowns">Touchdowns</option>
      <option value="field_goals">Field Goals</option>
      <option value="first_downs">First Downs</option>
      <option value="penalties">Penalties</option>
      <option value="penalty_yards">Penalty Yards</option>
      <option value="sacks">Sacks</option>
      <option value="time_of_possession">Time of Possession</option>
    `;
    footballStatsModal.classList.add('show');
  }

  function showVolleyballStatsModal() {
    updateStatsTeamLabels();
    updateVolleyballStatsDisplay();
    updateStatDisplayButtons();
    // Update dropdown options for volleyball
    statSelect.innerHTML = `
      <option value="">Choose a statistic...</option>
      <option value="sets_Won">Sets Won</option>
      <option value="kills">Kills</option>
      <option value="digs">Digs</option>
      <option value="blocks">Blocks</option>
      <option value="aces">Aces</option>
      <option value="assists">Assists</option>
      <option value="errors">Errors</option>
      <option value="hitting_percentage">Hitting %</option>
      <option value="service_errors">Service Errors</option>
    `;
    footballStatsModal.classList.add('show');
  }

  function hideFootballStatsModal() {
    footballStatsModal.classList.remove('show');
    statSelect.value = '';
    statsInputSection.style.display = 'none';
    homeStatValue.value = '';
    awayStatValue.value = '';
  }

  function updateStatsTeamLabels() {
    const homeName = homeNameInput.value.trim() || 'Home Team';
    const awayName = awayNameInput.value.trim() || 'Away Team';
    homeStatLabel.textContent = `${homeName}:`;
    awayStatLabel.textContent = `${awayName}:`;
  }

  function updateStatsDisplay() {
    if (Object.keys(footballStats).length === 0) {
      statsListDisplay.innerHTML = '<p style="color: #ccc; text-align: center; font-style: italic;">No statistics entered yet</p>';
      return;
    }

    const homeName = homeNameInput.value.trim() || 'Home Team';
    const awayName = awayNameInput.value.trim() || 'Away Team';
    
    let html = '<div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center; font-size: 14px;">';
    html += `<div style="font-weight: bold; color: #fff;">Statistic</div>`;
    html += `<div style="font-weight: bold; color: #fff; text-align: center;">${homeName}</div>`;
    html += `<div style="font-weight: bold; color: #fff; text-align: center;">${awayName}</div>`;
    
    Object.keys(footballStats).forEach(statKey => {
      const stat = footballStats[statKey];
      const statName = getStatDisplayName(statKey);
      html += `<div style="color: #eee;">${statName}</div>`;
      html += `<div style="color: #eee; text-align: center;">${stat.home || '-'}</div>`;
      html += `<div style="color: #eee; text-align: center;">${stat.away || '-'}</div>`;
    });
    
    html += '</div>';
    statsListDisplay.innerHTML = html;
  }

  function updateVolleyballStatsDisplay() {
    if (Object.keys(volleyballStats).length === 0) {
      statsListDisplay.innerHTML = '<p style="color: #ccc; text-align: center; font-style: italic;">No statistics entered yet</p>';
      return;
    }

    const homeName = homeNameInput.value.trim() || 'Home Team';
    const awayName = awayNameInput.value.trim() || 'Away Team';
    
    let html = '<div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center; font-size: 14px;">';
    html += `<div style="font-weight: bold; color: #fff;">Statistic</div>`;
    html += `<div style="font-weight: bold; color: #fff; text-align: center;">${homeName}</div>`;
    html += `<div style="font-weight: bold; color: #fff; text-align: center;">${awayName}</div>`;
    
    Object.keys(volleyballStats).forEach(statKey => {
      const stat = volleyballStats[statKey];
      const statName = getStatDisplayName(statKey);
      html += `<div style="color: #eee;">${statName}</div>`;
      html += `<div style="color: #eee; text-align: center;">${stat.home || '-'}</div>`;
      html += `<div style="color: #eee; text-align: center;">${stat.away || '-'}</div>`;
    });
    
    html += '</div>';
    statsListDisplay.innerHTML = html;
  }

  function getStatDisplayName(statKey) {
    const displayNames = {
      'turnovers': 'Turnovers',
      'fumbles': 'Fumbles',
      'interceptions': 'Interceptions',
      'rushing_yards': 'Rushing Yards',
      'passing_yards': 'Passing Yards',
      'total_yards': 'Total Yards',
      'touchdowns': 'Touchdowns',
      'field_goals': 'Field Goals',
      'first_downs': 'First Downs',
      'penalties': 'Penalties',
      'penalty_yards': 'Penalty Yards',
      'sacks': 'Sacks',
      'time_of_possession': 'Time of Possession',
      'sets_Won': 'Sets Won',
      'kills': 'Kills',
      'digs': 'Digs',
      'blocks': 'Blocks',
      'aces': 'Aces',
      'assists': 'Assists',
      'errors': 'Errors',
      'hitting_percentage': 'Hitting %',
      'service_errors': 'Service Errors'
    };
    return displayNames[statKey] || statKey;
  }

  // Event listeners for football stats modal
  footballStatsModalClose.addEventListener('click', hideFootballStatsModal);

  footballStatsModal.addEventListener('click', (e) => {
    if (e.target === footballStatsModal) {
      hideFootballStatsModal();
    }
  });

  // ============================================================================
  // XML DATA CONNECTION SYSTEM
  // Fetches scorebug data from external XML sources with auto-refresh
  // ============================================================================
  
  let xmlConnectionInterval = null;
  let xmlConnectionUrl = '';
  let xmlConnectionActive = false;
  
  // XML Connection UI Elements
  const connectXmlBtn = document.getElementById('connectXmlBtn');
  const xmlConnectionCollapsed = document.getElementById('xmlConnectionCollapsed');
  const xmlConnectionExpanded = document.getElementById('xmlConnectionExpanded');
  const xmlUrlInput = document.getElementById('xmlUrlInput');
  const xmlConnectStartBtn = document.getElementById('xmlConnectStartBtn');
  const xmlConnectStopBtn = document.getElementById('xmlConnectStopBtn');
  const xmlConnectCancelBtn = document.getElementById('xmlConnectCancelBtn');
  const xmlStatusDot = document.getElementById('xmlStatusDot');
  const xmlStatusText = document.getElementById('xmlStatusText');
  const xmlDataPreview = document.getElementById('xmlDataPreview');
  const xmlLastUpdate = document.getElementById('xmlLastUpdate');
  const xmlDataFields = document.getElementById('xmlDataFields');
  
  // Show expanded XML connection UI
  connectXmlBtn.addEventListener('click', () => {
    xmlConnectionCollapsed.style.display = 'none';
    xmlConnectionExpanded.style.display = 'block';
  });
  
  // Cancel/collapse XML connection UI
  xmlConnectCancelBtn.addEventListener('click', () => {
    if (!xmlConnectionActive) {
      xmlConnectionExpanded.style.display = 'none';
      xmlConnectionCollapsed.style.display = 'block';
    }
  });
  
  // Start XML connection
  xmlConnectStartBtn.addEventListener('click', async () => {
    const url = xmlUrlInput.value.trim();
    if (!url) {
      showNotification('Please enter an XML URL', 'warning');
      return;
    }
    
    xmlConnectionUrl = url;
    
    // Test the connection first
    try {
      showNotification('Testing XML connection...', 'success');
      const success = await fetchAndParseXML();
      
      if (success) {
        xmlConnectionActive = true;
        xmlConnectStartBtn.style.display = 'none';
        xmlConnectStopBtn.style.display = 'block';
        xmlConnectCancelBtn.style.display = 'none';
        xmlUrlInput.disabled = true;
        
        updateXMLConnectionStatus('connected');
        xmlDataPreview.style.display = 'block';
        
        // Start 3-second auto-refresh
        xmlConnectionInterval = setInterval(fetchAndParseXML, 3000);
        
        showNotification('XML connection established! Auto-refreshing every 3 seconds.', 'success');
      }
    } catch (error) {
      showNotification(`Connection failed: ${error.message}`, 'error');
      updateXMLConnectionStatus('error');
    }
  });
  
  // Stop XML connection
  xmlConnectStopBtn.addEventListener('click', () => {
    stopXMLConnection();
    showNotification('XML connection stopped', 'warning');
  });
  
  function stopXMLConnection() {
    if (xmlConnectionInterval) {
      clearInterval(xmlConnectionInterval);
      xmlConnectionInterval = null;
    }
    
    xmlConnectionActive = false;
    xmlConnectStartBtn.style.display = 'block';
    xmlConnectStopBtn.style.display = 'none';
    xmlConnectCancelBtn.style.display = 'block';
    xmlUrlInput.disabled = false;
    
    updateXMLConnectionStatus('disconnected');
  }
  
  function updateXMLConnectionStatus(status) {
    switch (status) {
      case 'connected':
        xmlStatusDot.style.background = '#27ae60';
        xmlStatusText.textContent = 'Connected';
        xmlStatusText.style.color = '#27ae60';
        break;
      case 'fetching':
        xmlStatusDot.style.background = '#f39c12';
        xmlStatusText.textContent = 'Fetching...';
        xmlStatusText.style.color = '#f39c12';
        break;
      case 'error':
        xmlStatusDot.style.background = '#e74c3c';
        xmlStatusText.textContent = 'Error';
        xmlStatusText.style.color = '#e74c3c';
        break;
      case 'disconnected':
      default:
        xmlStatusDot.style.background = '#666';
        xmlStatusText.textContent = 'Not Connected';
        xmlStatusText.style.color = '#999';
        break;
    }
  }
  
  async function fetchAndParseXML() {
    if (!xmlConnectionUrl) return false;
    
    try {
      updateXMLConnectionStatus('fetching');
      
      const response = await fetch(xmlConnectionUrl);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const text = await response.text();
      
      // Try parsing as XML first, then JSON
      let data = {};
      try {
        // Try XML parsing
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, 'text/xml');
        
        // Check for parse errors
        const parseError = xmlDoc.querySelector('parsererror');
        if (parseError) {
          // Try JSON parsing instead
          data = JSON.parse(text);
        } else {
          // Convert XML to object
          data = xmlToObject(xmlDoc.documentElement);
        }
      } catch (e) {
        // Try JSON parsing as fallback
        try {
          data = JSON.parse(text);
        } catch (jsonErr) {
          throw new Error('Invalid XML or JSON format');
        }
      }
      
      // Apply data to scorebug based on current sport
      applyXMLDataToScorebug(data);
      
      // Update preview
      xmlLastUpdate.textContent = new Date().toLocaleTimeString();
      xmlDataFields.innerHTML = formatDataForPreview(data);
      
      updateXMLConnectionStatus('connected');
      return true;
      
    } catch (error) {
      console.error('[XML Connection] Error:', error);
      updateXMLConnectionStatus('error');
      return false;
    }
  }
  
  // Convert XML DOM to JavaScript object
  function xmlToObject(node) {
    const obj = {};
    
    // Handle text content
    if (node.nodeType === Node.TEXT_NODE) {
      return node.textContent.trim();
    }
    
    // Process child nodes
    for (const child of node.childNodes) {
      if (child.nodeType === Node.ELEMENT_NODE) {
        const key = child.tagName;
        const value = child.childNodes.length === 1 && child.childNodes[0].nodeType === Node.TEXT_NODE
          ? child.textContent.trim()
          : xmlToObject(child);
        
        if (obj[key]) {
          // If key exists, convert to array
          if (!Array.isArray(obj[key])) {
            obj[key] = [obj[key]];
          }
          obj[key].push(value);
        } else {
          obj[key] = value;
        }
      }
    }
    
    return obj;
  }
  
  // Apply XML data to scorebug fields based on sport
  function applyXMLDataToScorebug(data) {
    console.log('[XML Connection] Applying data:', data);
    
    // Flatten nested data if needed
    const flatData = flattenObject(data);
    
    // Common mappings (case-insensitive matching)
    const mappings = {
      // Score fields
      'homescore': updateHomeScore,
      'home_score': updateHomeScore,
      'homepoints': updateHomeScore,
      'awayscore': updateAwayScore,
      'away_score': updateAwayScore,
      'awaypoints': updateAwayScore,
      'visitorscore': updateAwayScore,
      'visitor_score': updateAwayScore,
      
      // Period/Quarter
      'quarter': updatePeriod,
      'period': updatePeriod,
      'qtr': updatePeriod,
      'set': updatePeriod,
      'inning': updatePeriod,
      
      // Clock/Time
      'clock': updateClock,
      'time': updateClock,
      'gameclock': updateClock,
      'game_clock': updateClock,
      
      // Basketball/Football specific - Timeouts
      'hometimeouts': updateHomeTimeouts,
      'home_timeouts': updateHomeTimeouts,
      'hometoremaining': updateHomeTimeouts,
      'awaytimeouts': updateAwayTimeouts,
      'away_timeouts': updateAwayTimeouts,
      'awaytoremaining': updateAwayTimeouts,
      'shotclock': updateShotClock,
      'shot_clock': updateShotClock,
      
      // Football specific
      'down': updateDown,
      'distance': updateDistance,
      'ytg': updateDistance,
      'yards_to_go': updateDistance,
      'ballposition': updateBallPosition,
      'ball_on': updateBallPosition,
      'ballon': updateBallPosition,
      'possession': updatePossession,
      
      // Team names
      'hometeam': updateHomeTeamName,
      'home_team': updateHomeTeamName,
      'homename': updateHomeTeamName,
      'awayteam': updateAwayTeamName,
      'away_team': updateAwayTeamName,
      'awayname': updateAwayTeamName,
      'visitorteam': updateAwayTeamName,
      'visitor_team': updateAwayTeamName
    };
    
    // Create an object to store current XML values for transmission
    const xmlData = {};
    
    // Apply each mapping and store value for state
    for (const [key, value] of Object.entries(flatData)) {
      const lowerKey = key.toLowerCase().replace(/[^a-z0-9_]/g, '');
      if (mappings[lowerKey] && value !== undefined && value !== null && value !== '') {
        try {
          mappings[lowerKey](value);
          xmlData[lowerKey] = value;
        } catch (e) {
          console.warn(`[XML Connection] Failed to apply ${key}:`, e);
        }
      }
    }
    
    // Sync state to graphics window with XML data included
    if (typeof saveScoreboardState === 'function') {
      saveScoreboardState({ xmlData: xmlData });
    }
  }
  
  // Flatten nested object for easier mapping
  function flattenObject(obj, prefix = '') {
    const result = {};
    
    for (const [key, value] of Object.entries(obj)) {
      const newKey = prefix ? `${prefix}_${key}` : key;
      
      if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
        Object.assign(result, flattenObject(value, newKey));
      } else {
        result[newKey] = value;
      }
    }
    
    return result;
  }
  
  // Update functions for scorebug fields
  function updateHomeScore(value) {
    const scoreNum = parseInt(value);
    if (!isNaN(scoreNum)) {
      const homeScoreInput = document.getElementById('homeScoreInput');
      if (homeScoreInput && homeScoreInput.value !== String(scoreNum)) {
        homeScoreInput.value = scoreNum;
        homeScoreInput.dispatchEvent(new Event('input'));
      }
    }
  }
  
  function updateAwayScore(value) {
    const scoreNum = parseInt(value);
    if (!isNaN(scoreNum)) {
      const awayScoreInput = document.getElementById('awayScoreInput');
      if (awayScoreInput && awayScoreInput.value !== String(scoreNum)) {
        awayScoreInput.value = scoreNum;
        awayScoreInput.dispatchEvent(new Event('input'));
      }
    }
  }
  
  function updatePeriod(value) {
    const periodSelect = document.getElementById('periodSelect');
    if (periodSelect) {
      // Try to match period value
      const periodNum = parseInt(value);
      if (!isNaN(periodNum)) {
        for (const option of periodSelect.options) {
          if (option.value === String(periodNum) || option.textContent.includes(String(periodNum))) {
            periodSelect.value = option.value;
            periodSelect.dispatchEvent(new Event('change'));
            break;
          }
        }
      } else {
        // Try text matching (e.g., "1st", "2nd", "HALF")
        for (const option of periodSelect.options) {
          if (option.textContent.toLowerCase().includes(value.toString().toLowerCase())) {
            periodSelect.value = option.value;
            periodSelect.dispatchEvent(new Event('change'));
            break;
          }
        }
      }
    }
  }
  
  function updateClock(value) {
    const clockInput = document.getElementById('clockInput');
    if (clockInput && clockInput.value !== String(value)) {
      clockInput.value = value;
      clockInput.dispatchEvent(new Event('input'));
    }
  }
  
  function updateShotClock(value) {
    const shotClockInput = document.getElementById('shotClockInput');
    if (shotClockInput && shotClockInput.value !== String(value)) {
      shotClockInput.value = value;
      shotClockInput.dispatchEvent(new Event('input'));
    }
  }
  
  function updateDown(value) {
    const downSelect = document.getElementById('downSelect');
    if (downSelect) {
      const downNum = parseInt(value);
      if (!isNaN(downNum) && downNum >= 1 && downNum <= 4) {
        downSelect.value = downNum;
        downSelect.dispatchEvent(new Event('change'));
      }
    }
  }
  
  function updateDistance(value) {
    const distanceInput = document.getElementById('distanceInput');
    if (distanceInput) {
      distanceInput.value = value;
      distanceInput.dispatchEvent(new Event('input'));
    }
  }
  
  function updateBallPosition(value) {
    const ballPositionInput = document.getElementById('ballPositionInput');
    if (ballPositionInput) {
      ballPositionInput.value = value;
      ballPositionInput.dispatchEvent(new Event('input'));
    }
  }
  
  function updatePossession(value) {
    // Try to set possession based on value
    const lowerVal = value.toString().toLowerCase();
    if (lowerVal === 'home' || lowerVal === '1' || lowerVal === 'h') {
      const homePossBtn = document.getElementById('homePossessionBtn');
      if (homePossBtn) homePossBtn.click();
    } else if (lowerVal === 'away' || lowerVal === '2' || lowerVal === 'a' || lowerVal === 'visitor') {
      const awayPossBtn = document.getElementById('awayPossessionBtn');
      if (awayPossBtn) awayPossBtn.click();
    }
  }
  
  function updateHomeTimeouts(value) {
    const timeoutNum = parseInt(value);
    if (!isNaN(timeoutNum) && timeoutNum >= 0) {
      // Clamp to sport-specific maximum
      let maxTimeouts = MAX_TIMEOUTS;
      if (currentSport === 'football') maxTimeouts = MAX_TIMEOUTS_FOOTBALL;
      else if (currentSport === 'volleyball') maxTimeouts = MAX_TIMEOUTS_VOLLEYBALL;
      
      homeTimeoutsLeft = Math.min(Math.max(0, timeoutNum), maxTimeouts);
      const homeTimeoutCountInput = document.getElementById('homeTimeoutCount');
      if (homeTimeoutCountInput) {
        updateTimeoutDisplay(homeTimeoutCountInput, homeTimeoutsLeft);
        // Re-sync button states
        const homeIncBtn = document.getElementById('homeTimeoutIncBtn');
        const homeDecBtn = document.getElementById('homeTimeoutDecBtn');
        if (homeIncBtn) homeIncBtn.disabled = (homeTimeoutsLeft >= maxTimeouts);
        if (homeDecBtn) homeDecBtn.disabled = (homeTimeoutsLeft <= 0);
      }
    }
  }
  
  function updateAwayTimeouts(value) {
    const timeoutNum = parseInt(value);
    if (!isNaN(timeoutNum) && timeoutNum >= 0) {
      // Clamp to sport-specific maximum
      let maxTimeouts = MAX_TIMEOUTS;
      if (currentSport === 'football') maxTimeouts = MAX_TIMEOUTS_FOOTBALL;
      else if (currentSport === 'volleyball') maxTimeouts = MAX_TIMEOUTS_VOLLEYBALL;
      
      awayTimeoutsLeft = Math.min(Math.max(0, timeoutNum), maxTimeouts);
      const awayTimeoutCountInput = document.getElementById('awayTimeoutCount');
      if (awayTimeoutCountInput) {
        updateTimeoutDisplay(awayTimeoutCountInput, awayTimeoutsLeft);
        // Re-sync button states
        const awayIncBtn = document.getElementById('awayTimeoutIncBtn');
        const awayDecBtn = document.getElementById('awayTimeoutDecBtn');
        if (awayIncBtn) awayIncBtn.disabled = (awayTimeoutsLeft >= maxTimeouts);
        if (awayDecBtn) awayDecBtn.disabled = (awayTimeoutsLeft <= 0);
      }
    }
  }
  
  function updateHomeTeamName(value) {
    const homeTeamInput = document.getElementById('homeTeamName');
    if (homeTeamInput && homeTeamInput.value !== String(value)) {
      homeTeamInput.value = value;
      homeTeamInput.dispatchEvent(new Event('input'));
    }
  }
  
  function updateAwayTeamName(value) {
    const awayTeamInput = document.getElementById('awayTeamName');
    if (awayTeamInput && awayTeamInput.value !== String(value)) {
      awayTeamInput.value = value;
      awayTeamInput.dispatchEvent(new Event('input'));
    }
  }
  
  // Format data for preview display
  function formatDataForPreview(data) {
    const flat = flattenObject(data);
    let html = '';
    for (const [key, value] of Object.entries(flat)) {
      if (value !== undefined && value !== null && value !== '') {
        html += `<div><strong>${key}:</strong> ${value}</div>`;
      }
    }
    return html || '<em>No data received</em>';
  }
  
  // Stop XML connection when modal closes
  const originalHideFootballStatsModal = hideFootballStatsModal;
  hideFootballStatsModal = function() {
    // Don't stop connection when closing modal - let it run in background
    originalHideFootballStatsModal();
  };
  
  // ============================================================================
  // END XML DATA CONNECTION SYSTEM
  // ============================================================================

  statSelect.addEventListener('change', () => {
    if (statSelect.value) {
      statsInputSection.style.display = 'block';
      updateStatsTeamLabels();
      
      // Pre-fill with existing values if available
      const stats = currentSport === 'volleyball' ? volleyballStats : footballStats;
      if (stats[statSelect.value]) {
        homeStatValue.value = stats[statSelect.value].home || '';
        awayStatValue.value = stats[statSelect.value].away || '';
      } else {
        homeStatValue.value = '';
        awayStatValue.value = '';
      }
    } else {
      statsInputSection.style.display = 'none';
    }
  });

  // Notification system
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }

  saveStatsBtn.addEventListener('click', async () => {
    const selectedStat = statSelect.value;
    if (!selectedStat) {
      showNotification('Please select a statistic', 'warning');
      return;
    }

    const homeValue = homeStatValue.value.trim();
    const awayValue = awayStatValue.value.trim();

    if (!homeValue && !awayValue) {
      showNotification('Please enter at least one value', 'warning');
      return;
    }

    // Save the stat to appropriate stats object based on sport
    if (currentSport === 'volleyball') {
      if (!volleyballStats[selectedStat]) {
        volleyballStats[selectedStat] = {};
      }
      volleyballStats[selectedStat].home = homeValue;
      volleyballStats[selectedStat].away = awayValue;
      updateVolleyballStatsDisplay();
    } else {
      if (!footballStats[selectedStat]) {
        footballStats[selectedStat] = {};
      }
      footballStats[selectedStat].home = homeValue;
      footballStats[selectedStat].away = awayValue;
      updateStatsDisplay();
    }

    // Save to state with selected stat for display
    currentDisplayedStat = selectedStat;
    await saveScoreboardState();

    showNotification('Statistics saved successfully! You can now display this stat using the In/Out buttons.', 'success');
  });

  clearStatsBtn.addEventListener('click', async () => {
    // Create custom confirmation modal
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay show';
    confirmModal.innerHTML = `
      <div class="modal">
        <h3>Clear All Statistics</h3>
        <p>Are you sure you want to clear all statistics? This action cannot be undone.</p>
        <div class="modal-buttons">
          <button class="modal-btn confirm" id="confirmClearStats">Clear Statistics</button>
          <button class="modal-btn cancel" id="cancelClearStats">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(confirmModal);

    // Handle confirm button
    document.getElementById('confirmClearStats').addEventListener('click', async () => {
      if (currentSport === 'volleyball') {
        volleyballStats = {};
        updateVolleyballStatsDisplay();
      } else {
        footballStats = {};
        updateStatsDisplay();
      }
      await saveScoreboardState();
      showNotification('All statistics cleared.', 'success');
      confirmModal.remove();
    });

    // Handle cancel button
    document.getElementById('cancelClearStats').addEventListener('click', () => {
      confirmModal.remove();
    });

    // Close on overlay click
    confirmModal.addEventListener('click', (e) => {
      if (e.target === confirmModal) {
        confirmModal.remove();
      }
    });
  });

  // Stat display in/out button handlers
  const statDisplayInBtn = document.getElementById('statDisplayInBtn');
  const statDisplayOutBtn = document.getElementById('statDisplayOutBtn');

  function updateStatDisplayButtons() {
    if (statDisplayVisible) {
      statDisplayInBtn.disabled = true;
      statDisplayInBtn.style.opacity = '0.5';
      statDisplayInBtn.style.cursor = 'not-allowed';
      statDisplayInBtn.style.background = '#666';
      statDisplayOutBtn.disabled = false;
      statDisplayOutBtn.style.opacity = '1';
      statDisplayOutBtn.style.cursor = 'pointer';
      statDisplayOutBtn.style.background = '#f44336';
    } else {
      statDisplayInBtn.disabled = false;
      statDisplayInBtn.style.opacity = '1';
      statDisplayInBtn.style.cursor = 'pointer';
      statDisplayInBtn.style.background = '#4CAF50';
      statDisplayOutBtn.disabled = true;
      statDisplayOutBtn.style.opacity = '0.5';
      statDisplayOutBtn.style.cursor = 'not-allowed';
      statDisplayOutBtn.style.background = '#666';
    }
  }

  statDisplayInBtn.addEventListener('click', async () => {
    const selectedStat = statSelect.value;
    if (!selectedStat) {
      showNotification('Please select a statistic first', 'warning');
      return;
    }

    const stats = currentSport === 'volleyball' ? volleyballStats : footballStats;
    if (!stats[selectedStat] || (!stats[selectedStat].home && !stats[selectedStat].away)) {
      showNotification('Please save the statistic values first', 'warning');
      return;
    }

    statDisplayVisible = true;
    currentDisplayedStat = selectedStat;
    updateStatDisplayButtons();
    await saveScoreboardState();
  });

  statDisplayOutBtn.addEventListener('click', async () => {
    statDisplayVisible = false;
    updateStatDisplayButtons();
    await saveScoreboardState();
  });

  // Status bar update functions
  function updateStatusBar() {
    const statusElements = {
      scorebarStatus: scorebarVisible,
      miniBugStatus: miniBugVisible,
      locatorStatus: locatorVisible,
      lowerThirdStatus: lowerThirdVisible,
      talentStatus: talentVisible,
      leftSlabStatus: leftSlabVisible,
      tombstoneStatus: tombstoneVisible,
      fullscreenStatus: fullscreenVisible
    };

    Object.keys(statusElements).forEach(elementId => {
      const element = document.getElementById(elementId);
      if (element) {
        element.classList.remove('active', 'inactive');
        if (statusElements[elementId]) {
          element.classList.add('active');
        } else {
          element.classList.add('inactive');
        }
      }
    });
  }

  // Add click event listeners to status circles
  function setupStatusCircleClickHandlers() {
    document.getElementById('scorebarStatus').addEventListener('click', () => {
      if (scorebarVisible) {
        scorebarOutBtn.click();
      } else {
        scorebarInBtn.click();
      }
    });

    document.getElementById('miniBugStatus').addEventListener('click', () => {
      if (miniBugVisible) {
        miniBugOutBtn.click();
      } else {
        miniBugInBtn.click();
      }
    });

    document.getElementById('locatorStatus').addEventListener('click', () => {
      if (locatorVisible) {
        locatorOutBtn.click();
      } else {
        locatorInBtn.click();
      }
    });

    document.getElementById('lowerThirdStatus').addEventListener('click', () => {
      if (lowerThirdVisible) {
        lowerThirdOutBtn.click();
      } else {
        lowerThirdInBtn.click();
      }
    });

    document.getElementById('talentStatus').addEventListener('click', () => {
      if (talentVisible) {
        talentOutBtn.click();
      } else {
        talentInBtn.click();
      }
    });

    document.getElementById('leftSlabStatus').addEventListener('click', () => {
      if (leftSlabVisible) {
        leftSlabOutBtn.click();
      } else {
        leftSlabInBtn.click();
      }
    });

    document.getElementById('tombstoneStatus').addEventListener('click', () => {
      if (tombstoneVisible) {
        tombstoneOutBtn.click();
      } else {
        tombstoneInBtn.click();
      }
    });

    document.getElementById('fullscreenStatus').addEventListener('click', () => {
      if (fullscreenVisible) {
        fullscreenOutBtn.click();
      } else {
        fullscreenInBtn.click();
      }
    });
  }

  // Scorebar IN/OUT buttons
  function updateScorebarButtons() {
    if (scorebarVisible) {
      scorebarInBtn.classList.add('active');
      scorebarInBtn.disabled = true;
      scorebarOutBtn.classList.remove('active');
      scorebarOutBtn.disabled = false;
    } else {
      scorebarInBtn.classList.remove('active');
      scorebarInBtn.disabled = false;
      scorebarOutBtn.classList.add('active');
      scorebarOutBtn.disabled = true;
    }
    updateStatusBar();
  }

  scorebarInBtn.addEventListener('click', async () => {
    if (miniBugVisible) {
      // First set mini bug to OUT and wait for transition
      miniBugVisible = false;
      updateMiniBugButtons();
      await saveScoreboardState();

      // Wait for mini bug transition to complete (0.5s slide out)
      setTimeout(async () => {
        scorebarVisible = true;
        updateScorebarButtons();
        await saveScoreboardState();
      }, 500);
    } else {
      // No other graphic is visible, transition immediately
      scorebarVisible = true;
      updateScorebarButtons();
      await saveScoreboardState();
    }
  });

  scorebarOutBtn.addEventListener('click', async () => {
    if (statDisplayVisible) {
      // First set stats display to OUT and wait for transition
      statDisplayVisible = false;
      updateStatDisplayButtons();
      await saveScoreboardState();

      // Wait for stats rectangle transition to complete (2s OUT animation)
      setTimeout(async () => {
        scorebarVisible = false;
        updateScorebarButtons();
        await saveScoreboardState();
      }, 2000);
    } else {
      // No stats display visible, hide scorebar immediately
      scorebarVisible = false;
      updateScorebarButtons();
      await saveScoreboardState();
    }
  });

  // Mini Bug IN/OUT buttons
  function updateMiniBugButtons() {
    if (miniBugVisible) {
      miniBugInBtn.classList.add('active');
      miniBugInBtn.disabled = true;
      miniBugOutBtn.classList.remove('active');
      miniBugOutBtn.disabled = false;
    } else {
      miniBugInBtn.classList.remove('active');
      miniBugInBtn.disabled = false;
      miniBugOutBtn.classList.add('active');
      miniBugOutBtn.disabled = true;
    }
    updateStatusBar();
  }

  // Locator button functions
  function updateLocatorButtons() {
    if (locatorVisible) {
      locatorInBtn.classList.add('active');
      locatorInBtn.disabled = true;
      locatorOutBtn.classList.remove('active');
      locatorOutBtn.disabled = false;
    } else {
      locatorInBtn.classList.remove('active');
      locatorInBtn.disabled = false;
      locatorOutBtn.classList.add('active');
      locatorOutBtn.disabled = true;
    }
    updateStatusBar();
  }

  // Lower Third button functions
  function updateLowerThirdButtons() {
    if (lowerThirdVisible) {
      lowerThirdInBtn.classList.add('active');
      lowerThirdInBtn.disabled = true;
      lowerThirdOutBtn.classList.remove('active');
      lowerThirdOutBtn.disabled = false;
    } else {
      lowerThirdInBtn.classList.remove('active');
      lowerThirdInBtn.disabled = false;
      lowerThirdOutBtn.classList.add('active');
      lowerThirdOutBtn.disabled = true;
    }
    updateStatusBar();
  }

  // Talent button functions
  function updateTalentButtons() {
    if (talentVisible) {
      talentInBtn.classList.add('active');
      talentInBtn.disabled = true;
      talentOutBtn.classList.remove('active');
      talentOutBtn.disabled = false;
    } else {
      talentInBtn.classList.remove('active');
      talentInBtn.disabled = false;
      talentOutBtn.classList.add('active');
      talentOutBtn.disabled = true;
    }
    updateStatusBar();
  }

  // Left Slab button functions
  function updateLeftSlabButtons() {
    if (leftSlabVisible) {
      leftSlabInBtn.classList.add('active');
      leftSlabInBtn.disabled = true;
      leftSlabOutBtn.classList.remove('active');
      leftSlabOutBtn.disabled = false;
    } else {
      leftSlabInBtn.classList.remove('active');
      leftSlabInBtn.disabled = false;
      leftSlabOutBtn.classList.add('active');
      leftSlabOutBtn.disabled = true;
    }
    updateStatusBar();
  }

  // Tombstone button functions
  function updateTombstoneButtons() {
    if (tombstoneVisible) {
      tombstoneInBtn.classList.add('active');
      tombstoneInBtn.disabled = true;
      tombstoneOutBtn.classList.remove('active');
      tombstoneOutBtn.disabled = false;
    } else {
      tombstoneInBtn.classList.remove('active');
      tombstoneInBtn.disabled = false;
      tombstoneOutBtn.classList.add('active');
      tombstoneOutBtn.disabled = true;
    }
    updateStatusBar();
  }

  // Fullscreen button functions
  function updateFullscreenButtons() {
    if (fullscreenVisible) {
      fullscreenInBtn.classList.add('active');
      fullscreenInBtn.disabled = true;
      fullscreenOutBtn.classList.remove('active');
      fullscreenOutBtn.disabled = false;
    } else {
      fullscreenInBtn.classList.remove('active');
      fullscreenInBtn.disabled = false;
      fullscreenOutBtn.classList.add('active');
      fullscreenOutBtn.disabled = true;
    }
    updateStatusBar();
  }


  function updateTickerButtons() {
    // Display only - no functionality
    if (tickerInBtn) tickerInBtn.disabled = true;
    if (tickerOutBtn) tickerOutBtn.disabled = true;
  }

  miniBugInBtn.addEventListener('click', async () => {
    if (scorebarVisible) {
      // First set scorebar to OUT and wait for transition
      scorebarVisible = false;
      updateScorebarButtons();
      await saveScoreboardState();

      // Wait for scorebar transition to complete (0.5s slide out)
      setTimeout(async () => {
        miniBugVisible = true;
        updateMiniBugButtons();
        await saveScoreboardState();
      }, 500);
    } else {
      // No other graphic is visible, transition immediately
      miniBugVisible = true;
      updateMiniBugButtons();
      await saveScoreboardState();
    }
  });

  miniBugOutBtn.addEventListener('click', async () => {
    miniBugVisible = false;
    updateMiniBugButtons();
    await saveScoreboardState();
  });

  // Locator IN/OUT event handlers
  locatorInBtn.addEventListener('click', async () => {
    if (scorebarVisible) {
      // First set scorebar to OUT and wait for transition
      scorebarVisible = false;
      updateScorebarButtons();
      await saveScoreboardState();

      // Wait for scorebar transition to complete (0.5s slide out)
      setTimeout(async () => {
        locatorVisible = true;
        updateLocatorButtons();
        await saveScoreboardState();
      }, 500);
    } else if (miniBugVisible) {
      // First set mini bug to OUT and wait for transition
      miniBugVisible = false;
      updateMiniBugButtons();
      await saveScoreboardState();

      // Wait for mini bug transition to complete (0.5s slide out)
      setTimeout(async () => {
        locatorVisible = true;
        updateLocatorButtons();
        await saveScoreboardState();
      }, 500);
    } else {
      // No other graphic is visible, transition immediately
      locatorVisible = true;
      updateLocatorButtons();
      await saveScoreboardState();
    }
  });

  locatorOutBtn.addEventListener('click', async () => {
    locatorVisible = false;
    updateLocatorButtons();
    await saveScoreboardState();
  });

  // Lower Third IN/OUT event handlers
  lowerThirdInBtn.addEventListener('click', async () => {
    if (scorebarVisible) {
      // First set scorebar to OUT and wait for transition
      scorebarVisible = false;
      updateScorebarButtons();
      await saveScoreboardState();

      // Wait for scorebar transition to complete (0.5s slide out)
      setTimeout(async () => {
        lowerThirdVisible = true;
        updateLowerThirdButtons();
        await saveScoreboardState();
      }, 500);
    } else if (miniBugVisible) {
      // First set mini bug to OUT and wait for transition
      miniBugVisible = false;
      updateMiniBugButtons();
      await saveScoreboardState();

      // Wait for mini bug transition to complete (0.5s slide out)
      setTimeout(async () => {
        lowerThirdVisible = true;
        updateLowerThirdButtons();
        await saveScoreboardState();
      }, 500);
    } else if (locatorVisible) {
      // First set locator to OUT and wait for transition
      locatorVisible = false;
      updateLocatorButtons();
      await saveScoreboardState();

      // Wait for locator transition to complete (0.5s slide out)
      setTimeout(async () => {
        lowerThirdVisible = true;
        updateLowerThirdButtons();
        await saveScoreboardState();
      }, 500);
    } else {
      // No other graphic is visible, transition immediately
      lowerThirdVisible = true;
      updateLowerThirdButtons();
      await saveScoreboardState();
    }
  });

  lowerThirdOutBtn.addEventListener('click', async () => {
    lowerThirdVisible = false;
    updateLowerThirdButtons();
    await saveScoreboardState();
  });

  // Function to close all expanded sections
  function closeAllExpandedSections() {
    // Close Lower Third
    if (lowerThirdExpanded_isOpen) {
      lowerThirdExpanded_isOpen = false;
      lowerThirdExpanded.classList.remove('open');
      lowerThirdExpandBtn.innerHTML = '&gt;';
    }

    // Close Talent
    if (talentExpanded_isOpen) {
      talentExpanded_isOpen = false;
      talentExpanded.classList.remove('open');
      talentExpandBtn.innerHTML = '&gt;';
    }

    // Close Left Slab
    if (leftSlabExpanded_isOpen) {
      leftSlabExpanded_isOpen = false;
      leftSlabExpanded.classList.remove('open');
      leftSlabExpandBtn.innerHTML = '&gt;';
    }

    // Close Tombstone
    if (tombstoneExpanded_isOpen) {
      tombstoneExpanded_isOpen = false;
      tombstoneExpanded.classList.remove('open');
      tombstoneExpandBtn.innerHTML = '&gt;';
    }
  }

  // Lower Third Expand button functionality
  lowerThirdExpandBtn.addEventListener('click', () => {
    if (!lowerThirdExpanded_isOpen) {
      // Close all other sections first
      closeAllExpandedSections();
      // Then open this one
      lowerThirdExpanded_isOpen = true;
      lowerThirdExpanded.classList.add('open');
      lowerThirdExpandBtn.innerHTML = '&lt;';
    } else {
      lowerThirdExpanded_isOpen = false;
      lowerThirdExpanded.classList.remove('open');
      lowerThirdExpandBtn.innerHTML = '&gt;';
    }
  });

  // Talent IN/OUT event handlers
  talentInBtn.addEventListener('click', async () => {
    if (scorebarVisible) {
      scorebarVisible = false;
      updateScorebarButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        talentVisible = true;
        updateTalentButtons();
        await saveScoreboardState();
      }, 500);
    } else if (miniBugVisible) {
      miniBugVisible = false;
      updateMiniBugButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        talentVisible = true;
        updateTalentButtons();
        await saveScoreboardState();
      }, 500);
    } else if (locatorVisible) {
      locatorVisible = false;
      updateLocatorButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        talentVisible = true;
        updateTalentButtons();
        await saveScoreboardState();
      }, 500);
    } else if (lowerThirdVisible) {
      lowerThirdVisible = false;
      updateLowerThirdButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        talentVisible = true;
        updateTalentButtons();
        await saveScoreboardState();
      }, 500);
    } else {
      talentVisible = true;
      updateTalentButtons();
      await saveScoreboardState();
    }
  });

  talentOutBtn.addEventListener('click', async () => {
    talentVisible = false;
    updateTalentButtons();
    await saveScoreboardState();
  });

  // Talent Expanded button functionality
  talentExpandBtn.addEventListener('click', () => {
    if (!talentExpanded_isOpen) {
      // Close all other sections first
      closeAllExpandedSections();
      // Then open this one
      talentExpanded_isOpen = true;
      talentExpanded.classList.add('open');
      talentExpandBtn.innerHTML = '&lt;';
    } else {
      talentExpanded_isOpen = false;
      talentExpanded.classList.remove('open');
      talentExpandBtn.innerHTML = '&gt;';
    }
  });

  // Left Slab IN/OUT event handlers
  leftSlabInBtn.addEventListener('click', async () => {
    if (scorebarVisible) {
      scorebarVisible = false;
      updateScorebarButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        leftSlabVisible = true;
        updateLeftSlabButtons();
        await saveScoreboardState();
      }, 500);
    } else if (miniBugVisible) {
      miniBugVisible = false;
      updateMiniBugButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        leftSlabVisible = true;
        updateLeftSlabButtons();
        await saveScoreboardState();
      }, 500);
    } else if (locatorVisible) {
      locatorVisible = false;
      updateLocatorButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        leftSlabVisible = true;
        updateLeftSlabButtons();
        await saveScoreboardState();
      }, 500);
    } else if (lowerThirdVisible) {
      lowerThirdVisible = false;
      updateLowerThirdButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        leftSlabVisible = true;
        updateLeftSlabButtons();
        await saveScoreboardState();
      }, 500);
    } else if (talentVisible) {
      talentVisible = false;
      updateTalentButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        leftSlabVisible = true;
        updateLeftSlabButtons();
        await saveScoreboardState();
      }, 500);
    } else {
      leftSlabVisible = true;
      updateLeftSlabButtons();
      await saveScoreboardState();
    }
  });

  leftSlabOutBtn.addEventListener('click', async () => {
    leftSlabVisible = false;
    updateLeftSlabButtons();
    await saveScoreboardState();
  });

  // Tombstone IN/OUT event handlers
  tombstoneInBtn.addEventListener('click', async () => {
    if (scorebarVisible) {
      scorebarVisible = false;
      updateScorebarButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        tombstoneVisible = true;
        updateTombstoneButtons();
        await saveScoreboardState();
      }, 500);
    } else if (miniBugVisible) {
      miniBugVisible = false;
      updateMiniBugButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        tombstoneVisible = true;
        updateTombstoneButtons();
        await saveScoreboardState();
      }, 500);
    } else if (locatorVisible) {
      locatorVisible = false;
      updateLocatorButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        tombstoneVisible = true;
        updateTombstoneButtons();
        await saveScoreboardState();
      }, 500);
    } else if (lowerThirdVisible) {
      lowerThirdVisible = false;
      updateLowerThirdButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        tombstoneVisible = true;
        updateTombstoneButtons();
        await saveScoreboardState();
      }, 500);
    } else if (talentVisible) {
      talentVisible = false;
      updateTalentButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        tombstoneVisible = true;
        updateTombstoneButtons();
        await saveScoreboardState();
      }, 500);
    } else if (leftSlabVisible) {
      leftSlabVisible = false;
      updateLeftSlabButtons();
      await saveScoreboardState();
      setTimeout(async () => {
        tombstoneVisible = true;
        updateTombstoneButtons();
        await saveScoreboardState();
      }, 500);
    } else {
      tombstoneVisible = true;
      updateTombstoneButtons();
      await saveScoreboardState();
    }
  });

  tombstoneOutBtn.addEventListener('click', async () => {
    tombstoneVisible = false;
    updateTombstoneButtons();
    await saveScoreboardState();
  });

  // Fullscreen IN/OUT event handlers
  fullscreenInBtn.addEventListener('click', async () => {
    fullscreenVisible = true;
    updateFullscreenButtons();
    await saveScoreboardState();
  });

  fullscreenOutBtn.addEventListener('click', async () => {
    fullscreenVisible = false;
    updateFullscreenButtons();
    await saveScoreboardState();
  });

  // Tombstone Expanded button functionality
  tombstoneExpandBtn.addEventListener('click', () => {
    if (!tombstoneExpanded_isOpen) {
      // Close all other sections first
      closeAllExpandedSections();
      // Then open this one
      tombstoneExpanded_isOpen = true;
      tombstoneExpanded.classList.add('open');
      tombstoneExpandBtn.innerHTML = '&lt;';
    } else {
      tombstoneExpanded_isOpen = false;
      tombstoneExpanded.classList.remove('open');
      tombstoneExpandBtn.innerHTML = '&gt;';
    }
  });

  // Tombstone team toggle functionality
  const tombstoneHomeTeamToggle = document.getElementById('tombstoneHomeTeamToggle');
  const tombstoneAwayTeamToggle = document.getElementById('tombstoneAwayTeamToggle');
  const tombstoneWeatherTeamToggle = document.getElementById('tombstoneWeatherTeamToggle'); // Changed ID

  // Function to update tombstone input visibility
  function updateTombstoneInputVisibility() {
    const weatherInputs = document.getElementById('tombstoneWeatherInputs');
    const customSections = document.getElementById('tombstoneCustomSections');
    
    if (selectedTombstoneTeam === 'weather') {
      weatherInputs.style.display = 'block';
      customSections.style.display = 'none';
    } else {
      weatherInputs.style.display = 'none';
      customSections.style.display = 'block';
    }
  }

  tombstoneHomeTeamToggle.addEventListener('click', async () => {
    selectedTombstoneTeam = 'home';
    tombstoneHomeTeamToggle.classList.add('active');
    tombstoneAwayTeamToggle.classList.remove('active');
    tombstoneWeatherTeamToggle.classList.remove('active');
    updateTombstoneInputVisibility();
    await saveScoreboardState();
  });

  tombstoneAwayTeamToggle.addEventListener('click', async () => {
    selectedTombstoneTeam = 'away';
    tombstoneAwayTeamToggle.classList.add('active');
    tombstoneHomeTeamToggle.classList.remove('active');
    tombstoneWeatherTeamToggle.classList.remove('active');
    updateTombstoneInputVisibility();
    await saveScoreboardState();
  });

  tombstoneWeatherTeamToggle.addEventListener('click', async () => { // Changed ID
    selectedTombstoneTeam = 'weather';
    tombstoneWeatherTeamToggle.classList.add('active'); // Changed ID
    tombstoneHomeTeamToggle.classList.remove('active');
    tombstoneAwayTeamToggle.classList.remove('active');
    updateTombstoneInputVisibility();
    await saveScoreboardState();
  });

  // Left Slab Expanded button functionality
  leftSlabExpandBtn.addEventListener('click', () => {
    if (!leftSlabExpanded_isOpen) {
      // Close all other sections first
      closeAllExpandedSections();
      // Then open this one
      leftSlabExpanded_isOpen = true;
      leftSlabExpanded.classList.add('open');
      leftSlabExpandBtn.innerHTML = '&lt;';
    } else {
      leftSlabExpanded_isOpen = false;
      leftSlabExpanded.classList.remove('open');
      leftSlabExpandBtn.innerHTML = '&gt;';
    }
  });

  // Left Slab sections management
  let leftSlabSections = [];
  let leftSlabSectionIdCounter = 0;

  // Tombstone sections management
  let tombstoneSections = [];
  let tombstoneSectionIdCounter = 0;

  // Bracket teams management (11 games = 22 team slots: 8 Round 1 games + 3 Round 2 games)
  let bracketTeams = Array(22).fill('');
  let bracketTeamStatus = Array(22).fill('none'); // 'won', 'lost', or 'none'

  function setupFullscreenEditHandlers() {
    // Add input listeners for all 16 Round 1 team inputs
    for (let i = 1; i <= 16; i++) {
      const input = document.getElementById(`bracketTeam${i}`);
      if (input) {
        input.addEventListener('input', () => {
          bracketTeams[i - 1] = input.value;
          saveScoreboardState();
        });
      }
    }
    
    // Add input listeners for Round 2 teams (6 teams in 3 games)
    for (let i = 1; i <= 6; i++) {
      const round2Input = document.getElementById(`bracketRound2Team${i}`);
      if (round2Input) {
        round2Input.addEventListener('input', () => {
          bracketTeams[15 + i] = round2Input.value;
          saveScoreboardState();
        });
      }
    }
    
    // Add click handlers for team status toggling
    setupTeamStatusHandlers();
  }

  function setupTeamStatusHandlers() {
    // Handle Round 1 teams (16 teams)
    for (let i = 1; i <= 16; i++) {
      const teamContainer = document.querySelector(`#bracketTeam${i}`)?.parentElement;
      if (teamContainer) {
        const statusBtn = document.createElement('button');
        statusBtn.className = 'team-status-btn';
        statusBtn.textContent = '●';
        statusBtn.dataset.teamIndex = i - 1;
        statusBtn.style.cssText = `
          margin-left: 8px;
          padding: 4px 8px;
          border: none;
          border-radius: 3px;
          cursor: pointer;
          font-size: 16px;
          background: #555;
          color: #fff;
        `;
        
        statusBtn.addEventListener('click', (e) => {
          e.preventDefault();
          toggleTeamStatus(parseInt(statusBtn.dataset.teamIndex));
        });
        
        teamContainer.appendChild(statusBtn);
        updateStatusButton(statusBtn, i - 1);
      }
    }
    
    // Handle Round 2 teams (6 teams)
    for (let i = 1; i <= 6; i++) {
      const teamContainer = document.querySelector(`#bracketRound2Team${i}`)?.parentElement;
      if (teamContainer) {
        const statusBtn = document.createElement('button');
        statusBtn.className = 'team-status-btn';
        statusBtn.textContent = '●';
        statusBtn.dataset.teamIndex = 15 + i;
        statusBtn.style.cssText = `
          margin-left: 8px;
          padding: 4px 8px;
          border: none;
          border-radius: 3px;
          cursor: pointer;
          font-size: 16px;
          background: #555;
          color: #fff;
        `;
        
        statusBtn.addEventListener('click', (e) => {
          e.preventDefault();
          toggleTeamStatus(parseInt(statusBtn.dataset.teamIndex));
        });
        
        teamContainer.appendChild(statusBtn);
        updateStatusButton(statusBtn, 15 + i);
      }
    }
  }

  function toggleTeamStatus(teamIndex) {
    const currentStatus = bracketTeamStatus[teamIndex];
    
    // Cycle through: none -> won -> lost -> none
    if (currentStatus === 'none') {
      bracketTeamStatus[teamIndex] = 'won';
    } else if (currentStatus === 'won') {
      bracketTeamStatus[teamIndex] = 'lost';
    } else {
      bracketTeamStatus[teamIndex] = 'none';
    }
    
    // Update the button appearance
    const btn = document.querySelector(`[data-team-index="${teamIndex}"]`);
    if (btn) {
      updateStatusButton(btn, teamIndex);
    }
    
    saveScoreboardState();
  }

  function updateStatusButton(btn, teamIndex) {
    const status = bracketTeamStatus[teamIndex];
    
    if (status === 'won') {
      btn.style.background = '#4CAF50';
      btn.style.color = '#fff';
    } else if (status === 'lost') {
      btn.style.background = '#f44336';
      btn.style.color = '#fff';
    } else {
      btn.style.background = '#555';
      btn.style.color = '#fff';
    }
  }

  function createLeftSlabSection(title = '', subtext = '', id = null) {
    const sectionId = id || `section_${leftSlabSectionIdCounter++}`;
    const section = { id: sectionId, title, subtext };

    if (!id) {
      leftSlabSections.push(section);
    }

    const sectionElement = document.createElement('div');
    sectionElement.className = 'left-slab-section-item';
    sectionElement.style.cssText = `
      border: 1px solid #555;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      background: #2a2a2a;
      position: relative;
    `;

    sectionElement.innerHTML = `
      <button class="remove-section-btn" style="
        position: absolute;
        top: 5px;
        right: 5px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 3px;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      ">×</button>
      <div class="left-slab-input-group" style="margin-bottom: 10px;">
        <label style="color: #eee; font-weight: bold; min-width: 60px; font-size: 14px; margin-bottom: 5px; display: block;">TITLE:</label>
        <input type="text" class="section-title" value="${title}" placeholder="Enter section title" style="
          width: 100%;
          padding: 6px 10px;
          font-size: 12px;
          border-radius: 4px;
          border: none;
          background: #333;
          color: #eee;
          font-family: inherit;
        ">
      </div>
    `;

    // Add event listeners
    const titleInput = sectionElement.querySelector('.section-title');
    const removeBtn = sectionElement.querySelector('.remove-section-btn');

    titleInput.addEventListener('input', () => {
      const sectionIndex = leftSlabSections.findIndex(s => s.id === sectionId);
      if (sectionIndex !== -1) {
        leftSlabSections[sectionIndex].title = titleInput.value;
        saveScoreboardState();
      }
    });

    removeBtn.addEventListener('click', () => {
      leftSlabSections = leftSlabSections.filter(s => s.id !== sectionId);
      sectionElement.remove();
      saveScoreboardState();
    });

    return sectionElement;
  }

  function createTombstoneSection(title = '', subtext = '', id = null) {
    const sectionId = id || `tombstone_section_${tombstoneSectionIdCounter++}`;
    const section = { id: sectionId, title, subtext };

    if (!id) {
      tombstoneSections.push(section);
    }

    const sectionElement = document.createElement('div');
    sectionElement.className = 'tombstone-section-item';
    sectionElement.style.cssText = `
      border: 1px solid #555;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      background: #2a2a2a;
      position: relative;
    `;

    sectionElement.innerHTML = `
      <button class="remove-section-btn" style="
        position: absolute;
        top: 5px;
        right: 5px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 3px;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      ">×</button>
      <div class="tombstone-input-group" style="margin-bottom: 10px;">
        <label style="color: #eee; font-weight: bold; min-width: 60px; font-size: 14px; margin-bottom: 5px; display: block;">TITLE:</label>
        <input type="text" class="section-title" value="${title}" placeholder="Enter section title" style="
          width: 100%;
          padding: 6px 10px;
          font-size: 12px;
          border-radius: 4px;
          border: none;
          background: #333;
          color: #eee;
          font-family: inherit;
        ">
      </div>
    `;

    // Add event listeners
    const titleInput = sectionElement.querySelector('.section-title');
    const removeBtn = sectionElement.querySelector('.remove-section-btn');

    titleInput.addEventListener('input', () => {
      const sectionIndex = tombstoneSections.findIndex(s => s.id === sectionId);
      if (sectionIndex !== -1) {
        tombstoneSections[sectionIndex].title = titleInput.value;
        saveScoreboardState();
      }
    });

    removeBtn.addEventListener('click', () => {
      tombstoneSections = tombstoneSections.filter(s => s.id !== sectionId);
      sectionElement.remove();
      saveScoreboardState();
    });

    return sectionElement;
  }

  // Add section button handler
  document.getElementById('addLeftSlabSection').addEventListener('click', () => {
    const sectionElement = createLeftSlabSection();
    document.getElementById('leftSlabSectionsList').appendChild(sectionElement);
    saveScoreboardState();
  });

  // Add tombstone section button handler
  document.getElementById('addTombstoneSection').addEventListener('click', () => {
    const sectionElement = createTombstoneSection();
    document.getElementById('tombstoneSectionsList').appendChild(sectionElement);
    saveScoreboardState();
  });

  // Left slab title input handlers
  const leftSlabTitleInput = document.getElementById('leftSlabTitleInput');
  const leftSlabTitle2Input = document.getElementById('leftSlabTitle2Input');
  if (leftSlabTitleInput) {
    leftSlabTitleInput.addEventListener('input', async () => {
      await saveScoreboardState();
    });
  }
  if (leftSlabTitle2Input) {
    leftSlabTitle2Input.addEventListener('input', async () => {
      await saveScoreboardState();
    });
  }



  // Auto-save when talent inputs change
  const talentLeftNameInput = document.getElementById('talentLeftName');
  const talentLeftTitleInput = document.getElementById('talentLeftTitle');
  const talentRightNameInput = document.getElementById('talentRightName');
  const talentRightTitleInput = document.getElementById('talentRightTitle');

  talentLeftNameInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });

  talentLeftTitleInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });

  talentRightNameInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });

  talentRightTitleInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });

  // Auto-save when lower third inputs change
  const lowerThirdNameInput = document.getElementById('lowerThirdName');
  const lowerThirdTitleInput = document.getElementById('lowerThirdTitle');
  const homeTeamToggle = document.getElementById('homeTeamToggle');
  const awayTeamToggle = document.getElementById('awayTeamToggle');
  const csnTeamToggle = document.getElementById('csnTeamToggle');

  // Team toggle state
  let selectedTeam = 'home'; // default to home

  // Team toggle functionality
  homeTeamToggle.addEventListener('click', async () => {
    selectedTeam = 'home';
    homeTeamToggle.classList.add('active');
    awayTeamToggle.classList.remove('active');
    csnTeamToggle.classList.remove('active');
    await saveScoreboardState();
  });

  awayTeamToggle.addEventListener('click', async () => {
    selectedTeam = 'away';
    awayTeamToggle.classList.add('active');
    homeTeamToggle.classList.remove('active');
    csnTeamToggle.classList.remove('active');
    await saveScoreboardState();
  });

  csnTeamToggle.addEventListener('click', async () => {
    selectedTeam = 'Default';
    csnTeamToggle.classList.add('active');
    homeTeamToggle.classList.remove('active');
    awayTeamToggle.classList.remove('active');
    await saveScoreboardState();
  });

  lowerThirdNameInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });

  lowerThirdTitleInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });

  // Weather input event listeners
  const weatherInputs = ['weatherTemp', 'weatherFeelsLike', 'weatherHumidity', 'weatherWind', 'weatherUVIndex'];
  weatherInputs.forEach(inputId => {
    const input = document.getElementById(inputId);
    if (input) {
      input.addEventListener('input', async () => {
        await saveScoreboardState();
      });
    }
  });


  homeInc1Btn.addEventListener('click', async () => {
    homeScore += 1;

    await saveScoreboardState();
  });
  homeInc2Btn.addEventListener('click', async () => {
    if (currentSport === 'football') {
      homeScore += 6;
      // Hide scorebar when touchdown is scored
      scorebarVisible = false;
      updateScorebarButtons();
      
      // Trigger touchdown animation after scorebar goes out
      setTimeout(async () => {
        await saveScoreboardState({ touchdownTriggered: true });
        // Clear the trigger after a short delay
        setTimeout(async () => {
          await saveScoreboardState({ touchdownTriggered: false });
        }, 100);
      }, 500);

      // Wait 7 seconds after touchdown animation starts, then bring scorebar back
      setTimeout(async () => {
        scorebarVisible = true;
        updateScorebarButtons();
        await saveScoreboardState();
      }, 7500); // 500ms scorebar out + 7000ms wait
    } else {
      homeScore += 2;
    }

    await saveScoreboardState();
  });
  homeInc3Btn.addEventListener('click', async () => {
    homeScore += 3;

    await saveScoreboardState();
  });
  homeDec1Btn.addEventListener('click', async () => {
    if (homeScore > 0) {
      homeScore--;
  
      await saveScoreboardState();
    }
  });

  awayInc1Btn.addEventListener('click', async () => {
    awayScore += 1;

    await saveScoreboardState();
  });
  awayInc2Btn.addEventListener('click', async () => {
    if (currentSport === 'football') {
      awayScore += 6;
      // Hide scorebar when touchdown is scored
      scorebarVisible = false;
      updateScorebarButtons();
      
      // Trigger touchdown animation after scorebar goes out
      setTimeout(async () => {
        await saveScoreboardState({ touchdownTriggered: true });
        // Clear the trigger after a short delay
        setTimeout(async () => {
          await saveScoreboardState({ touchdownTriggered: false });
        }, 100);
      }, 500);

      // Wait 7 seconds after touchdown animation starts, then bring scorebar back
      setTimeout(async () => {
        scorebarVisible = true;
        updateScorebarButtons();
        await saveScoreboardState();
      }, 7500); // 500ms scorebar out + 7000ms wait
    } else {
      awayScore += 2;
    }

    await saveScoreboardState();
  });
  awayInc3Btn.addEventListener('click', async () => {
    awayScore += 3;

    await saveScoreboardState();
  });
  awayDec1Btn.addEventListener('click', async () => {
    if (awayScore > 0) {
      awayScore--;
  
      await saveScoreboardState();
    }
  });

  // Add event handlers for new -6 buttons
  const homeDec6Btn = document.getElementById('homeDec6');
  const awayDec6Btn = document.getElementById('awayDec6');

  homeDec6Btn.addEventListener('click', async () => {
    if (homeScore >= 6) {
      homeScore -= 6;
  
      await saveScoreboardState();
    }
  });

  awayDec6Btn.addEventListener('click', async () => {
    if (awayScore >= 6) {
      awayScore -= 6;
  
      await saveScoreboardState();
    }
  });

  // Input bindings for team names, mascots, bg colors

  homeFullNameInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });
  homeNameInput.addEventListener('input', async () => {
    updateScoreLabels();
    await saveScoreboardState();
  });
  homeMascotInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });
  homeBgColorInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });
  awayFullNameInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });
  awayNameInput.addEventListener('input', async () => {
    updateScoreLabels();
    await saveScoreboardState();
  });
  awayMascotInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });
  awayBgColorInput.addEventListener('input', async () => {
    await saveScoreboardState();
  });

  // Function to update score labels based on team names
  function updateScoreLabels() {
    const homeScoreLabel = document.getElementById('homeScoreLabel');
    const awayScoreLabel = document.getElementById('awayScoreLabel');
    
    const homeName = homeNameInput.value.trim();
    const awayName = awayNameInput.value.trim();
    
    if (homeScoreLabel) {
      homeScoreLabel.textContent = homeName ? `${homeName} Score` : 'Home Score';
    }
    
    if (awayScoreLabel) {
      awayScoreLabel.textContent = awayName ? `${awayName} Score` : 'Away Score';
    }
  }

  // Logo input handlers
  function readImageFile(input, previewImg) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewImg.style.display = 'block';
        saveScoreboardState().catch(console.error);
      };
      reader.readAsDataURL(input.files[0]);
    }
  }
  homeLogoInput.addEventListener('change', () => {
    readImageFile(homeLogoInput, homeLogoPreview);
  });
  awayLogoInput.addEventListener('change', () => {
    readImageFile(awayLogoInput, awayLogoPreview);
  });

  // Ticker logo input handler
  const tickerLogoInput = document.getElementById('tickerLogoInput');
  const tickerLogoPreview = document.getElementById('tickerLogoPreview');
  
  if (tickerLogoInput) {
    tickerLogoInput.addEventListener('change', () => {
      readImageFile(tickerLogoInput, tickerLogoPreview);
    });
  }

  // Ticker lines management
  let customTickerLines = [];
  let tickerLineIdCounter = 0;

  function loadCustomTickerLines() {
    const saved = localStorage.getItem('customTickerLines');
    if (saved) {
      try {
        customTickerLines = JSON.parse(saved);
        tickerLineIdCounter = customTickerLines.length > 0 ? Math.max(...customTickerLines.map(l => l.id)) + 1 : 0;
      } catch (e) {
        console.warn('Failed to load custom ticker lines:', e);
        customTickerLines = [];
      }
    }
  }

  function saveCustomTickerLines() {
    localStorage.setItem('customTickerLines', JSON.stringify(customTickerLines));
    saveScoreboardState();
  }

  function createTickerLineElement(text = '', id = null) {
    const lineId = id !== null ? id : tickerLineIdCounter++;
    
    if (id === null) {
      customTickerLines.push({ id: lineId, text });
    }

    const lineElement = document.createElement('div');
    lineElement.className = 'ticker-line-item';
    lineElement.dataset.lineId = lineId;
    lineElement.style.cssText = `
      border: 1px solid #555;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 12px;
      background: #2a2a2a;
      position: relative;
      display: flex;
      gap: 10px;
      align-items: center;
    `;

    lineElement.innerHTML = `
      <button class="remove-ticker-line-btn" style="
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 3px;
        width: 24px;
        height: 24px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      ">×</button>
      <input type="text" class="ticker-line-text" value="${text}" placeholder="Enter ticker message" style="
        flex: 1;
        padding: 8px 12px;
        font-size: 14px;
        border-radius: 4px;
        border: none;
        background: #333;
        color: #eee;
        font-family: inherit;
      ">
    `;

    const textInput = lineElement.querySelector('.ticker-line-text');
    const removeBtn = lineElement.querySelector('.remove-ticker-line-btn');

    textInput.addEventListener('input', () => {
      const line = customTickerLines.find(l => l.id === lineId);
      if (line) {
        line.text = textInput.value;
        saveCustomTickerLines();
      }
    });

    removeBtn.addEventListener('click', () => {
      customTickerLines = customTickerLines.filter(l => l.id !== lineId);
      lineElement.remove();
      saveCustomTickerLines();
    });

    return lineElement;
  }

  function initializeTickerLinesUI() {
    const tickerLinesList = document.getElementById('tickerLinesList');
    const addTickerLineBtn = document.getElementById('addTickerLineBtn');

    if (!tickerLinesList || !addTickerLineBtn) return;

    // Load saved lines
    loadCustomTickerLines();

    // If no custom lines exist, add default ones
    if (customTickerLines.length === 0) {
      customTickerLines = [
        { id: tickerLineIdCounter++, text: "" },
        { id: tickerLineIdCounter++, text: "" },
        { id: tickerLineIdCounter++, text: "" },
        { id: tickerLineIdCounter++, text: "" },
        { id: tickerLineIdCounter++, text: "" }
      ];
      saveCustomTickerLines();
    }

    // Render existing lines
    customTickerLines.forEach(line => {
      const lineElement = createTickerLineElement(line.text, line.id);
      tickerLinesList.appendChild(lineElement);
    });

    // Add line button handler
    addTickerLineBtn.addEventListener('click', () => {
      const lineElement = createTickerLineElement();
      tickerLinesList.appendChild(lineElement);
      saveCustomTickerLines();
      
      // Focus the new input
      const textInput = lineElement.querySelector('.ticker-line-text');
      if (textInput) textInput.focus();
    });
  }

  // Initialize ticker lines UI when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTickerLinesUI);
  } else {
    initializeTickerLinesUI();
  }

  // Check if we're running in Electron
  const isElectron = typeof window !== 'undefined' && window.electronAPI;

  // Save/load state from server API
  async function saveScoreboardState(additionalData = {}) {
    // Build state object; include ticker lines from editor
    const state = {
      ...additionalData,
      selectedSport: currentSport,
      homeFullName: homeFullNameInput.value.trim() || 'Home School',
      homeName: homeNameInput.value.trim() || 'Home School',
      homeMascot: homeMascotInput.value.trim() || '',
      homeScore: homeScore,
      homeLogo: homeLogoPreview && homeLogoPreview.src ? homeLogoPreview.src : '',
      awayFullName: awayFullNameInput.value.trim() || 'Away School',
      awayName: awayNameInput.value.trim() || 'Away School',
      awayMascot: awayMascotInput.value.trim() || '',
      awayScore: awayScore,
      awayLogo: awayLogoPreview && awayLogoPreview.src ? awayLogoPreview.src : '',
      period: periodInput.value.trim() || 'Q1',
      clockTime: clockInput ? clockInput.value.trim() || '12:00' : '12:00',
      clockRunning: clockRunning,
      homeBgColor: homeBgColorInput.value,
      awayBgColor: awayBgColorInput.value,
      tickerLogo: tickerLogoPreview ? tickerLogoPreview.src : '',
      customTickerLines: customTickerLines,
      homeTimeoutsLeft: homeTimeoutsLeft,
      awayTimeoutsLeft: awayTimeoutsLeft,
      scorebarVisible: scorebarVisible,
      miniBugVisible: miniBugVisible,
      locatorVisible: locatorVisible,
      lowerThirdVisible: lowerThirdVisible,
      lowerThirdName: lowerThirdNameInput ? lowerThirdNameInput.value : '',
      lowerThirdTitle: lowerThirdTitleInput ? lowerThirdTitleInput.value : '',
      lowerThirdTeam: selectedTeam,
      talentVisible: talentVisible,
      talentLeftName: talentLeftNameInput ? talentLeftNameInput.value : '',
      talentLeftTitle: talentLeftTitleInput ? talentLeftTitleInput.value : '',
      talentRightName: talentRightNameInput ? talentRightNameInput.value : '',
      talentRightTitle: talentRightTitleInput ? talentRightTitleInput.value : '',
      leftSlabVisible: leftSlabVisible,
      leftSlabTitle: leftSlabTitleInput ? leftSlabTitleInput.value : '',
      leftSlabTitle2: leftSlabTitle2Input ? leftSlabTitle2Input.value : '',
      leftSlabSections: leftSlabSections,
      fullscreenVisible: fullscreenVisible,

      tombstoneSections: tombstoneSections,
      footballDown: currentDown,
      footballYardsToGo: yardsToGo,
      footballSectionVisible: footballSectionVisible,
      footballTextVisible: footballTextVisible,
      tombstoneVisible: tombstoneVisible,
      tombstoneTeam: selectedTombstoneTeam,
      weatherTemp: document.getElementById('weatherTemp') ? document.getElementById('weatherTemp').value : '',
      weatherFeelsLike: document.getElementById('weatherFeelsLike') ? document.getElementById('weatherFeelsLike').value : '',
      weatherHumidity: document.getElementById('weatherHumidity') ? document.getElementById('weatherHumidity').value : '',
      weatherWind: document.getElementById('weatherWind') ? document.getElementById('weatherWind').value : '',
      weatherUVIndex: document.getElementById('weatherUVIndex') ? document.getElementById('weatherUVIndex').value : '',
      volleyballSet: currentSet,
      footballStats: footballStats,
      volleyballStats: volleyballStats,
      statDisplayVisible: statDisplayVisible,
      currentDisplayedStat: currentDisplayedStat,
      bracketTeams: bracketTeams,
      bracketTeamStatus: bracketTeamStatus
    };

    // Save to localStorage immediately for instant local updates
    localStorage.setItem('basketballScoreboard', JSON.stringify(state));

    // Broadcast state to graphics window via IPC (Electron only)
    if (isElectron && window.api && window.api.send) {
      console.log('[IPC] Sending scoreboard state via IPC:', {
        hasApi: !!window.api,
        hasSend: !!(window.api && window.api.send),
        statDisplayVisible: state.statDisplayVisible,
        currentDisplayedStat: state.currentDisplayedStat
      });
      window.api.send('scoreboard-state-update', state);
    } else {
      console.log('[IPC] NOT sending - conditions not met:', {
        isElectron,
        hasApi: !!window.api,
        hasSend: !!(window.api && window.api.send)
      });
    }

    // Only try to save to server if we're not in Electron
    if (!isElectron) {
      // Save to server (don't wait for response to avoid blocking)
      fetch('data.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(state)
      }).catch(console.error);
    }
  }

  async function loadScoreboardState() {
    // In Electron, only use localStorage
    if (isElectron) {
      const saved = JSON.parse(localStorage.getItem('basketballScoreboard') || '{}');
      return saved;
    }

    // In browser, try server first, then localStorage
    try {
      const response = await fetch('data.php');
      const saved = await response.json();
      return saved;
    } catch (e) {
      console.warn('Failed to load from server, using localStorage backup', e);
      const saved = JSON.parse(localStorage.getItem('basketballScoreboard') || '{}');
      return saved;
    }
  }

  async function loadScoreboardStateIntoUI() {
    const saved = await loadScoreboardState();
    if (!saved) return;

    // Don't automatically load sport selection - force user to choose each time
    // Sport will be set when user makes selection from popup
    if (saved.homeFullName) homeFullNameInput.value = saved.homeFullName;
    if (saved.homeName) homeNameInput.value = saved.homeName;
    if (saved.homeMascot) homeMascotInput.value = saved.homeMascot;
    if (typeof saved.homeScore === 'number') {
      homeScore = saved.homeScore;
    }
    if (saved.awayFullName) awayFullNameInput.value = saved.awayFullName;
    if (saved.awayName) awayNameInput.value = saved.awayName;
    if (saved.awayMascot) awayMascotInput.value = saved.awayMascot;
    if (typeof saved.awayScore === 'number') {
      awayScore = saved.awayScore;
    }
    if (saved.period) periodInput.value = saved.period;
    if (saved.clockTime && clockInput) {
      clockTime = saved.clockTime;
      clockInput.value = clockTime;
    }
    if (typeof saved.clockRunning === 'boolean') {
      clockRunning = saved.clockRunning;
      if (clockRunning && clockStartPauseBtn) {
        clockStartPauseBtn.textContent = 'Pause';
        // Don't restart the interval automatically on load for safety
        // User will need to click start again
        clockRunning = false;
      }
    }
    if (saved.homeBgColor) homeBgColorInput.value = saved.homeBgColor;
    if (saved.awayBgColor) awayBgColorInput.value = saved.awayBgColor;

    if (saved.homeLogo) {
      homeLogoPreview.src = saved.homeLogo;
      homeLogoPreview.style.display = 'block';
    }
    if (saved.awayLogo) {
      awayLogoPreview.src = saved.awayLogo;
      awayLogoPreview.style.display = 'block';
    }

    if (saved.tickerLogo && tickerLogoPreview) {
      tickerLogoPreview.src = saved.tickerLogo;
      tickerLogoPreview.style.display = 'block';
    }

    if (typeof saved.homeTimeoutsLeft === 'number') {
      homeTimeoutsLeft = saved.homeTimeoutsLeft;
    }
    if (typeof saved.awayTimeoutsLeft === 'number') {
      awayTimeoutsLeft = saved.awayTimeoutsLeft;
    }

    if (typeof saved.scorebarVisible === 'boolean') {
      scorebarVisible = saved.scorebarVisible;
      updateScorebarButtons();
    }

    if (typeof saved.miniBugVisible === 'boolean') {
      miniBugVisible = saved.miniBugVisible;
      updateMiniBugButtons();
    }

    // Initialize display-only controls
    updateLowerThirdButtons();
    updateTickerButtons();

    if (typeof saved.locatorVisible === 'boolean') {
      locatorVisible = saved.locatorVisible;
      updateLocatorButtons();
    }

    if (typeof saved.lowerThirdVisible === 'boolean') {
      lowerThirdVisible = saved.lowerThirdVisible;
      updateLowerThirdButtons();
    }

    if (saved.lowerThirdName && lowerThirdNameInput) {
      lowerThirdNameInput.value = saved.lowerThirdName;
    }
    if (saved.lowerThirdTitle && lowerThirdTitleInput) {
      lowerThirdTitleInput.value = saved.lowerThirdTitle;
    }

    if (saved.lowerThirdTeam) {
      selectedTeam = saved.lowerThirdTeam;
      if (selectedTeam === 'home') {
        homeTeamToggle.classList.add('active');
        awayTeamToggle.classList.remove('active');
        csnTeamToggle.classList.remove('active');
      } else if (selectedTeam === 'away') {
        awayTeamToggle.classList.add('active');
        homeTeamToggle.classList.remove('active');
        csnTeamToggle.classList.remove('active');
      } else if (selectedTeam === 'Default') {
        csnTeamToggle.classList.add('active');
        homeTeamToggle.classList.remove('active');
        awayTeamToggle.classList.remove('active');
      }
    }

    if (typeof saved.talentVisible === 'boolean') {
      talentVisible = saved.talentVisible;
      updateTalentButtons();
    }
    if (saved.talentLeftName && talentLeftNameInput) {
      talentLeftNameInput.value = saved.talentLeftName;
    }
    if (saved.talentLeftTitle && talentLeftTitleInput) {
      talentLeftTitleInput.value = saved.talentLeftTitle;
    }
    if (saved.talentRightName && talentRightNameInput) {
      talentRightNameInput.value = saved.talentRightName;
    }
    if (saved.talentRightTitle && talentRightTitleInput) {
      talentRightTitleInput.value = saved.talentRightTitle;
    }

    if (typeof saved.leftSlabVisible === 'boolean') {
      leftSlabVisible = saved.leftSlabVisible;
      updateLeftSlabButtons();
    }

    if (saved.leftSlabTitle && leftSlabTitleInput) {
      leftSlabTitleInput.value = saved.leftSlabTitle;
    }

    if (saved.leftSlabTitle2 && leftSlabTitle2Input) {
      leftSlabTitle2Input.value = saved.leftSlabTitle2;
    }

    if (saved.leftSlabSections && Array.isArray(saved.leftSlabSections)) {
      leftSlabSections = saved.leftSlabSections;
      const sectionsList = document.getElementById('leftSlabSectionsList');
      if (sectionsList) {
        sectionsList.innerHTML = '';
        leftSlabSections.forEach(section => {
          const sectionElement = createLeftSlabSection(section.title, section.subtext, section.id);
          sectionsList.appendChild(sectionElement);
        });
      }
    }

    if (saved.tombstoneSections && Array.isArray(saved.tombstoneSections)) {
      tombstoneSections = saved.tombstoneSections;
      const sectionsList = document.getElementById('tombstoneSectionsList');
      if (sectionsList) {
        sectionsList.innerHTML = '';
        tombstoneSections.forEach(section => {
          const sectionElement = createTombstoneSection(section.title, section.subtext, section.id);
          sectionsList.appendChild(sectionElement);
        });
      }
    }

    // Load football data
    if (saved.footballDown) {
      currentDown = saved.footballDown;
      if (downInput) downInput.value = currentDown;
    }
    if (typeof saved.footballYardsToGo === 'number') {
      yardsToGo = saved.footballYardsToGo;
      if (yardsToGoInput) yardsToGoInput.value = yardsToGo;
    }

    // Load volleyball data
    if (typeof saved.volleyballSet === 'number') {
      currentSet = saved.volleyballSet;
      if (setInput) setInput.value = currentSet;
    }

    // Load volleyball stats
    if (saved.volleyballStats) {
      volleyballStats = saved.volleyballStats;
    }

    // Load football section visibility state
    if (typeof saved.footballSectionVisible === 'boolean') {
      footballSectionVisible = saved.footballSectionVisible;
    }

    // Load football text visibility state
    if (typeof saved.footballTextVisible === 'boolean') {
      footballTextVisible = saved.footballTextVisible;
      const footballTextToggle = document.getElementById('footballTextToggle');
      if (footballTextToggle) {
        if (footballTextVisible) {
          footballTextToggle.style.background = '#444';
          footballTextToggle.textContent = 'HIDE TEXT';
        } else {
          footballTextToggle.style.background = '#c41e3a';
          footballTextToggle.textContent = 'SHOW TEXT';
        }
      }
    }

    // Load flag state
    if (typeof saved.flagVisible === 'boolean') {
      flagVisible = saved.flagVisible;
      const flagBtn = document.getElementById('flagBtn');
      if (flagBtn) {
        if (flagVisible) {
          flagBtn.style.background = '#ff4500';
          flagBtn.textContent = 'FLAG ON';
        } else {
          flagBtn.style.background = '#ffd700';
          flagBtn.textContent = 'FLAG';
        }
      }
    }

    // Load Tombstone state
    if (typeof saved.tombstoneVisible === 'boolean') {
      tombstoneVisible = saved.tombstoneVisible;
      updateTombstoneButtons();
    }

    if (saved.tombstoneTeam) {
      selectedTombstoneTeam = saved.tombstoneTeam;
      if (selectedTombstoneTeam === 'home') {
        tombstoneHomeTeamToggle.classList.add('active');
        tombstoneAwayTeamToggle.classList.remove('active');
        tombstoneWeatherTeamToggle.classList.remove('active'); // Changed ID
      } else if (selectedTombstoneTeam === 'away') {
        tombstoneAwayTeamToggle.classList.add('active');
        tombstoneHomeTeamToggle.classList.remove('active');
        tombstoneWeatherTeamToggle.classList.remove('active'); // Changed ID
      } else if (selectedTombstoneTeam === 'weather') { // Changed condition
        tombstoneWeatherTeamToggle.classList.add('active'); // Changed ID
        tombstoneHomeTeamToggle.classList.remove('active');
        tombstoneAwayTeamToggle.classList.remove('active');
      }
      updateTombstoneInputVisibility();
    }

    // Load weather data
    if (saved.weatherTemp && document.getElementById('weatherTemp')) {
      document.getElementById('weatherTemp').value = saved.weatherTemp;
    }
    if (saved.weatherFeelsLike && document.getElementById('weatherFeelsLike')) {
      document.getElementById('weatherFeelsLike').value = saved.weatherFeelsLike;
    }
    if (saved.weatherHumidity && document.getElementById('weatherHumidity')) {
      document.getElementById('weatherHumidity').value = saved.weatherHumidity;
    }
    if (saved.weatherWind && document.getElementById('weatherWind')) {
      document.getElementById('weatherWind').value = saved.weatherWind;
    }
    if (saved.weatherUVIndex && document.getElementById('weatherUVIndex')) {
      document.getElementById('weatherUVIndex').value = saved.weatherUVIndex;
    }

    // Load football stats
    if (saved.footballStats) {
      footballStats = saved.footballStats;
    }

    if (typeof saved.statDisplayVisible === 'boolean') {
      statDisplayVisible = saved.statDisplayVisible;
    }

    if (saved.currentDisplayedStat) {
      currentDisplayedStat = saved.currentDisplayedStat;
    }

    // Load bracket teams
    if (saved.bracketTeams && Array.isArray(saved.bracketTeams)) {
      bracketTeams = saved.bracketTeams;
    }

    // Load bracket team status
    if (saved.bracketTeamStatus && Array.isArray(saved.bracketTeamStatus)) {
      bracketTeamStatus = saved.bracketTeamStatus;
      
      // Update status button appearances after loading
      setTimeout(() => {
        bracketTeamStatus.forEach((status, index) => {
          const btn = document.querySelector(`[data-team-index="${index}"]`);
          if (btn) {
            updateStatusButton(btn, index);
          }
        });
      }, 100);
    }

    // Initialize stat button states if the buttons exist
    if (typeof updateStatDisplayButtons === 'function') {
      updateStatDisplayButtons();
    }

    updateHomeDisplay();
    updateAwayDisplay();

    initTimeoutDisplays();

    // Update score labels based on loaded team names - call this last after all data is loaded
    updateScoreLabels();

  }

  // Football specific variables
  let currentDown = '1st';
  let yardsToGo = 10;
  let footballSectionVisible = true;
  const downs = ['1st', '2nd', '3rd', '4th'];

  // Volleyball specific variables
  let currentSet = 1;

  // Football control elements
  const downInput = document.getElementById('downInput');
  const downPrevBtn = document.getElementById('downPrev');
  const downNextBtn = document.getElementById('downNext');
  const yardsToGoInput = document.getElementById('yardsToGoInput');
  const yardsIncBtn = document.getElementById('yardsInc');
  const yardsDecBtn = document.getElementById('yardsDec');

  // Volleyball control elements
  const setInput = document.getElementById('setInput');
  const setPrevBtn = document.getElementById('setPrev');
  const setNextBtn = document.getElementById('setNext');

  // Football control event handlers
  if (downPrevBtn) {
    downPrevBtn.addEventListener('click', async () => {
      let idx = downs.indexOf(currentDown);
      if (idx === -1) idx = 0;
      if (idx > 0) {
        idx--;
        currentDown = downs[idx];
        downInput.value = currentDown;
        await saveScoreboardState();
      }
    });
  }

  if (downNextBtn) {
    downNextBtn.addEventListener('click', async () => {
      let idx = downs.indexOf(currentDown);
      if (idx === -1) idx = 0;
      if (idx < downs.length - 1) {
        idx++;
        currentDown = downs[idx];
        downInput.value = currentDown;
        await saveScoreboardState();
      }
    });
  }

  if (downInput) {
    downInput.addEventListener('change', async () => {
      currentDown = downInput.value;
      await saveScoreboardState();
    });
  }

  if (yardsIncBtn) {
    yardsIncBtn.addEventListener('click', async () => {
      if (yardsToGo < 99) {
        yardsToGo++;
        yardsToGoInput.value = yardsToGo;
        await saveScoreboardState();
      }
    });
  }

  if (yardsDecBtn) {
    yardsDecBtn.addEventListener('click', async () => {
      if (yardsToGo > 1) {
        yardsToGo--;
        yardsToGoInput.value = yardsToGo;
        await saveScoreboardState();
      }
    });
  }

  if (yardsToGoInput) {
    yardsToGoInput.addEventListener('change', async () => {
      const val = parseInt(yardsToGoInput.value, 10);
      if (!isNaN(val) && val >= 1 && val <= 99) {
        yardsToGo = val;
        await saveScoreboardState();
      } else {
        yardsToGoInput.value = yardsToGo;
      }
    });
  }

  // Football text toggle button handler
  let footballTextVisible = true;
  const footballTextToggle = document.getElementById('footballTextToggle');
  if (footballTextToggle) {
    footballTextToggle.addEventListener('click', async () => {
      // Toggle football text visibility
      footballTextVisible = !footballTextVisible;

      // Update button appearance
      if (footballTextVisible) {
        footballTextToggle.style.background = '#444';
        footballTextToggle.textContent = 'HIDE TEXT';
      } else {
        footballTextToggle.style.background = '#c41e3a';
        footballTextToggle.textContent = 'SHOW TEXT';
      }

      await saveScoreboardState();
    });
  }

  // Flag button handler
  let flagVisible = false;
  const flagBtn = document.getElementById('flagBtn');
  if (flagBtn) {
    flagBtn.addEventListener('click', async () => {
      // Toggle flag visibility
      flagVisible = !flagVisible;

      // Update button appearance
      if (flagVisible) {
        flagBtn.style.background = '#ff4500';
        flagBtn.textContent = 'FLAG OFF';
      } else {
        flagBtn.style.background = '#ffd700';
        flagBtn.textContent = 'FLAG';
      }

      // Update state
      const currentState = await loadScoreboardState();
      currentState.flagVisible = flagVisible;
      currentState.triggerFlag = flagVisible ? Date.now() : null;
      localStorage.setItem('basketballScoreboard', JSON.stringify(currentState));

      // Save to server
      fetch('data.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(currentState)
      }).catch(console.error);
    });
  }

  // Volleyball set control event handlers
  if (setPrevBtn) {
    setPrevBtn.addEventListener('click', async () => {
      if (currentSet > 1) {
        currentSet--;
        setInput.value = currentSet;
        await saveScoreboardState();
      }
    });
  }

  if (setNextBtn) {
    setNextBtn.addEventListener('click', async () => {
      if (currentSet < 5) {
        currentSet++;
        setInput.value = currentSet;
        await saveScoreboardState();
      }
    });
  }

  if (setInput) {
    setInput.addEventListener('change', async () => {
      const val = parseInt(setInput.value, 10);
      if (!isNaN(val) && val >= 1 && val <= 5) {
        currentSet = val;
        await saveScoreboardState();
      } else {
        setInput.value = currentSet;
      }
    });
  }

  // Hotkey Management System
  let hotkeys = {};
  let currentRecordingInput = null;

  // Load hotkeys from localStorage
  function loadHotkeys() {
    const saved = localStorage.getItem('scoreboardHotkeys');
    if (saved) {
      try {
        hotkeys = JSON.parse(saved);
        // Apply saved hotkeys to inputs
        Object.keys(hotkeys).forEach(action => {
          const input = document.querySelector(`[data-action="${action}"]`);
          if (input) {
            input.value = hotkeys[action];
          }
        });
        
        // Register hotkeys with Electron after loading
        if (window.electronAPI && Object.keys(hotkeys).length > 0) {
          console.log('Registering loaded hotkeys with Electron:', hotkeys);
          window.electronAPI.registerAllHotkeys(hotkeys);
        }
      } catch (e) {
        console.warn('Failed to load hotkeys:', e);
        hotkeys = {};
      }
    }
  }

  // Save hotkeys to localStorage
  function saveHotkeys() {
    localStorage.setItem('scoreboardHotkeys', JSON.stringify(hotkeys));
  }

  // Convert key event to readable string
  function getKeyString(event) {
    const keys = [];
    if (event.ctrlKey) keys.push('Ctrl');
    if (event.altKey) keys.push('Alt');
    if (event.shiftKey) keys.push('Shift');
    if (event.metaKey) keys.push('Meta');

    // Don't include modifier keys themselves
    if (!['Control', 'Alt', 'Shift', 'Meta'].includes(event.key)) {
      keys.push(event.key.toUpperCase());
    }

    return keys.join(' + ');
  }

  // Check if key combination matches any hotkey
  function checkHotkey(event) {
    const keyString = getKeyString(event);
    const action = Object.keys(hotkeys).find(action => hotkeys[action] === keyString);

    if (action) {
      event.preventDefault();
      event.stopPropagation();
      executeHotkeyAction(action);
      return true;
    }
    return false;
  }

  // Execute the action associated with a hotkey
  function executeHotkeyAction(action) {
    // Try the exact action name first
    let element = document.getElementById(action);
    
    // If not found, try with "Btn" suffix (for actions like "scorebarIn" -> "scorebarInBtn")
    if (!element) {
      element = document.getElementById(action + 'Btn');
    }
    
    if (element && !element.disabled) {
      element.click();
      console.log(`Hotkey action executed: ${action} -> ${element.id}`);
    } else {
      console.warn(`No element found for hotkey action: ${action}`);
    }
  }

  // Set up hotkey input event listeners
  function initHotkeyInputs() {
    const hotkeyInputs = document.querySelectorAll('.hotkey-input');
    const clearButtons = document.querySelectorAll('.clear-hotkey');

    if (hotkeyInputs.length === 0) {
      console.error('No hotkey inputs found! Check if the DOM is ready or if the selector is correct.');
      return;
    }

    hotkeyInputs.forEach(input => {
      input.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        startRecording(input);
      });

      input.addEventListener('focus', (e) => {
        e.preventDefault();
        e.stopPropagation();
        startRecording(input);
      });
    });

    clearButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        const input = e.target.previousElementSibling;
        if (input && input.classList.contains('hotkey-input')) {
          const action = input.dataset.action;
          delete hotkeys[action];
          input.value = '';
          saveHotkeys();
        }
      });
    });
  }

  // Start recording a hotkey
  function startRecording(input) {
    // Stop any previous recording
    if (currentRecordingInput) {
      currentRecordingInput.classList.remove('recording');
      currentRecordingInput.value = hotkeys[currentRecordingInput.dataset.action] || '';
    }

    currentRecordingInput = input;
    input.classList.add('recording');
    input.value = 'Recording...';
    
    // Don't call blur() - we need to keep the element available for key capture
    // The readonly attribute will prevent typing
  }

  // Handle keydown for hotkey recording
  function handleHotkeyKeyDown(event) {
    // If we're recording a hotkey
    if (currentRecordingInput) {
      event.preventDefault();
      event.stopPropagation();

      // Don't record just modifier keys
      if (['Control', 'Alt', 'Shift', 'Meta'].includes(event.key)) {
        return;
      }

      const keyString = getKeyString(event);
      const action = currentRecordingInput.dataset.action;

      // Check if this hotkey is already assigned
      const existingAction = Object.keys(hotkeys).find(a => hotkeys[a] === keyString);
      if (existingAction && existingAction !== action) {
        showNotification(`This hotkey is already assigned to: ${existingAction}`, 'warning');
        currentRecordingInput.classList.remove('recording');
        currentRecordingInput.value = hotkeys[action] || '';
        currentRecordingInput = null;
        return;
      }

      // Save the hotkey
      hotkeys[action] = keyString;
      currentRecordingInput.value = keyString;
      currentRecordingInput.classList.remove('recording');
      currentRecordingInput = null;
      saveHotkeys();
    } else {
      // Check for existing hotkeys
      checkHotkey(event);
    }
  }

  // Global keydown event listener
  document.addEventListener('keydown', handleHotkeyKeyDown);

  // Update football hotkeys visibility based on sport
  function updateFootballHotkeysVisibility() {
    const footballSection = document.getElementById('footballHotkeysSection');
    if (footballSection) {
      footballSection.style.display = currentSport === 'football' ? 'block' : 'none';
    }
  }

  // Handle global hotkey triggers from Electron
  function setupElectronHotkeys() {
    console.log('Setting up Electron hotkeys...');
    
    // Guard against missing electronAPI
    if (!window.electronAPI) {
      console.warn('electronAPI not available, skipping Electron hotkey setup');
      return;
    }

    try {
      console.log('electronAPI available, setting up hotkey listeners');
      
      // Listen for global hotkey triggers
      window.electronAPI.onGlobalHotkeyTriggered((action) => {
        console.log('Global hotkey triggered:', action);
        executeHotkeyAction(action);
      });

      // Listen for hotkey mode changes (for fallback scenarios)
      if (window.electronAPI.onHotkeyMode) {
        window.electronAPI.onHotkeyMode((data) => {
          console.log('Hotkey mode notification:', data);
          if (data.mode === 'in-window') {
            console.log('Using in-window hotkeys as fallback');
            setupInWindowHotkeys();
          }
        });
      }

      // Register all current hotkeys with Electron immediately and after any changes
      const registerCurrentHotkeys = () => {
        if (Object.keys(hotkeys).length > 0) {
          console.log('Registering hotkeys with Electron:', hotkeys);
          window.electronAPI.registerAllHotkeys(hotkeys);
        } else {
          console.log('No hotkeys to register yet');
        }
      };

      // Register immediately
      registerCurrentHotkeys();

      // Also register when hotkeys are loaded from storage
      setTimeout(registerCurrentHotkeys, 100);
      
    } catch (error) {
      console.error('Error setting up Electron hotkeys:', error);
    }
  }

  // Set up in-window hotkey listeners (only for headless environment)
  function setupInWindowHotkeys() {
    console.log('Setting up in-window hotkeys for headless environment');
    
    // Remove existing listener if any
    document.removeEventListener('keydown', handleInWindowHotkey);
    
    // Add new listener
    document.addEventListener('keydown', handleInWindowHotkey);
  }

  // Handle in-window hotkey detection (only for headless environment)
  function handleInWindowHotkey(event) {
    // Only process if we're specifically told to use in-window mode (headless)
    const keyString = getKeyString(event);
    const action = Object.keys(hotkeys).find(action => hotkeys[action] === keyString);
    
    if (action) {
      console.log('In-window hotkey detected (headless mode):', keyString, '->', action);
      event.preventDefault();
      event.stopPropagation();
      executeHotkeyAction(action);
    }
  }

  // Override saveHotkeys to also register with Electron
  const originalSaveHotkeys = saveHotkeys;
  saveHotkeys = function() {
    originalSaveHotkeys();
    if (window.electronAPI) {
      console.log('Updating global hotkeys:', hotkeys);
      window.electronAPI.registerAllHotkeys(hotkeys);
    }
  };

  // Safe DOM helper - returns null instead of throwing errors
  const $ = (selector) => {
    try {
      return document.querySelector(selector);
    } catch (e) {
      console.warn('DOM query failed:', selector, e);
      return null;
    }
  };

  // Core initialization that must always work (hotkeys, status-circles)
  async function initCoreControls() {
    console.log('Initializing core controls...');
    try {
      // Always initialize sport selection and status handling
      checkSportSelection();
      updateStatusBar(); // Initialize status bar lights
      updateEditButtonStates(); // Initialize edit button states 
      setupStatusCircleClickHandlers(); // Initialize status circle click handlers

      // Always initialize hotkeys system
      loadHotkeys();
      initHotkeyInputs();
      setupElectronHotkeys();
      updateFootballHotkeysVisibility();
      
      console.log('Core controls initialized successfully');
    } catch (error) {
      console.error('Error initializing core controls:', error);
    }
  }

  // Feature initialization (optional UI elements)
  async function initFeatureControls() {
    console.log('Initializing feature controls...');
    try {
      // Only initialize features if their DOM elements exist
      if ($('#timeoutDisplays')) initTimeoutDisplays();
      if ($('.scorebar-controls')) updateScorebarButtons();
      if ($('.minibug-controls')) updateMiniBugButtons();
      if ($('.locator-controls')) updateLocatorButtons();
      if ($('.lower-third-controls')) updateLowerThirdButtons();
      if ($('.talent-controls')) updateTalentButtons();
      if ($('.left-slab-controls')) updateLeftSlabButtons();
      if ($('.tombstone-controls')) updateTombstoneButtons();
      if ($('.ticker-controls')) updateTickerButtons();

      // Load saved state (with protection for missing elements)
      await loadScoreboardStateIntoUI();
      
      // Broadcast initial state to graphics window via IPC (Electron only)
      if (isElectron) {
        console.log('[IPC DEBUG] isElectron:', isElectron, 'window.api:', !!window.api);
        if (window.api && window.api.send) {
          const initialState = await loadScoreboardState();
          console.log('[IPC] Initial state loaded:', initialState ? 'has data' : 'null/undefined', 'keys:', initialState ? Object.keys(initialState).length : 0);
          // Always broadcast, even if empty, so graphics window gets defaults
          console.log('[IPC] Broadcasting initial state to graphics window');
          window.api.send('scoreboard-state-update', initialState || {});
        } else {
          console.log('[IPC DEBUG] window.api.send not available');
        }
      }
      
      console.log('Feature controls initialized successfully');
    } catch (error) {
      console.error('Error initializing feature controls:', error);
      // Don't let feature errors break core functionality
    }
  }

  // Main initialization function
  async function initAll() {
    console.log('Starting application initialization...');
    try {
      // Always run core controls first
      await initCoreControls();
      
      // Then run optional feature controls
      await initFeatureControls();
      
      console.log('Application initialization complete');
    } catch (error) {
      console.error('Fatal error during initialization:', error);
    }
  }

  // Add global error handling
  window.addEventListener('error', (event) => {
    console.error('Global JavaScript error:', event.error, 'at', event.filename, ':', event.lineno);
  });

  window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
  });


  // Ensure DOM is ready before initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    // DOM is already ready
    initAll();
  }

  // Sport selection check is now handled in initAll()

  // Preview Modal functionality
  const previewOverlay = document.getElementById('previewOverlay');
  const previewTitle = document.getElementById('previewTitle');
  const previewContent = document.getElementById('previewContent');
  const previewCloseBtn = document.getElementById('previewCloseBtn');

  function showPreview(graphicType) {
    // Set the title
    previewTitle.textContent = `${graphicType.charAt(0).toUpperCase() + graphicType.slice(1)} Preview`;

    // Save current state and create preview state
    savePreviewState(graphicType).then(() => {
      // Create iframe pointing to Graphics_output.html with preview parameter
      const iframe = document.createElement('iframe');
      iframe.src = `Graphics_output.html?preview=${graphicType}&t=${Date.now()}`;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      iframe.style.background = '#111';

      // Clear previous content and add iframe
      previewContent.innerHTML = '';
      previewContent.appendChild(iframe);

      // Show the modal
      previewOverlay.classList.add('show');
    });
  }

  async function savePreviewState(graphicType) {
    // Get current state
    const currentState = await loadScoreboardState();

    // Create preview state with the specific graphic visible and others hidden
    const previewState = {
      ...currentState,
      scorebarVisible: graphicType === 'scorebar',
      miniBugVisible: graphicType === 'minibug',
      locatorVisible: graphicType === 'locator',
      lowerThirdVisible: graphicType === 'lowerthird',
      talentVisible: graphicType === 'talent',
      leftSlabVisible: graphicType === 'leftslab',
      tombstoneVisible: graphicType === 'tombstone', // Add tombstone visibility
      isPreview: true,
      previewType: graphicType
    };

    // Only save preview state to localStorage with a special key
    // DO NOT save to server to avoid affecting live output
    localStorage.setItem('basketballScoreboardPreview', JSON.stringify(previewState));
  }

  function hidePreview() {
    previewOverlay.classList.remove('show');
    // Clear content when hiding
    previewContent.innerHTML = '';

    // Restore original state after preview
    restoreOriginalState();
  }

  async function restoreOriginalState() {
    // Remove preview state from localStorage
    localStorage.removeItem('basketballScoreboardPreview');

    // Save the current non-preview state back to server
    await saveScoreboardState();
  }

  // Preview button event listeners
  document.getElementById('scorebarPreviewBtn').addEventListener('click', () => {
    showPreview('scorebar');
  });

  document.getElementById('miniBugPreviewBtn').addEventListener('click', () => {
    showPreview('minibug');
  });

  document.getElementById('statsPanelPreviewBtn').addEventListener('click', () => {
    showPreview('locator');
  });

  document.getElementById('lowerThirdPreviewBtn').addEventListener('click', () => {
    showPreview('lowerthird');
  });

  document.getElementById('tickerPreviewBtn').addEventListener('click', () => {
    showPreview('tombstone');
  });

  document.getElementById('talentPreviewBtn').addEventListener('click', () => {
    showPreview('talent');
  });

  document.getElementById('leftSlabPreviewBtn').addEventListener('click', () => {
    showPreview('leftslab');
  });

  // Close preview modal
  previewCloseBtn.addEventListener('click', hidePreview);

  // Close modal when clicking outside of it
  previewOverlay.addEventListener('click', (e) => {
    if (e.target === previewOverlay) {
      hidePreview();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && previewOverlay.classList.contains('show')) {
      hidePreview();
    }
  });

  // ---------- misc helpers to keep UI responsive ----------

  // When local scoreboard changes (from other tab), refresh UI
  window.addEventListener('storage', (e) => {
    if (e.key === 'basketballScoreboard') {
      loadScoreboardStateIntoUI();
    }
  });

  // Sanity: ensure scoreboard state saved when page unloads
  window.addEventListener('beforeunload', () => {
    saveScoreboardState().catch(console.error);
  });
</script>
</body>
</html>
